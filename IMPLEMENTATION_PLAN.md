# خطة التنفيذ التفصيلية - تحسينات نظام الإيرادات

## المرحلة الأولى: تحليل الحالة الحالية

### الخطوة 1.1: فهم البنية الحالية
- ✅ جدول `dailyRevenues` الحالي يحتوي على: `balanceImageUrl` و `balanceImageKey`
- ✅ الواجهة الحالية تستخدم `balanceImage` (صورة واحدة)
- ✅ السجل الشهري يعرض `balanceImageUrl`

### الخطوة 1.2: المتطلبات الجديدة
1. صور متعددة بدلاً من صورة واحدة
2. الرصيد يساوي الشبكة تلقائياً (غير محسوب في الإجمالي)
3. المطابقة تلقائية بدون زر
4. سبب إجباري عند عدم التطابق
5. منع تسجيل أكثر من إيراد لنفس اليوم
6. صورة الموازنة إجبارية مع التحقق من التاريخ والمبلغ

---

## المرحلة الثانية: تحديث قاعدة البيانات

### الخطوة 2.1: تحديث schema.ts
- حذف: `balanceImageUrl` و `balanceImageKey`
- إضافة: `balanceImages` (JSON array)
- إضافة: `imageVerificationNote` (string nullable)
- إضافة: `isMatched` (boolean)
- إضافة: `unmatchReason` (string nullable)

### الخطوة 2.2: تشغيل migration
```bash
pnpm db:push
```

---

## المرحلة الثالثة: تحديث API (server/routers.ts)

### الخطوة 3.1: تحديث input schema
- استبدال `balanceImageUrl` و `balanceImageKey` بـ `balanceImages`
- إضافة `imageVerificationNote`
- إضافة منطق التحقق من عدم التكرار

### الخطوة 3.2: تحديث createDaily procedure
- التحقق من عدم وجود إيراد لنفس اليوم والفرع
- حساب الرصيد تلقائياً = الشبكة
- حساب الإجمالي = الكاش + الشبكة (بدون الرصيد)
- المطابقة التلقائية: إيرادات الموظفين = الكاش + الشبكة
- إذا لم تطابق → طلب مبرر من المستخدم

---

## المرحلة الرابعة: تحديث الواجهة (client/src/pages/Revenues.tsx)

### الخطوة 4.1: تحديث state
- استبدال `balanceImage` بـ `balanceImages` (array)
- إضافة `imageVerificationNote`
- إضافة `isMatched` و `unmatchReason`

### الخطوة 4.2: تحديث دوال رفع الصور
- `handleImageSelect`: دعم صور متعددة
- `removeImage(idx)`: حذف صورة محددة
- التحقق من الصور قبل الحفظ

### الخطوة 4.3: تحديث دالة الحفظ
- التحقق من وجود صور
- إرسال `balanceImages` بدلاً من `balanceImageUrl`
- معالجة `imageVerificationNote` إذا كانت المطابقة فاشلة

### الخطوة 4.4: تحديث السجل الشهري
- عرض عدد الصور
- عرض حالة المطابقة (أخضر/أحمر)
- عرض السبب عند عدم التطابق

---

## المرحلة الخامسة: الاختبار والتحقق

### الخطوة 5.1: اختبار الأخطاء
```bash
npx tsc --noEmit
```

### الخطوة 5.2: اختبار الوظائف
- رفع صورة واحدة
- رفع صور متعددة
- حذف صورة
- التحقق من المطابقة
- منع التكرار

### الخطوة 5.3: حفظ checkpoint

---

## ملاحظات مهمة

1. **الترتيب مهم جداً:** يجب البدء بـ schema ثم API ثم الواجهة
2. **عدم الخلط:** عدم تعديل ملفات متعددة في نفس الوقت
3. **الاختبار المستمر:** التحقق من عدم وجود أخطاء TypeScript بعد كل خطوة
4. **الالتزام بالخطة:** عدم الانحراف عن الخطوات المحددة

---

## التقدم

- [ ] المرحلة الأولى: تحليل الحالة الحالية
- [ ] المرحلة الثانية: تحديث قاعدة البيانات
- [ ] المرحلة الثالثة: تحديث API
- [ ] المرحلة الرابعة: تحديث الواجهة
- [ ] المرحلة الخامسة: الاختبار والتحقق
