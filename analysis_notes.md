# تحليل صورة الجرد الفعلي

## ما أراه في الصورة:
1. صفحة الجرد الفعلي على الموبايل
2. رقم الجرد: CNT-2025-0001
3. الحالة: "جاري"
4. التقدم: 1/32 (3%)
5. الإحصائيات:
   - إجمالي المنتجات: 32
   - تم جردها: 1
   - في الانتظار: 31
   - فروقات: 32

## المشكلة الواضحة:
- **لا يوجد زر "جرد" أو "تعديل" في الجدول!**
- الجدول يعرض فقط: المنتج، الكمية النظرية، الكمية الفعلية، الفرق
- **لا يوجد عمود "الحالة" ولا عمود "الإجراء"**

## السبب:
- على شاشة الموبايل الصغيرة، الأعمدة الأخيرة (الحالة والإجراء) مخفية أو مقطوعة
- التصميم غير متجاوب (not responsive) مع الشاشات الصغيرة

## الحل المطلوب:
1. جعل الجدول قابل للتمرير أفقياً
2. أو إعادة تصميم الواجهة للموبايل بشكل مختلف (cards بدلاً من جدول)
3. إضافة زر جرد مباشر في كل صف


---

# ملاحظات فحص لوحة التحكم التنفيذية (30 ديسمبر 2025)

## البيانات الحالية المعروضة:
- إجمالي الإيرادات: 55,300 ر.س
- صافي الربح: 54,246 ر.س
- إجمالي المصاريف: 1,054 ر.س (8 مصروف)
- هامش الربح: 98.1%
- متوسط يومي: 5,530 ر.س
- إجمالي النقدي: 5,570 ر.س (10.1%)
- إجمالي الشبكة: 49,730 ر.س (89.9%)
- إجمالي الرصيد: 49,720 ر.س
- 10 يوم عمل مسجل

## المشاكل المحتملة:
1. إجمالي الرصيد (49,720) يساوي تقريباً إجمالي الشبكة (49,730) - قد يكون هناك خلط
2. "النظام" يظهر كموظف مع إيرادات عالية (23,330 و 16,065) - هذا غير صحيح
3. نسبة التغيير +100% تظهر لجميع المؤشرات - قد يكون بسبب عدم وجود بيانات للفترة السابقة

## المطلوب:
1. إصلاح عرض "النظام" كموظف
2. التحقق من حساب إجمالي الرصيد
3. تحسين تصدير PDF مع الختم والتوقيعات


---

# ملاحظات فحص لوحة المبيعات (30 ديسمبر 2025)

## البيانات المعروضة:
- إجمالي الإيرادات: 55,300 ر.س (+100%)
- صافي الربح: 54,246 ر.س (+100%)
- متوسط الإيراد اليومي: 5,530 ر.س (من 10 يوم عمل)
- أفضل يوم مبيعات: 39,395 ر.س (الثلاثاء، 10 رجب)
- إجمالي النقدي: 5,570 ر.س (10.1%)
- إجمالي الشبكة: 49,730 ر.س (89.9%)
- إجمالي الرصيد: 49,720 ر.س
- هامش الربح: 98.1%

## المشاكل المكتشفة:
1. **"النظام" يظهر كموظف** - المركز الأول والثاني في أداء الموظفين يظهر "النظام" و "النظم" بدلاً من موظفين حقيقيين
2. **إجمالي الرصيد غير صحيح** - يظهر 49,720 وهو قريب جداً من إجمالي الشبكة (49,730)
3. **نسبة +100%** - تظهر لجميع المؤشرات بسبب عدم وجود بيانات للفترة السابقة

## الإصلاحات المطلوبة:
1. استبعاد "النظام" من قائمة أداء الموظفين
2. التحقق من حساب إجمالي الرصيد (balance)
3. تحسين عرض نسبة التغيير عند عدم وجود بيانات سابقة


---

# تحليل التناقض في صفحة تحليلات AI (6 يناير 2026)

## البيانات الحالية (بعد التعديل):

### ملخص التحليل الذكي:
- صافي الربح: سالب 15,972 ريال
- هامش الربح: سالب 53.8%
- إجمالي الإيرادات: 29,663 ريال
- إجمالي المصاريف: 11,288.75 ريال (مسجلة فقط)
- نسبة التشغيل: 153.8%

### المشكلة:
التحليل الذكي يحسب صافي الربح = الإيرادات - (التكاليف الثابتة + تكلفة البضاعة + المصاريف المسجلة)
هذا يؤدي إلى تكرار التكاليف!

### السبب:
- التكاليف الثابتة (32,200 ر.س) تشمل: رواتب، إيجار، كهرباء، إنترنت
- المصاريف المسجلة (11,288.75 ر.س) قد تشمل بعض هذه التكاليف أيضاً
- النتيجة: تكرار في الحساب

### الحل المطلوب:
1. استخدام التكاليف الثابتة فقط (بدون المصاريف المسجلة) للتحليل
2. أو استخدام المصاريف المسجلة فقط إذا كانت تشمل كل شيء
3. أو فصل المصاريف المسجلة إلى: ثابتة ومتغيرة

### الحساب الصحيح:
- إيرادات: 29,663
- تكاليف ثابتة: 32,200 (شهرياً)
- تكلفة بضاعة (1%): 296.63
- صافي الربح: 29,663 - 32,200 - 296.63 = -2,833.63 ريال

هذا أقرب للواقع من -15,972 ريال


---

# تحليل أخطاء حساب الرواتب (29 يناير 2026)

## البيانات من الشاشة (مسيرة يناير 2026 - فرع لبن)

### الموظفين:
1. **السيد محمد** (EMP-007): راتب أساسي 3,000 - إضافي 15,000 - أيام العمل 30
2. **عبدالحي جلال** (EMP-004): راتب أساسي 1,000 - إضافي 4,000 - أيام العمل 30
3. **علاء ناصر** (EMP-002): راتب أساسي 3,000 - إضافي 3,000 - أيام العمل 30
4. **محمود عماره** (EMP-012): راتب أساسي 3,000 - إضافي 3,000 - أيام العمل 30

### الإجماليات:
- إجمالي الأساسي: 8,000 ر.س
- إجمالي الإضافي: 4,000 ر.س
- إجمالي الخصومات: 277.67 ر.س

## المشاكل المُبلَّغ عنها:

### مشكلة السيد:
- فاتورة سالبة: -55 ر.س
- راتب إجمالي: 3,150 ر.س
- الناتج الظاهر: 3,040 ر.س
- الناتج الصحيح: 3,095 ر.س (3150 - 55 = 3095)
- **الفرق**: 55 ر.س (يبدو أن الفاتورة السالبة تُطرح مرتين أو هناك خصم إضافي)

### مشكلة علاء:
- خصم يوم إجازة بدون راتب مع ساعات إضافية
- الخصم الظاهر: 66.67 ر.س
- الخصم الصحيح: 100 ر.س (مع ساعات إضافية: (2000+1000)/30 = 100)
- **السبب**: يبدو أن الكود لا يأخذ الساعات الإضافية في الاعتبار عند حساب خصم الإجازة

## التحليل الفني:

### 1. مشكلة الفواتير السالبة:
- في `calculateSalary` (سطر 265): `totalDeductions = data.deductionAmount + data.advanceDeduction + absentDeduction + negativeInvoicesDeduction + unpaidLeaveDeduction`
- في التهيئة (سطر 204): `totalDeductions = advanceDeduction + negativeInvoicesDeduction + unpaidLeaveDeduction`
- **المشكلة**: الفواتير السالبة تُضاف للخصومات بشكل صحيح، لكن يجب التحقق من القيمة المُرسلة من API

### 2. مشكلة خصم الإجازة:
- في التهيئة (سطر 186): `dailySalary = baseSalary / 30` (بدون ساعات إضافية)
- في `calculateSalary` (سطر 238): `dailyRate = (data.baseSalary + overtime) / 30` (مع ساعات إضافية)
- **المشكلة**: عند التهيئة الأولى، لا يتم أخذ الساعات الإضافية في الاعتبار لأن `overtimeEnabled = false` افتراضياً


---

# الإصلاحات المطبقة (29 يناير 2026)

## الإصلاح الأول: خصم الإجازة مع الساعات الإضافية

### المشكلة:
- عند التهيئة الأولية، كان يُحسب خصم الإجازة بناءً على الراتب الأساسي فقط (2000/30 = 66.67)
- لكن الموظف قد يكون لديه ساعات إضافية مفعلة في إعداداته

### الحل:
1. جلب إعدادات الرواتب من قاعدة البيانات (`salarySettings.list`)
2. استخدام `overtimeEnabled` المحفوظة للموظف
3. حساب خصم الإجازة بناءً على (الراتب الأساسي + الساعات الإضافية) / 30

### الكود المُعدَّل:
```typescript
// جلب إعدادات الراتب للموظف من قاعدة البيانات
const empSettings = salarySettings?.find(s => s.employeeId === emp.id);
const baseSalary = empSettings?.baseSalary ? parseFloat(empSettings.baseSalary) : BASE_SALARY;
const overtimeEnabled = empSettings?.overtimeEnabled || false;
const overtimeAmount = overtimeEnabled ? OVERTIME_AMOUNT : 0;

// حساب خصم الإجازة مع الساعات الإضافية
const dailySalary = (baseSalary + overtimeAmount) / 30;
```

## الإصلاح الثاني: تكرار خصم الفواتير السالبة

### المشكلة:
- في دالة `createPayroll` بـ db.ts، كان يُضاف خصم الفواتير السالبة مرتين:
  1. مرة في `d.totalDeductions` (من الواجهة)
  2. مرة أخرى في `negativeInvoicesDeduction` (من قاعدة البيانات)

### الحل:
- استخدام قيمة الفواتير السالبة المُرسلة من الواجهة فقط
- عدم إعادة حسابها في السيرفر

### الكود المُعدَّل:
```typescript
// الفواتير السالبة موجودة بالفعل في d.negativeInvoicesDeduction من الواجهة
let negativeInvoicesDeduction = parseFloat(d.negativeInvoicesDeduction) || 0;

// إضافة خصم الإجازة فقط (الفواتير السالبة موجودة بالفعل في currentTotalDeductions)
const newTotalDeductions = currentTotalDeductions + leaveDeduction;
const newNetSalary = currentNetSalary - leaveDeduction;
```

## الاختبارات:
- تم كتابة 10 اختبارات في `server/payroll-calculations.test.ts`
- جميع الاختبارات نجحت ✅

## النتيجة المتوقعة:
- **السيد**: 3150 - 55 = 3095 ر.س (بدلاً من 3040)
- **علاء**: خصم يوم = (2000 + 1000) / 30 = 100 ر.س (بدلاً من 66.67)
