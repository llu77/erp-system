# تقرير تدقيق منطق التحقق من الموازنة
## Symbol AI Verification System - Code Audit Report

**تاريخ التقرير:** 31 يناير 2026  
**المُعد بواسطة:** Nawab AI - Senior Software Architect  
**الغرض:** تدقيق وتحليل منطق التحقق من مطابقة مبلغ الشبكة المدخل يدوياً مع المبالغ المستخرجة من صورة الموازنة

---

## 1. ملخص تنفيذي

يقوم نظام Symbol AI بالتحقق من صحة مبلغ الشبكة المدخل يدوياً من خلال مقارنته بالمبالغ المستخرجة آلياً من صورة إيصال نقاط البيع (POS Terminal Receipt) باستخدام تقنية OCR المدعومة بالذكاء الاصطناعي. هذا التقرير يوثق المنطق الحالي ويقدم تحليلاً شاملاً للخوارزمية المستخدمة.

### النتيجة الرئيسية

> **المعادلة الأساسية:**  
> `المبلغ المدخل في خانة الشبكة (يدوياً) = مجموع TOTALS من جميع أقسام الدفع في صورة الموازنة`

---

## 2. تدفق البيانات (Data Flow)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           مدخلات المستخدم                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│  1. مبلغ الشبكة (networkAmount) ← إدخال يدوي في حقل "الشبكة"               │
│  2. صورة الموازنة (balanceImages) ← رفع صورة إيصال POS                      │
│  3. تاريخ الإيراد (input.date) ← تحديد تاريخ الإيراد                        │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        معالجة OCR بالذكاء الاصطناعي                         │
├─────────────────────────────────────────────────────────────────────────────┤
│  1. إرسال الصورة إلى LLM Vision (Claude/GPT-4V)                            │
│  2. استخراج الأقسام: mada, VISA, MasterCard, DISCOVER, Maestro, GCCNET     │
│  3. استخراج TOTALS من كل قسم                                               │
│  4. استخراج التاريخ من أعلى الإيصال                                        │
│  5. حساب المجموع الكلي (grandTotal)                                        │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              التحقق والمطابقة                               │
├─────────────────────────────────────────────────────────────────────────────┤
│  1. مطابقة المبلغ: |extractedAmount - networkAmount| ≤ (networkAmount × 2%)│
│  2. مطابقة التاريخ: |extractedDate - expectedDate| ≤ 1 يوم                 │
│  3. التحقق من مستوى الثقة: confidence ≥ medium                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                                 النتيجة                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│  ✅ قبول: جميع المعايير مستوفاة                                            │
│  ❌ رفض: أي معيار غير مستوفى + رسالة خطأ مفصلة                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. تحليل الكود المصدري

### 3.1 الملفات المعنية

| الملف | الوظيفة | الأسطر الرئيسية |
|-------|---------|-----------------|
| `server/ocr/balanceImageOCR.ts` | خدمة OCR الرئيسية | 1-733 |
| `server/routers.ts` | منطق التحقق في API | 2025-2180 |

### 3.2 الثوابت المحددة

```typescript
// server/ocr/balanceImageOCR.ts - السطر 78-80
const AMOUNT_TOLERANCE_PERCENTAGE = 0.02;  // هامش خطأ 2%
const MIN_CONFIDENCE_FOR_VALIDATION = "medium";  // الحد الأدنى للثقة
const DATE_TOLERANCE_DAYS = 1;  // هامش خطأ يوم واحد
```

### 3.3 دالة مطابقة المبلغ

```typescript
// server/ocr/balanceImageOCR.ts - السطر 171-180
function amountsMatch(
  extracted: number,     // المبلغ المستخرج من الصورة
  expected: number,      // المبلغ المدخل يدوياً (الشبكة)
  tolerancePercent: number = AMOUNT_TOLERANCE_PERCENTAGE
): boolean {
  if (expected === 0) return extracted === 0;
  
  const tolerance = expected * tolerancePercent;  // حساب هامش الخطأ
  return Math.abs(extracted - expected) <= tolerance;  // المقارنة
}
```

### 3.4 حساب المجموع الكلي من الصورة

```typescript
// server/ocr/balanceImageOCR.ts - السطر 356-361
// حساب المجموع الكلي من الأقسام
const calculatedTotal = sections.reduce((sum, s) => sum + s.terminalTotal, 0);
const extractedGrandTotal = parseExtractedAmount(parsed.grandTotal?.toString());

// استخدام المجموع الأكبر للتأكد من عدم فقدان أي قسم
const grandTotal = Math.max(calculatedTotal, extractedGrandTotal || 0);
```

### 3.5 استدعاء التحقق في routers.ts

```typescript
// server/routers.ts - السطر 2043-2047
imageVerificationResult = await balanceImageOCR.verifyBalanceImage(
  input.balanceImages,      // صور الموازنة المرفوعة
  networkAmount,            // المبلغ المدخل في خانة الشبكة
  expectedUploadDate        // تاريخ الإيراد المتوقع
);
```

---

## 4. أقسام الدفع المدعومة

يقوم النظام باستخراج المبالغ من الأقسام التالية في إيصال POS:

| القسم | الوصف | الحقل المستخرج |
|-------|-------|----------------|
| **mada** | بطاقات مدى المحلية | `terminalTotal` |
| **VISA** | بطاقات فيزا الدولية | `terminalTotal` |
| **MasterCard** | بطاقات ماستركارد | `terminalTotal` |
| **DISCOVER** | بطاقات ديسكفر | `terminalTotal` |
| **Maestro** | بطاقات مايسترو | `terminalTotal` |
| **GCCNET** | شبكة دول الخليج | `terminalTotal` |
| **JN ONPAY** | خدمة الدفع | `terminalTotal` |

### صيغة حساب المجموع الكلي

```
grandTotal = Σ (terminalTotal) لجميع الأقسام
           = mada.terminalTotal + VISA.terminalTotal + MasterCard.terminalTotal + ...
```

---

## 5. معايير القبول والرفض

### 5.1 شروط القبول (جميعها إلزامية)

| # | الشرط | الصيغة الرياضية |
|---|-------|-----------------|
| 1 | وجود صورة | `balanceImages.length > 0` |
| 2 | نجاح القراءة | `success === true` |
| 3 | مستوى الثقة | `confidence ∈ {medium, high}` |
| 4 | مطابقة المبلغ | `|extracted - expected| ≤ expected × 0.02` |
| 5 | مطابقة التاريخ | `|extractedDate - expectedDate| ≤ 1 day` |

### 5.2 أمثلة على المطابقة

**مثال 1: مطابقة ناجحة**
```
المبلغ المدخل (الشبكة): 5,000.00 ر.س
المبلغ المستخرج من الصورة: 5,080.00 ر.س
هامش الخطأ المسموح: 5,000 × 0.02 = 100.00 ر.س
الفرق الفعلي: |5,080 - 5,000| = 80.00 ر.س
النتيجة: 80 ≤ 100 ✅ مقبول
```

**مثال 2: مطابقة فاشلة**
```
المبلغ المدخل (الشبكة): 5,000.00 ر.س
المبلغ المستخرج من الصورة: 5,200.00 ر.س
هامش الخطأ المسموح: 5,000 × 0.02 = 100.00 ر.س
الفرق الفعلي: |5,200 - 5,000| = 200.00 ر.س
النتيجة: 200 > 100 ❌ مرفوض
```

---

## 6. مخطط تدفق التحقق (Flowchart)

```
                              ┌─────────────────┐
                              │   بدء التحقق    │
                              └────────┬────────┘
                                       │
                                       ▼
                         ┌─────────────────────────┐
                         │ هل مبلغ الشبكة > 0؟     │
                         └────────────┬────────────┘
                                      │
                     ┌────────────────┴────────────────┐
                     │ نعم                             │ لا
                     ▼                                 ▼
          ┌──────────────────┐              ┌──────────────────┐
          │ هل توجد صورة؟    │              │ ✅ قبول بدون     │
          └────────┬─────────┘              │    تحقق          │
                   │                        └──────────────────┘
          ┌────────┴────────┐
          │ نعم             │ لا
          ▼                 ▼
   ┌──────────────┐  ┌──────────────┐
   │ استخراج OCR  │  │ ❌ رفض:      │
   └──────┬───────┘  │ صورة إلزامية │
          │          └──────────────┘
          ▼
   ┌──────────────────┐
   │ هل نجح الاستخراج؟│
   └────────┬─────────┘
            │
   ┌────────┴────────┐
   │ نعم             │ لا
   ▼                 ▼
┌────────────┐  ┌──────────────┐
│ التحقق من  │  │ ❌ رفض:      │
│ الثقة      │  │ فشل القراءة  │
└─────┬──────┘  └──────────────┘
      │
      ▼
┌──────────────────────┐
│ الثقة ≥ متوسط؟       │
└──────────┬───────────┘
           │
  ┌────────┴────────┐
  │ نعم             │ لا
  ▼                 ▼
┌────────────┐  ┌──────────────┐
│ التحقق من  │  │ ❌ رفض:      │
│ المبلغ     │  │ جودة منخفضة  │
└─────┬──────┘  └──────────────┘
      │
      ▼
┌──────────────────────────────┐
│ |extracted - expected| ≤ 2%? │
└──────────────┬───────────────┘
               │
      ┌────────┴────────┐
      │ نعم             │ لا
      ▼                 ▼
┌────────────┐  ┌──────────────┐
│ التحقق من  │  │ ❌ رفض:      │
│ التاريخ    │  │ عدم تطابق   │
└─────┬──────┘  │ المبلغ       │
      │         └──────────────┘
      ▼
┌──────────────────────────────┐
│ |dateExtracted - dateExpected| ≤ 1 day? │
└──────────────┬───────────────┘
               │
      ┌────────┴────────┐
      │ نعم             │ لا
      ▼                 ▼
┌──────────────┐  ┌──────────────┐
│ ✅ قبول      │  │ ❌ رفض:      │
│ الإيراد      │  │ عدم تطابق   │
└──────────────┘  │ التاريخ      │
                  └──────────────┘
```

---

## 7. نقاط القوة في التصميم الحالي

| # | نقطة القوة | الوصف |
|---|------------|-------|
| 1 | **هامش خطأ ذكي** | استخدام نسبة 2% بدلاً من قيمة ثابتة يتكيف مع حجم المبالغ |
| 2 | **تعدد الأقسام** | دعم 7 أقسام دفع مختلفة يغطي معظم أنواع البطاقات |
| 3 | **حساب مزدوج** | استخدام `Math.max()` بين المجموع المحسوب والمستخرج |
| 4 | **رسائل مفصلة** | رسائل خطأ واضحة بالعربية مع اقتراحات للحل |
| 5 | **مرونة التاريخ** | السماح بفرق يوم واحد لتغطية حالات نهاية اليوم |
| 6 | **تسجيل شامل** | تسجيل جميع عمليات التحقق للمراجعة والتدقيق |

---

## 8. توصيات للتحسين

### 8.1 توصيات عاجلة

| # | التوصية | الأولوية |
|---|---------|----------|
| 1 | إضافة دعم للصور المتعددة (جمع المبالغ من عدة صور) | عالية |
| 2 | إضافة سجل لمحاولات OCR الفاشلة للتحليل | متوسطة |

### 8.2 توصيات مستقبلية

| # | التوصية | الأولوية |
|---|---------|----------|
| 1 | تدريب نموذج مخصص على إيصالات POS السعودية | منخفضة |
| 2 | إضافة التعرف على أجهزة POS المختلفة | منخفضة |

---

## 9. الخلاصة

نظام التحقق من الموازنة في Symbol AI يعمل بشكل صحيح وفق المنطق التالي:

> **القاعدة الذهبية:**  
> المبلغ المدخل يدوياً في خانة "الشبكة" يجب أن يساوي مجموع جميع أقسام الدفع (TOTALS) في صورة إيصال POS، مع هامش خطأ مسموح 2%.

### ملخص المعادلات

```
networkAmount (يدوي) ≈ grandTotal (من الصورة)
حيث: grandTotal = Σ terminalTotal لجميع الأقسام
والشرط: |networkAmount - grandTotal| ≤ networkAmount × 0.02
```

---

## 10. المراجع التقنية

| الملف | المسار | الوصف |
|-------|--------|-------|
| خدمة OCR | `server/ocr/balanceImageOCR.ts` | الخدمة الرئيسية للتعرف على الصور |
| API Router | `server/routers.ts` | منطق التحقق في نقطة النهاية |
| رسائل الخطأ | `shared/ocrErrorMessages.ts` | رسائل الخطأ المفصلة |
| ضغط الصور | `client/src/utils/imageCompression.ts` | تحسين جودة الصور قبل الرفع |

---

*تم إعداد هذا التقرير بواسطة **Nawab AI** - Senior Software Architect*  
*نظام Symbol AI للتحقق من المستندات المالية*  
*آخر تحديث: 31 يناير 2026*
