# تقرير تحليل نظام تطابق الإيرادات والبونص

## ملخص التحليل

تم إجراء مراجعة شاملة لنظام تطابق الإيرادات والبونص للموظفين. النظام يعمل بشكل صحيح مع بعض الملاحظات.

---

## 1. بنية البيانات

### الجداول الرئيسية

| الجدول | الوظيفة | الحقول الرئيسية |
|--------|---------|-----------------|
| `employeeRevenues` | إيرادات الموظفين اليومية | employeeId, dailyRevenueId, cash, network, total |
| `dailyRevenues` | الإيرادات اليومية للفرع | branchId, date, balance |
| `weeklyBonuses` | البونص الأسبوعي | branchId, weekNumber, month, year, totalAmount, status |
| `bonusDetails` | تفاصيل بونص كل موظف | weeklyBonusId, employeeId, weeklyRevenue, bonusAmount, bonusTier |

### العلاقات
- `employeeRevenues` ← `dailyRevenues` (عبر dailyRevenueId)
- `bonusDetails` ← `weeklyBonuses` (عبر weeklyBonusId)
- كلاهما مرتبط بـ `employees` (عبر employeeId)

---

## 2. آلية حساب الفروقات

### الدالة الرئيسية: `detectBonusDiscrepancies()`

```typescript
// الخطوات:
1. جلب سجل البونص الأسبوعي للفرع والأسبوع المحدد
2. جلب تفاصيل البونص المسجلة (weeklyRevenue, bonusAmount)
3. حساب تواريخ الأسبوع (weekStart, weekEnd)
4. جلب الإيرادات الفعلية من employeeRevenues
5. مقارنة كل موظف: الإيراد المسجل vs الإيراد الفعلي
6. حساب البونص المتوقع بناءً على الإيراد الفعلي
7. تحديد الفروقات (فرق > 1 ر.س في الإيراد و > 0.5 ر.س في البونص)
```

### حدود الكشف عن الفروقات
- **فرق الإيراد**: > 1 ر.س
- **فرق البونص**: > 0.5 ر.س
- يجب تحقق **كلا الشرطين** للإبلاغ عن فرق

---

## 3. مستويات البونص

| المستوى | الحد الأدنى | الحد الأقصى | مبلغ البونص |
|---------|-------------|-------------|-------------|
| tier_5 | 2,400 ر.س | - | 180 ر.س |
| tier_4 | 2,100 ر.س | 2,399 ر.س | 135 ر.س |
| tier_3 | 1,800 ر.س | 2,099 ر.س | 95 ر.س |
| tier_2 | 1,500 ر.س | 1,799 ر.س | 60 ر.س |
| tier_1 | 1,200 ر.س | 1,499 ر.س | 35 ر.س |
| none | 0 ر.س | 1,199 ر.س | 0 ر.س |

---

## 4. نتائج الفحص الحالي

### الأسبوع 1 - يناير 2026

**الإحصائيات:**
- إجمالي الفروقات: **1**
- فروع بها فروقات: **1** (طويق - الرياض)
- فروع متطابقة: **0**
- إجمالي الفرق: **35 ر.س**

**الحالة:** يحتاج مراجعة ⚠️

### تفاصيل البونص المسجل

| الموظف | الكود | الإيراد الأسبوعي | المستوى | البونص |
|--------|-------|------------------|---------|--------|
| علاء ناصر | EMP-002 | 1,675.00 ر.س | المستوى 2 | 60.00 ر.س |
| عبدالحي جلال | EMP-004 | 1,558.00 ر.س | المستوى 2 | 60.00 ر.س |
| السيد محمد | EMP-007 | 1,315.00 ر.س | المستوى 1 | 35.00 ر.س |
| محمود عماره | EMP-012 | 1,460.00 ر.س | المستوى 1 | 35.00 ر.س |
| (غير مؤهل) | - | 0.00 ر.س | غير مؤهل | 0.00 ر.س |

**الإجمالي:** 190.00 ر.س | **نسبة الأهلية:** 80% | **عدد المؤهلين:** 4 من 5

---

## 5. تحليل دقة النظام

### نقاط القوة ✅

1. **آلية المقارنة صحيحة**: النظام يقارن الإيرادات الفعلية من `employeeRevenues` مع المسجلة في `bonusDetails`
2. **حساب الأسبوع دقيق**: يستخدم تواريخ محددة (weekStart, weekEnd)
3. **كشف الموظفين غير المسجلين**: يكشف الموظفين الذين لديهم إيرادات لكن غير مسجلين في البونص
4. **حدود معقولة**: حد الفرق (1 ر.س للإيراد، 0.5 ر.س للبونص) يتجنب الإنذارات الكاذبة
5. **واجهة واضحة**: عرض الفروقات بشكل مرئي مع رسم بياني

### نقاط تحتاج مراجعة ⚠️

1. **حساب تواريخ الأسبوع**:
   ```typescript
   // الكود الحالي:
   const weekStart = new Date(year, month - 1, (weekNumber - 1) * 7 + 1);
   
   // المشكلة المحتملة:
   // الأسبوع 1: أيام 1-7 ✅
   // الأسبوع 2: أيام 8-14 (الكود يحسب 8-14) ✅
   // الأسبوع 3: أيام 15-21 (الكود يحسب 15-21) ✅
   // الأسبوع 4: أيام 22-28 (الكود يحسب 22-28) ✅
   // الأسبوع 5: أيام 29-31 (الكود يحسب 29-35) ⚠️
   ```
   
   **ملاحظة**: الأسبوع 5 قد يتجاوز نهاية الشهر

2. **شرط الفروقات**:
   ```typescript
   // الكود الحالي:
   if (Math.abs(revenueDiff) > 1 && Math.abs(bonusDiff) > 0.5)
   
   // المشكلة: يتطلب تحقق كلا الشرطين
   // قد يفوت حالات فيها فرق كبير في الإيراد لكن لا يؤثر على البونص
   ```

3. **التزامن اليدوي**: يجب الضغط على "تزامن" لتحديث البونص

---

## 6. التوصيات

### إصلاحات مقترحة

1. **تحسين حساب الأسبوع 5**:
   ```typescript
   // التأكد من عدم تجاوز نهاية الشهر
   const lastDayOfMonth = new Date(year, month, 0).getDate();
   weekEnd = new Date(year, month - 1, Math.min(weekEnd.getDate(), lastDayOfMonth));
   ```

2. **تعديل شرط الفروقات** (اختياري):
   ```typescript
   // استخدام OR بدلاً من AND للكشف عن أي فرق
   if (Math.abs(revenueDiff) > 1 || Math.abs(bonusDiff) > 0.5)
   ```

3. **إضافة تزامن تلقائي**: تشغيل التزامن عند إضافة إيرادات جديدة

4. **تنبيهات استباقية**: إرسال تنبيه عند اكتشاف فروقات تلقائياً

### تحسينات مستقبلية

1. **سجل تفصيلي للفروقات**: حفظ تاريخ الفروقات وكيفية حلها
2. **تقارير مقارنة شهرية**: مقارنة الفروقات عبر الأشهر
3. **تنبيهات متدرجة**: تنبيهات مختلفة حسب حجم الفرق

---

## 7. الخلاصة

**النظام يعمل بشكل صحيح** ويكشف الفروقات بدقة. الفرق المكتشف (35 ر.س في فرع طويق) يعكس فرقاً حقيقياً بين الإيرادات المسجلة والبونص المحسوب.

**التوصية**: مراجعة إيرادات فرع طويق للأسبوع 1 وإعادة تزامن البونص إذا لزم الأمر.

---

*تاريخ التقرير: 6 يناير 2026*
*إعداد: نظام المراجعة الآلي*
