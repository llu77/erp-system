# تقرير تحليلي شامل لنظام الإشعارات والتنبيهات البريدية

**المؤلف:** Manus AI  
**التاريخ:** 6 يناير 2026  
**الإصدار:** 1.0  

---

## الملخص التنفيذي

يقدم هذا التقرير مراجعة شاملة ومعمقة لنظام الإشعارات والتنبيهات البريدية في نظام ERP الشامل (Symbol AI). يتضمن التحليل فحصاً دقيقاً لبنية النظام، وآليات الـ Triggers، ونظام Queue للإرسال، وقوالب البريد الإلكتروني، مع تقديم توصيات للتحسين.

**النتائج الرئيسية:**
- النظام يتضمن **16 نوعاً** من الإشعارات المختلفة
- يستخدم **نظام Queue متقدم** مع Retry Logic و Dead Letter Queue
- يعتمد على **جدولة Cron** لإرسال التذكيرات والتقارير الدورية
- يوفر **قوالب بريد إلكتروني احترافية** بتصميم عربي متجاوب
- يتضمن **نظام تتبع** لمنع تكرار الإشعارات

---

## 1. البنية العامة لنظام الإشعارات

### 1.1 الملفات الأساسية

يتكون نظام الإشعارات من مجموعة ملفات متكاملة تعمل معاً لتوفير خدمة إشعارات شاملة:

| الملف | الوظيفة | الموقع |
|-------|---------|--------|
| `emailService.ts` | خدمة البريد الأساسية (Resend API) | `server/email/` |
| `emailNotificationService.ts` | خدمة الإشعارات المتقدمة | `server/notifications/` |
| `advancedNotificationService.ts` | إشعارات متقدمة مع تحليل | `server/notifications/` |
| `notificationQueue.ts` | نظام Queue مع Retry | `server/notifications/` |
| `scheduledNotificationService.ts` | خدمة الإشعارات المجدولة | `server/notifications/` |
| `reminderService.ts` | خدمة التذكيرات | `server/notifications/` |
| `notificationTracker.ts` | تتبع ومنع التكرار | `server/notifications/` |
| `emailTemplates.ts` | قوالب البريد الإلكتروني | `server/notifications/` |
| `cronScheduler.ts` | جدولة المهام (node-cron) | `server/scheduler/` |
| `triggerManager.ts` | إدارة الـ Triggers | `server/ai/` |
| `analysisEngine.ts` | محرك التحليل الذكي | `server/ai/` |

### 1.2 قاعدة البيانات

يعتمد النظام على جدولين رئيسيين في قاعدة البيانات:

**جدول مستلمي الإشعارات (`notificationRecipients`):**
```
- id: معرف فريد
- name: اسم المستلم
- email: البريد الإلكتروني
- role: الدور (admin, general_supervisor, branch_supervisor)
- branchId: معرف الفرع (null للمشرفين العامين)
- receiveRevenueAlerts: استقبال تنبيهات الإيرادات
- receiveExpenseAlerts: استقبال تنبيهات المصاريف
- receiveMismatchAlerts: استقبال تنبيهات عدم التطابق
- receiveInventoryAlerts: استقبال تنبيهات المخزون
- receiveMonthlyReminders: استقبال التذكيرات الشهرية
- receiveRequestNotifications: استقبال إشعارات الطلبات
- receiveReportNotifications: استقبال التقارير
- receiveBonusNotifications: استقبال إشعارات البونص
```

**جدول الإشعارات المرسلة (`sentNotifications`):**
```
- id: معرف فريد
- recipientId: معرف المستلم
- recipientEmail: البريد الإلكتروني
- notificationType: نوع الإشعار
- subject: عنوان الرسالة
- bodyArabic: محتوى الرسالة بالعربية
- status: حالة الإرسال (pending, sent, failed)
- sentAt: وقت الإرسال
- errorMessage: رسالة الخطأ (إن وجد)
```

---

## 2. أنواع الإشعارات والتنبيهات

### 2.1 تصنيف الإشعارات

يمكن تصنيف الإشعارات في النظام إلى أربع فئات رئيسية:

#### الفئة الأولى: التنبيهات الفورية (Real-time Alerts)

| نوع الإشعار | الوصف | نقطة الإطلاق |
|-------------|-------|--------------|
| `low_revenue` | تنبيه إيراد منخفض | عند تسجيل إيراد أقل من الحد المسموح |
| `high_expense` | تنبيه مصروف مرتفع | عند تسجيل مصروف يتجاوز 500 ر.س |
| `revenue_mismatch` | عدم تطابق الإيرادات | عند وجود فرق بين المتوقع والفعلي |
| `inventory_low` | نفاد المخزون | عند وصول المنتج للحد الأدنى |

#### الفئة الثانية: إشعارات العمليات (Operational Notifications)

| نوع الإشعار | الوصف | نقطة الإطلاق |
|-------------|-------|--------------|
| `employee_request` | طلب موظف جديد | عند تقديم طلب (إجازة، سلفة، استئذان) |
| `bonus_request` | طلب صرف بونص | عند طلب صرف البونص الأسبوعي |
| `payroll_created` | إنشاء مسير رواتب | عند إنشاء أو اعتماد مسير رواتب |
| `product_update` | تحديث منتج | عند تعديل بيانات منتج |

#### الفئة الثالثة: التذكيرات الدورية (Scheduled Reminders)

| نوع الإشعار | الوصف | التوقيت |
|-------------|-------|---------|
| `inventory_reminder` | تذكير الجرد الشهري | يوم 25 من كل شهر |
| `payroll_reminder` | تذكير مسيرات الرواتب | يوم 25 من كل شهر |
| `missing_revenue` | تذكير إيراد غير مسجل | يومياً الساعة 10:00 صباحاً |

#### الفئة الرابعة: التقارير الدورية (Periodic Reports)

| نوع الإشعار | الوصف | التوقيت |
|-------------|-------|---------|
| `weekly_report` | التقرير الأسبوعي | كل أحد الساعة 8:00 صباحاً |
| `monthly_report` | التقرير الشهري | نهاية كل شهر |

### 2.2 مصفوفة المستلمين حسب نوع الإشعار

```
┌─────────────────────────┬───────┬─────────────────┬──────────────────┐
│ نوع الإشعار             │ Admin │ General Supervisor │ Branch Supervisor │
├─────────────────────────┼───────┼─────────────────┼──────────────────┤
│ تنبيهات الإيرادات       │   ✓   │        ✓        │    ✓ (فرعه فقط)   │
│ تنبيهات المصاريف        │   ✓   │        ✓        │    ✓ (فرعه فقط)   │
│ عدم التطابق             │   ✓   │        ✓        │    ✓ (فرعه فقط)   │
│ طلبات الموظفين          │   ✓   │        ✓        │    ✓ (فرعه فقط)   │
│ طلبات البونص            │   ✓   │        ✓        │    ✓ (فرعه فقط)   │
│ التقارير الأسبوعية      │   ✓   │        ✓        │        ✓         │
│ تذكيرات الجرد           │   ✓   │        ✓        │        ✓         │
│ تذكيرات الرواتب         │   ✓   │        ✓        │        ✓         │
└─────────────────────────┴───────┴─────────────────┴──────────────────┘
```

---

## 3. آلية Triggers ونقاط الإطلاق

### 3.1 مخطط تدفق الإشعارات

```
┌──────────────────────────────────────────────────────────────────────┐
│                        مصادر الأحداث (Event Sources)                 │
├──────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
│  │ إنشاء إيراد │  │ إنشاء مصروف │  │ طلب موظف   │  │ Cron Jobs   │  │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  │
│         │                │                │                │         │
│         ▼                ▼                ▼                ▼         │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                    Trigger Manager                           │   │
│  │  - تحليل البيانات                                            │   │
│  │  - تقييم الخطورة                                             │   │
│  │  - تحديد المستلمين                                           │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                              │                                       │
│                              ▼                                       │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                    Notification Queue                         │   │
│  │  - إضافة للـ Queue                                           │   │
│  │  - ترتيب حسب الأولوية                                        │   │
│  │  - معالجة متوازية (3 concurrent)                             │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                              │                                       │
│                              ▼                                       │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                    Email Service (Resend)                     │   │
│  │  - إرسال البريد                                              │   │
│  │  - Retry Logic (3 محاولات)                                   │   │
│  │  - Dead Letter Queue                                         │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                              │                                       │
│                              ▼                                       │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                    Database Logging                           │   │
│  │  - تسجيل في sentNotifications                                │   │
│  │  - تحديث الحالة                                              │   │
│  └──────────────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────────────┘
```

### 3.2 نقاط الإطلاق في الكود

#### إشعارات الإيرادات
```typescript
// عند إنشاء إيراد يومي جديد (routers.ts)
if (!isMatched && unmatchReason) {
  emailNotifications.notifyRevenueMismatch({
    branchId: input.branchId,
    branchName: branch?.nameAr || 'غير محدد',
    date: input.date,
    expectedAmount: expectedAmount,
    actualAmount: totalEmployeeAmount,
    ...
  });
}
```

#### إشعارات المصاريف
```typescript
// عند إنشاء مصروف يتجاوز 500 ر.س (routers.ts)
if (expenseAmount > 500) {
  emailNotifications.notifyHighExpense({
    amount: expenseAmount,
    category: categoryNames[input.category],
    branchName: branch?.nameAr,
    ...
  });
}
```

#### إشعارات طلبات الموظفين
```typescript
// عند تقديم طلب جديد (routers.ts)
emailNotifications.notifyNewEmployeeRequest({
  employeeName: input.employeeName,
  requestType: input.requestType,
  title: input.title,
  ...
});
```

### 3.3 محرك التحليل الذكي (AI Analysis Engine)

يستخدم النظام محرك تحليل ذكي يعتمد على **Chain of Thought** لتقييم الإيرادات والمصاريف:

**خطوات التحليل:**
1. **جمع السياق:** جمع البيانات التاريخية للـ 30 يوم الماضية
2. **تحليل الانحراف:** حساب نسبة الانحراف عن المتوسط
3. **تقييم الخطورة:** تحديد مستوى الخطورة (low, medium, high, critical)
4. **التحليل العميق:** استخدام LLM للتحليل المتقدم
5. **توليد الأسئلة:** إنشاء أسئلة للمبررات
6. **تحديد الإجراءات:** تحديد الإشعارات المطلوبة

**قواعد تقييم الخطورة:**

| القاعدة | النقاط |
|---------|--------|
| إيراد أقل من 500 ر.س | +30 |
| انحراف حرج (> 50%) | +35 |
| انحراف ملحوظ (> 30%) | +20 |
| أقل من الحد الأدنى التاريخي | +25 |
| عدم تطابق الموازنة | +15 |

**مستويات الخطورة:**
- **Critical (حرج):** 70+ نقطة
- **High (عالي):** 50-69 نقطة
- **Medium (متوسط):** 30-49 نقطة
- **Low (منخفض):** أقل من 30 نقطة

---

## 4. نظام Queue والجدولة

### 4.1 Notification Queue

يوفر النظام Queue متقدم لإدارة الإشعارات مع الميزات التالية:

**الإعدادات الأساسية:**
```typescript
const QUEUE_CONFIG = {
  maxConcurrency: 3,           // عدد الإشعارات المعالجة بالتوازي
  defaultMaxAttempts: 3,       // عدد المحاولات الافتراضي
  baseRetryDelay: 1000,        // التأخير الأساسي (1 ثانية)
  maxRetryDelay: 60000,        // الحد الأقصى للتأخير (60 ثانية)
  processInterval: 1000,       // فترة معالجة Queue (1 ثانية)
  cleanupInterval: 300000,     // فترة تنظيف Queue (5 دقائق)
  deadLetterThreshold: 3,      // عدد المحاولات قبل Dead Letter
};
```

**آلية Retry (Exponential Backoff):**
```
المحاولة 1: 1 ثانية
المحاولة 2: 2 ثانية
المحاولة 3: 4 ثانية
```

**حالات الإشعار:**
- `pending`: في انتظار المعالجة
- `processing`: قيد المعالجة
- `sent`: تم الإرسال بنجاح
- `failed`: فشل مؤقت (سيُعاد المحاولة)
- `dead`: فشل نهائي (Dead Letter Queue)

### 4.2 نظام الجدولة (Cron Scheduler)

يستخدم النظام `node-cron` لجدولة المهام الدورية:

**المهام المجدولة:**

| المهمة | Cron Expression | التوقيت | الوصف |
|--------|-----------------|---------|-------|
| فحص الإيرادات اليومية | `0 10 * * *` | 10:00 صباحاً يومياً | فحص الفروع التي لم تسجل إيراداتها |
| التقرير الأسبوعي | `0 8 * * 0` | 8:00 صباحاً كل أحد | إرسال التقارير الأسبوعية |
| تذكيرات الجرد والرواتب | `0 9 * * *` | 9:00 صباحاً يومياً | فحص وإرسال التذكيرات الشهرية |

**المنطقة الزمنية:** `Asia/Riyadh` (UTC+3)

### 4.3 نظام منع التكرار (Notification Tracker)

يمنع النظام إرسال نفس الإشعار أكثر من مرة في اليوم:

```typescript
// أنواع الإشعارات المتتبعة
type TrackedNotificationType = 
  | 'inventory_reminder'
  | 'payroll_reminder'
  | 'monthly_inventory_reminder'
  | 'weekly_report'
  | 'daily_revenue_reminder'
  | 'low_stock_alert';
```

**آلية العمل:**
1. التحقق من الذاكرة المؤقتة (Memory Cache)
2. التحقق من ملف التتبع (`.notification-tracker.json`)
3. تسجيل الإشعار بعد الإرسال الناجح
4. تنظيف السجلات القديمة تلقائياً

---

## 5. قوالب البريد الإلكتروني

### 5.1 التصميم العام

تتميز قوالب البريد الإلكتروني بالخصائص التالية:

- **اتجاه RTL:** دعم كامل للغة العربية
- **خط Cairo:** استخدام خط Google Fonts العربي
- **تصميم متجاوب:** يعمل على جميع الأجهزة
- **ألوان متناسقة:** تدرج ألوان احترافي
- **هوية موحدة:** شعار Symbol AI في جميع الرسائل

### 5.2 القوالب المتوفرة

| القالب | الوظيفة | الملف |
|--------|---------|-------|
| `getBaseTemplate` | القالب الأساسي | `emailTemplates.ts` |
| `getEmployeeRequestTemplate` | طلب موظف جديد | `emailTemplates.ts` |
| `getRequestStatusUpdateTemplate` | تحديث حالة الطلب | `emailTemplates.ts` |
| `getBonusRequestTemplate` | طلب صرف بونص | `emailTemplates.ts` |
| `getWeeklyBonusReportTemplate` | تقرير البونص الأسبوعي | `emailTemplates.ts` |
| `getHighExpenseAlertTemplate` | تنبيه مصروف مرتفع | `emailTemplates.ts` |
| `getNewPurchaseOrderTemplate` | أمر شراء جديد | `emailTemplates.ts` |
| `getRevenueMismatchTemplate` | إيراد غير متطابق | `emailTemplates.ts` |
| `getInventoryReminderTemplate` | تذكير الجرد | `emailTemplates.ts` |
| `getPayrollReminderTemplate` | تذكير مسيرات الرواتب | `emailTemplates.ts` |

### 5.3 عناصر التصميم

**صناديق التنبيه (Alert Boxes):**
- `info`: خلفية زرقاء فاتحة
- `warning`: خلفية صفراء فاتحة
- `success`: خلفية خضراء فاتحة
- `danger`: خلفية حمراء فاتحة
- `purple`: خلفية بنفسجية فاتحة

**الشارات (Badges):**
- `pending`: قيد الانتظار
- `approved`: موافق عليه
- `rejected`: مرفوض
- `urgent`: عاجل
- `high`: عالي الأولوية
- `normal`: عادي
- `low`: منخفض الأولوية

---

## 6. التوصيات والتحسينات المقترحة

### 6.1 تحسينات فورية (قصيرة المدى)

1. **إضافة جدول لسجل تنفيذ الجدولة:**
   - إنشاء جدول `schedulerExecutionLog` لتتبع تنفيذ المهام المجدولة
   - تسجيل وقت البدء والانتهاء والنتيجة

2. **تحسين نظام Dead Letter Queue:**
   - إضافة إشعار للمسؤول عند تراكم الإشعارات الفاشلة
   - توفير واجهة لإدارة الإشعارات الفاشلة

3. **إضافة تفضيلات المستلمين:**
   - السماح للمستلمين بتحديد أوقات الإرسال المفضلة
   - إضافة خيار تجميع الإشعارات في رسالة واحدة

### 6.2 تحسينات متوسطة المدى

1. **نظام إشعارات متعدد القنوات:**
   - إضافة دعم SMS عبر Twilio
   - إضافة إشعارات Push للتطبيق
   - إضافة إشعارات داخل النظام (In-App)

2. **لوحة تحكم الإشعارات:**
   - إنشاء صفحة لعرض سجل الإشعارات
   - إضافة إحصائيات الإرسال والفشل
   - توفير أدوات البحث والتصفية

3. **تحسين محرك التحليل:**
   - إضافة تعلم آلي للتنبؤ بالانحرافات
   - تخصيص عتبات التنبيه لكل فرع
   - إضافة تحليل الاتجاهات

### 6.3 تحسينات طويلة المدى

1. **نظام إشعارات ذكي:**
   - تعلم من سلوك المستخدم لتحسين التوقيت
   - تخصيص المحتوى حسب المستلم
   - تقليل الإشعارات غير الضرورية

2. **تكامل مع أنظمة خارجية:**
   - ربط مع Slack/Teams للفرق
   - تكامل مع CRM للعملاء
   - ربط مع أنظمة ERP أخرى

---

## 7. الخلاصة

يتميز نظام الإشعارات في Symbol AI ERP بالشمولية والمرونة، حيث يغطي جميع جوانب العمليات التجارية من الإيرادات والمصاريف إلى طلبات الموظفين والتقارير الدورية. النظام مبني على أسس تقنية متينة تشمل:

- **Queue System:** نظام طوابير متقدم مع إعادة المحاولة
- **Cron Scheduling:** جدولة دقيقة للمهام الدورية
- **AI Analysis:** تحليل ذكي لتقييم الخطورة
- **Professional Templates:** قوالب بريد احترافية

مع تطبيق التوصيات المقترحة، يمكن رفع كفاءة النظام وتحسين تجربة المستخدم بشكل ملحوظ.

---

## المراجع

- [1] ملف `server/notifications/notificationQueue.ts` - نظام Queue للإشعارات
- [2] ملف `server/scheduler/cronScheduler.ts` - نظام الجدولة
- [3] ملف `server/ai/triggerManager.ts` - مدير الـ Triggers
- [4] ملف `server/ai/analysisEngine.ts` - محرك التحليل الذكي
- [5] ملف `server/notifications/emailTemplates.ts` - قوالب البريد الإلكتروني
- [6] ملف `drizzle/schema.ts` - مخطط قاعدة البيانات

---

*تم إعداد هذا التقرير بواسطة Manus AI*
