# نظام ERP الشامل - قائمة المهام

## قاعدة البيانات
- [x] جدول المستخدمين مع الأدوار (Admin, Manager, Employee)
- [x] جدول المنتجات والمخزون
- [x] جدول الفئات
- [x] جدول العملاء
- [x] جدول الموردين
- [x] جدول المبيعات والفواتير
- [x] جدول تفاصيل الفواتير
- [x] جدول المشتريات وأوامر الشراء
- [x] جدول تفاصيل أوامر الشراء
- [x] جدول الإشعارات
- [x] جدول سجل الأنشطة

## نظام المصادقة والصلاحيات
- [x] تسجيل الدخول بثلاثة مستويات (Admin, Manager, Employee)
- [x] حماية المسارات حسب الصلاحيات
- [x] إجراءات محمية للمدير والموظف

## لوحة التحكم الرئيسية
- [x] إحصائيات شاملة (المبيعات، المشتريات، المخزون، العملاء)
- [x] رسوم بيانية للمبيعات والمشتريات
- [x] تنبيهات المخزون المنخفض
- [x] آخر العمليات

## إدارة المستخدمين والموظفين
- [x] عرض قائمة المستخدمين
- [x] إضافة مستخدم جديد
- [x] تعديل بيانات المستخدم
- [x] حذف مستخدم
- [x] تعيين الصلاحيات

## إدارة المخزون والمنتجات
- [x] عرض قائمة المنتجات
- [x] إضافة منتج جديد
- [x] تعديل بيانات المنتج
- [x] حذف منتج
- [x] تتبع الكميات
- [x] تنبيهات نفاد المخزون
- [x] إدارة الفئات

## إدارة المبيعات والفواتير
- [x] إنشاء فاتورة جديدة
- [x] عرض قائمة الفواتير
- [x] تفاصيل الفاتورة
- [ ] طباعة الفاتورة
- [x] تتبع المبيعات

## إدارة المشتريات والموردين
- [x] تسجيل الموردين
- [x] إنشاء أمر شراء
- [x] عرض قائمة أوامر الشراء
- [x] إدارة فواتير الموردين

## إدارة العملاء
- [x] قاعدة بيانات العملاء
- [x] إضافة عميل جديد
- [x] تعديل بيانات العميل
- [x] سجل المعاملات
- [x] معلومات الاتصال

## التقارير المالية والإحصائيات
- [x] تقارير المبيعات
- [x] تقارير المشتريات
- [x] تقارير الأرباح
- [x] تقارير المخزون
- [ ] تصدير التقارير إلى PDF
- [ ] تصدير التقارير إلى Excel
- [ ] حفظ التقارير في التخزين السحابي

## الإشعارات التلقائية
- [x] إشعار نفاد المخزون
- [x] إشعار أوامر الشراء الجديدة
- [x] إشعار المبيعات الكبيرة

## الواجهة والتصميم
- [x] واجهة عربية كاملة RTL
- [x] تصميم احترافي ونظيف
- [x] تصميم متجاوب
- [x] قائمة جانبية للتنقل

## الإشعارات المخصصة (طلب جديد)
- [x] إضافة إجراء لإرسال إشعارات مخصصة من المدير
- [x] واجهة إرسال إشعارات مخصصة
- [x] عرض الإشعارات مع جرس الإشعارات

## نظام البونص الأسبوعي (طلب جديد)
- [x] إضافة جداول البونص (weeklyBonuses, bonusDetails, bonusAuditLog)
- [x] جداول الفروع والموظفين والإيرادات
- [x] إنشاء منطق حساب البونص (5 مستويات)
- [x] تزامن تلقائي مع إدخال الإيرادات
- [x] صفحة إدخال الإيرادات اليومية
- [x] صفحة البونص للمشرف
- [x] صفحة طلبات البونص للأدمن
- [x] انعكاس الإيرادات على البونص بشكل تلقائي
- [x] اختبارات vitest لحاسبة البونص

## إدارة الفروع والموظفين (طلب جديد)
- [x] صفحة إدارة الفروع (إضافة، تعديل، حذف)
- [x] صفحة إدارة الموظفين (إضافة، تعديل، حذف، ربط بالفرع)
- [x] إضافة الروابط في القائمة الجانبية
- [x] اختبارات vitest (41 اختبار ناجح)

## نظام طلبات الموظفين (طلب جديد)
- [x] جدول طلبات الموظفين في قاعدة البيانات
- [x] أنواع الطلبات: سلفة، إجازة، صرف متأخرات، استئذان، اعتراض، استقالة
- [x] دوال قاعدة البيانات للطلبات (CRUD)
- [x] إجراءات tRPC للطلبات
- [x] صفحة تقديم الطلبات للموظف
- [x] صفحة إدارة الطلبات للمدير (موافقة/رفض)
- [x] إشعارات عند تقديم طلب جديد أو تغيير الحالة
- [x] سجل تدقيق للطلبات
- [x] اختبارات vitest (62 اختبار ناجح)

## نظام مسيرات الرواتب (مكتمل)
- [x] جدول مسيرات الرواتب (payrolls)
- [x] جدول تفاصيل الرواتب (payroll_details)
- [x] حساب الراتب: أساسي (2000) + ساعات إضافية (1000 إذا مفعل) + حوافز مشرف (400)
- [x] خصومات الموظفين
- [x] إنشاء مسيرة رواتب شهرية (يوم 28)
- [x] صفحة مسيرات الرواتب
- [x] تصدير مسيرات الرواتب PDF احترافي

## صفحة المصاريف (مكتمل)
- [x] جدول المصاريف (expenses)
- [x] أنواع المصاريف (10 تصنيفات)
- [x] صفحة إدارة المصاريف (إضافة، تعديل، حذف)
- [x] سير عمل الموافقات (مراجعة -> اعتماد -> دفع)

## تصدير PDF احترافي (مكتمل)
- [x] هاندلر تصدير PDF للتقارير
- [x] قالب PDF احترافي للرواتب
- [x] قالب PDF للإيرادات
- [x] قالب PDF لطلبات الموظفين الموافق عليها
- [x] قالب PDF للمصاريف
- [x] اختبارات vitest (95 اختبار ناجح)

## نظام تسجيل الدخول المحلي (مكتمل)
- [x] إضافة حقول username و password إلى جدول المستخدمين
- [x] إنشاء حساب Admin (username: Admin, password: Omar101010)
- [x] نظام تسجيل دخول محلي بدلاً من OAuth فقط
- [x] صفحة تسجيل دخول محلية
- [x] تشفير كلمات المرور (PBKDF2 + SHA-512)

## صلاحيات المشرفين المحدودة (مكتمل)
- [x] المشرف يمكنه إدخال الإيرادات فقط (بدون تعديل/حذف)
- [x] المشرف يمكنه إدخال المصاريف فقط (بدون تعديل/حذف)
- [x] المشرف يمكنه تقديم الطلبات فقط
- [x] Admin فقط يمكنه التعديل والحذف
- [x] اختبارات vitest (106 اختبار ناجح)

## طباعة الفواتير (مكتمل)
- [x] قالب طباعة احترافي للفواتير
- [x] معاينة الفاتورة قبل الطباعة
- [x] معلومات الشركة في الفاتورة
- [ ] دعم QR Code (مستقبلي)

## تصدير التقارير (مكتمل)
- [x] تصدير PDF للتقارير
- [x] تصدير Excel للتقارير
- [ ] حفظ التقارير في S3 (مستقبلي)

## صفحة الإعدادات (مكتمل)
- [x] إعدادات الشركة (الاسم، الشعار، العنوان)
- [x] إعدادات الضرائب
- [x] إعدادات العملة
- [x] إعدادات الرواتب (الراتب الأساسي، الساعات الإضافية، حوافز المشرف)

## تقرير الأرباح والخسائر (مكتمل)
- [x] تقرير تفصيلي للأرباح والخسائر
- [x] قائمة الدخل التفصيلية
- [x] المؤشرات الرئيسية (هوامش الربح)
- [x] رسوم بيانية للاتجاه الشهري
- [x] توزيع المصاريف حسب الفئة
- [x] تصدير PDF/Excel

## البيانات التجريبية (مكتمل)
- [x] إضافة فروع تجريبية (5 فروع)
- [x] إضافة موظفين تجريبيين (15 موظف)
- [x] إضافة فئات ومنتجات (20 منتج)
- [x] إضافة عملاء (10 عملاء)
- [x] إضافة موردين (5 موردين)
- [x] إضافة فواتير مبيعات (10 فواتير)
- [x] إضافة 5 فئات منتجات

## إصلاح صفحة تسجيل الدخول (طلب جديد)
- [x] جعل صفحة تسجيل الدخول المحلية هي الصفحة الافتراضية
- [x] عرض نموذج إدخال اسم المستخدم وكلمة المرور
- [x] توجيه المستخدم غير المسجل إلى صفحة الدخول

## التحسينات المقترحة (تقرير التحليل)

### أولوية عالية
- [x] إضافة QR Code للفواتير (توافق ZATCA)
- [ ] تسجيل محاولات الدخول الفاشلة
- [ ] تنبيهات الأنشطة المشبوهة
- [ ] سجل تدقيق تغييرات الأسعار
- [x] تحسين سياسة كلمات المرور

### أولوية متوسطة
- [ ] نظام الصلاحيات التفصيلية (Granular Permissions)
- [ ] حساب التأمينات الاجتماعية تلقائياً
- [ ] نظام إعادة الطلب التلقائي للمخزون
- [ ] تقارير التدقيق الدورية
- [ ] المصادقة الثنائية (2FA)

### أولوية منخفضة
- [ ] نظام نقاط الولاء للعملاء
- [ ] تتبع الدفعات (Batch Tracking)
- [ ] لوحة التحكم التنفيذية المتقدمة
- [ ] الربط مع منظومة فاتورة ZATCA

## التحسينات المطلوبة للتنفيذ الآن

### 1. مؤشرات الأداء المالي (KPIs)
- [x] حساب هامش الربح الإجمالي
- [x] حساب هامش الربح الصافي
- [x] حساب العائد على الاستثمار (ROI)
- [x] حساب نسبة السيولة
- [x] عرض KPIs في لوحة التحكم

### 2. نظام التنبيهات الذكية
- [x] تنبيه 5 محاولات دخول فاشلة متتالية
- [x] تنبيه تغيير كبير في الأسعار (أكثر من 20%)
- [x] تنبيه حذف كميات كبيرة من البيانات
- [x] تنبيه الوصول من موقع جغرافي جديد
- [x] تنبيه عمليات مالية كبيرة غير معتادة

### 3. تقارير التدقيق الدورية
- [x] ملخص الأنشطة حسب المستخدم
- [x] تقرير العمليات غير المعتادة
- [x] مقارنة بالفترات السابقة
- [x] حماية سجلات التدقيق من الحذف/التعديل

### 4. نظام الصلاحيات التفصيلية
- [x] جدول الصلاحيات في قاعدة البيانات
- [x] ربط الصلاحيات بالمستخدمين
- [x] واجهة إدارة الصلاحيات

### 5. إدارة المخزون المتقدمة
- [x] نظام إعادة الطلب التلقائي
- [x] تتبع الدفعات (Batch Tracking)
- [x] تتبع تاريخ انتهاء الصلاحية
- [x] تطبيق FIFO/LIFO تلقائياً
- [x] تنبيهات المنتجات قريبة الانتهاء
- [x] الجرد الدوري ومقارنة الفروقات

### 6. التقارير والتحليلات المتقدمة
- [x] لوحة تحكم تنفيذية مع KPIs
- [x] تقارير ABC للمخزون
- [x] تحليل الاتجاهات والمقارنات
- [x] توقع المبيعات المستقبلية

## التقارير الدورية ولوحة المبيعات (طلب جديد)

### التقارير الدورية التلقائية
- [x] إعداد Resend للبريد الإلكتروني
- [x] إنشاء قوالب التقارير بالبريد الإلكتروني
- [x] تقرير المبيعات الأسبوعي
- [x] تقرير المخزون المنخفض
- [x] تقرير الأرباح والخسائر
- [x] واجهة إعدادات التقارير الدورية

### لوحة تحكم المبيعات التفاعلية
- [x] رسم بياني للمبيعات اليومية
- [x] رسم بياني للمبيعات حسب الفئة
- [x] أفضل المنتجات مبيعاً
- [x] أفضل العملاء
- [x] مقارنة المبيعات بالفترات السابقة
- [x] فلاتر التاريخ والفرع

## بوابة HR Onboarding لـ Symbol AI (طلب جديد)

### الصفحات الرئيسية
- [x] صفحة Home مع رسالة الترحيب وقيم الشركة
- [x] صفحة About عن الشركة
- [x] صفحة Policies للسياسات
- [x] صفحة FAQ مع بحث

### المكونات
- [x] Navigation bar متجاوب
- [x] بطاقات Cards للقوائم
- [x] شريط بحث للأسئلة الشائعة
- [x] قائمة مهام Checklist
- [x] قسم المزايا Benefits

### التصميم
- [x] ألوان داكنة متدرجة رسمية
- [x] شعار Symbol AI
- [x] تصميم متجاوب

## سجل الإيرادات الشهري (طلب جديد)
- [x] إضافة سجل الإيرادات في نهاية صفحة الإيرادات
- [x] عرض الإيرادات من أول يوم إلى آخر يوم في الشهر

## تصدير سجل الإيرادات PDF (طلب جديد)
- [x] إنشاء API لتوليد PDF للإيرادات الشهرية
- [x] إضافة زر تصدير PDF في واجهة المستخدم
- [x] تنسيق PDF باللغة الإنجليزية مع الشعار

## تحديث النظام (طلب جديد)
- [x] تغيير اسم النظام إلى Symbol AI
- [x] تحديث المنتجات بالقائمة الجديدة (منتجات صالون)
- [x] إضافة بنود المصاريف الجديدة (21 بند)
- [x] إضافة ميزة تصدير PDF للإيرادات

## إضافة شعار Symbol AI (طلب جديد)
- [x] إضافة الشعار في صفحة تسجيل الدخول
- [x] إضافة الشعار في الفواتير المطبوعة

## إضافة شعار Symbol AI في جميع الواجهات (طلب جديد)
- [x] إضافة الشعار في صفحة تسجيل الدخول
- [x] إضافة الشعار في القائمة الجانبية
- [x] إضافة الشعار في الفواتير المطبوعة
- [x] إضافة الشعار في التقارير
- [x] إضافة الشعار في صفحة HR Onboarding

## مراجعة البريد والإشعارات وقاعدة البيانات (طلب جديد)
- [x] مراجعة إعدادات Resend للبريد الإلكتروني
- [x] مراجعة قوالب الإشعارات المخصصة
- [x] اختبار إرسال البريد الإلكتروني
- [x] التحقق من حفظ البيانات في قاعدة البيانات

## نظام الجدولة ومراقب النظام المتقدم (طلب جديد)
### إرسال بريد اختباري
- [x] إرسال تقرير أسبوعي اختباري للبريد الإلكتروني

### مراقب النظام المتقدم
- [x] إنشاء جدول لإعدادات الجدولة في قاعدة البيانات
- [x] إنشاء جدول لسجل تنفيذ المهام المجدولة
- [x] إنشاء خدمة مراقب النظام (System Monitor)
- [x] مراقبة المخزون المنخفض تلقائياً
- [x] مراقبة العمليات المالية الكبيرة
- [x] مراقبة انتهاء صلاحية المنتجات

### الجدولة المتقدمة
- [x] جدولة التقرير الأسبوعي (كل أحد)
- [x] جدولة تقرير المخزون (يومياً)
- [x] جدولة تقرير الأرباح (شهرياً)
- [x] إمكانية تخصيص وقت الإرسال
- [x] إمكانية تفعيل/تعطيل كل تقرير

### واجهة المستخدم
- [x] صفحة إعدادات الجدولة المتقدمة
- [x] عرض سجل التنفيذ
- [x] إحصائيات المراقبة

## نظام الإشعارات المتقدم (طلب جديد)

### إعداد المستلمين
- [x] الأدمن: Nntn127@gmail.com (كل الإشعارات)
- [x] المشرف العام: Salemalwadai1997@gmail.com (كل الإشعارات)
- [x] مشرف فرع طويق: mohamedismaelebrhem@gmail.com (إشعارات فرع طويق فقط)
- [x] مشرف فرع لبن: Galalbdo766@gmail.com (إشعارات فرع لبن فقط)

### تنبيهات الإيرادات والمصاريف
- [x] تنبيه عند تسجيل إيراد أقل من 500 ريال
- [x] تنبيه عند تسجيل مصروف أعلى من 500 ريال
- [x] تنبيه عند تسجيل إيراد غير مطابق (حتى مع السبب)
- [x] إرسال للأدمن والمشرف العام ومشرف الفرع المعني

### التذكيرات الشهرية
- [x] تذكير بالجرد والتدقيق يوم 27 من كل شهر
- [x] تذكير لإنشاء مسيرات الرواتب

### إشعارات العمليات
- [x] إشعار عند إنشاء/تحديث طلب موظف
- [x] إشعار عند إضافة/تعديل منتج
- [x] إشعار عند إنشاء مسيرة رواتب
- [x] إشعار التقارير الشهرية والأسبوعية
- [x] إشعار طلبات البونص

### القوالب
- [x] قوالب الإشعارات بالعربي والإنجليزي
- [x] تنسيق احترافي للرسائل

### واجهة إدارة المستلمين
- [x] صفحة إدارة مستلمي الإشعارات
- [x] إضافة/تعديل/حذف المستلمين
- [x] إرسال بريد اختباري
- [x] سجل الإشعارات المرسلة
- [x] اختبارات vitest (124 اختبار ناجح)

## رفع صورة الموازنة في الإيرادات (طلب جديد)

### تحديث قاعدة البيانات
- [x] إضافة حقل صورة الموازنة (balanceImage) في جدول الإيرادات اليومية

### رفع الصور
- [x] إضافة API لرفع الصور إلى S3
- [x] حفظ رابط الصورة في قاعدة البيانات

### واجهة المستخدم
- [x] إضافة خانة رفع صورة الموازنة في نموذج الإيرادات
- [x] عرض معاينة الصورة قبل الحفظ
- [x] عرض صورة الموازنة في السجل الشهري
- [x] إمكانية تكبير الصورة للمشاهدة


## إنشاء حسابات المشرفين وربطهم بالفروع (طلب جديد)

### المشرفين المطلوبين
- [x] مشرف لبن: Laban / admin1234 - عبدالحي - Galalbdo766@gmail.com
- [x] مشرف طويق: Twiq / admin1234 - محمد - mohamedismaelebrhem@gmail.com
- [x] المشرف العام: GeneralSupervisor / admin1234 - سالم الوادعي - مشاهدة فقط

### تحديث قاعدة البيانات
- [x] إضافة حقل الفرع المرتبط (branchId) في جدول المستخدمين
- [x] إضافة نوع صلاحية جديد (supervisor, viewer)

### الصلاحيات
- [x] مشرف الفرع: إدخال فقط (إيرادات، مصاريف، طلبات) - بدون تعديل أو حذف
- [x] المشرف العام: مشاهدة فقط + طباعة PDF
- [x] تقييد الوصول حسب الفرع

### الإشعارات
- [x] إضافة مشرف لبن كمستلم إشعارات فرع لبن
- [x] إضافة مشرف طويق كمستلم إشعارات فرع طويق


## تخصيص القوائم وتصفية البيانات حسب الصلاحيات (طلب جديد)

### تخصيص القوائم الجانبية
- [x] إخفاء صفحات الإدارة للمشرفين (المستخدمين، الإعدادات)
- [x] إخفاء صفحات التعديل والحذف للمشاهدين
- [x] عرض الصفحات المتاحة فقط حسب الدور

### تصفية البيانات حسب الفرع
- [x] تصفية الإيرادات حسب فرع المشرف
- [x] تصفية المصاريف حسب فرع المشرف
- [x] تصفية الطلبات حسب فرع المشرف
- [x] تصفية التقارير حسب فرع المشرف

### إخفاء أزرار التعديل والحذف
- [x] إخفاء أزرار التعديل للمشرفين والمشاهدين
- [x] إخفاء أزرار الحذف للمشرفين والمشاهدين
- [x] إخفاء أزرار الإضافة للمشاهدين


## تخصيص لوحة التحكم للمشرفين (طلب جديد)

### تصفية الإحصائيات
- [x] عرض إحصائيات الفرع فقط للمشرفين
- [x] عرض آخر الفواتير للفرع فقط
- [x] عرض آخر أوامر الشراء للفرع فقط
- [x] إضافة عنوان يوضح الفرع المحدد
- [x] إضافة تنبيه للمشاهدين (وضع المشاهدة فقط)


## فحص واختبار شامل للجاهزية للنشر (طلب جديد)

### فحص TypeScript والبناء
- [x] فحص أخطاء TypeScript (0 أخطاء)
- [x] اختبار بناء الإنتاج (13.68 ثانية)
- [x] فحص التبعيات والحزم

### اختبار الوحدات
- [x] تشغيل جميع الاختبارات (124/124 ناجح)
- [x] فحص تغطية الكود
- [x] اختبار الحالات الحدية

### فحص الأمان
- [x] التحقق من صلاحيات المستخدمين (protectedProcedure, adminProcedure)
- [x] فحص حماية API (2 public فقط)
- [x] التحقق من تشفير كلمات المرور (PBKDF2-SHA512)
- [x] فحص CORS والـ Headers

### اختبار الواجهة
- [x] اختبار تسجيل الدخول (مشرف لبن)
- [x] اختبار صفحات المشرفين
- [x] اختبار الصلاحيات في الواجهة

### فحص قاعدة البيانات
- [x] التحقق من سلامة الجداول (45 جدول)
- [x] فحص العلاقات والمفاتيح
- [x] اختبار الاستعلامات

### تحليل الأداء
- [x] قياس وقت التحميل
- [x] فحص حجم الحزم (JS: 2.4MB, CSS: 157KB)
- [x] توصيات التحسين

### النتيجة النهائية
- [x] **النظام جاهز للنشر** ✅


## تكامل Zapier (طلب جديد)

### السيناريو 1: تصدير الإيرادات إلى Google Sheets
- [x] إنشاء Google Sheet للإيرادات اليومية
- [x] تصدير الإيرادات الحالية
- [x] إعداد الأعمدة (التاريخ، الفرع، نقدي، شبكة، مدى، المجموع، الموازنة)

### السيناريو 2: التقرير اليومي عبر Gmail
- [x] إنشاء قالب التقرير اليومي
- [x] إرسال تقرير اختباري
- [x] تضمين إحصائيات الفرعين

### السيناريو 3: تصدير المصاريف المعتمدة

## إصلاح صفحة الجرد الفعلي للمشرف (طلب عاجل)
- [x] فحص صفحة الجرد الفعلي وتحديد المشكلة
- [x] إصلاح المشكلة في الكود (تحديث API والواجهة)
- [x] اختبار الإصلاح (بدء جرد جديد بنجاح)
- [x] إنشاء Google Sheet للمصاريف
- [x] إعداد الأعمدة

## نظام المراقبة الذكية المتقدم (طلب جديد)

### محرك التحليل الذكي (Chain of Thought)
- [x] تحليل الإيرادات بمنطق محسوب (5 خطوات)
- [x] تحليل المصاريف بمنطق محسوب (4 خطوات)
- [x] توليد الأسئلة الذكية للمبررات
- [x] تقييم المبررات بالذكاء الاصطناعي

### نظام Triggers
- [x] Trigger عند إنشاء إيراد (منخفض/غير مطابق)
- [x] Trigger عند إنشاء مصروف (مرتفع)
- [x] إرسال طلبات المبررات عبر البريد
- [x] التصعيد التلقائي (24 ساعة)

### التقارير الذكية
- [x] التقرير اليومي الذكي مع تحليل LLM
- [x] التقرير الأسبوعي
- [x] التقرير الشهري

### خدمة التصدير لـ Zapier
- [x] تجهيز بيانات الإيرادات للتصدير
- [x] تجهيز بيانات المصاريف للتصدير
- [x] تنسيق البريد الإلكتروني
- [x] تنسيق Google Sheets
- [ ] إنشاء Google Sheet للمصاريف
- [ ] تصدير المصاريف المعتمدة
- [ ] إعداد الأعمدة (التاريخ، الفرع، التصنيف، المبلغ، الوصف، الحالة)



## نظام المراقبة الذكية المتقدم مع AI (طلب جديد)

### معمارية النظام
- [ ] تصميم Chain of Thought للتحليل
- [x] تحديد مستويات الخطورة والمنطق
- [ ] تصميم نظام Triggers

### محرك التحليل الذكي (AI Analysis Engine)
- [ ] إنشاء محرك التحليل مع Claude/GPT
- [x] تحليل الإيرادات مع Chain of Thought
- [x] تحليل المصاريف مع Chain of Thought
- [x] تحليل الأنماط الأسبوعية
- [ ] تقييم المبررات الذكي

### نظام Triggers والأتمتة
- [ ] Trigger عند إدخال إيراد
- [ ] Trigger عند إدخال مصروف
- [ ] Trigger عند عدم التطابق
- [ ] Trigger التقرير اليومي
- [ ] Trigger التقرير الأسبوعي
- [ ] Trigger طلب المبررات

### التصدير التلقائي مع Zapier
- [ ] تصدير تلقائي للإيرادات إلى Sheets
- [ ] تصدير تلقائي للمصاريف إلى Sheets
- [ ] إرسال التقارير الذكية عبر البريد
- [ ] متابعة طلبات المبررات


## الدوال المتقدمة للاستعلام والمراقبة (طلب جديد)
- [ ] إنشاء ملف advanced_queries.ts مع الإصلاحات
- [x] إضافة دوال مراقبة النظام (checkDatabaseHealth, checkDataIntegrity)
- [x] إضافة دوال المطابقة (reconcileBranchRevenues, reconcileBonusCalculations, reconcileMonth)
- [x] إضافة دوال التحليلات (analyzeEmployeePerformance, analyzeBranchPerformance, getDataGapsReport)
- [x] إضافة دوال الامتثال (getComplianceReport)
- [x] إضافة الـ endpoints في routers.ts
- [ ] اختبار الدوال والتحقق من عملها

## تحسينات نظام الإيرادات (طلب جديد)

### الرصيد التلقائي
- [ ] الرصيد = الشبكة تلقائياً (غير محسوب في الإجمالي)
- [x] تحديث الرصيد عند تغيير قيمة الشبكة

### المطابقة الحسابية التلقائية
- [ ] إزالة زر المطابقة
- [ ] المطابقة تلقائية: إيرادات الموظفين = الكاش + الشبكة
- [ ] سبب إجباري عند عدم التطابق
- [ ] علامة حمراء في السجل للإيرادات غير المطابقة
- [ ] إمكانية مشاهدة السبب في السجل

### منع التكرار
- [ ] منع تسجيل أكثر من إيراد لنفس اليوم ونفس الفرع
- [ ] الأدمن فقط يستطيع التعديل والحذف

### صورة الموازنة الإجبارية
- [ ] صورة الموازنة إجبارية وليست اختيارية
- [ ] مطابقة التاريخ في الصورة مع تاريخ التسجيل
- [ ] مطابقة المبلغ في الصورة مع قيمة الشبكة
- [ ] إمكانية رفع أكثر من صورة
- [ ] إشعار لرفع صورة أخرى إذا لم تكن واضحة


## تحسينات نظام الإيرادات الحرجة (طلب جديد - قيد التنفيذ)
### المرحلة 1: تحليل وتخطيط ✅
- [x] تحليل المتطلبات الحرجة
- [x] تصميم الحل المقترح
- [x] إنشاء خطة مرحلية

### المرحلة 2: تحديث قاعدة البيانات ✅
- [x] إضافة حقول balanceImages (JSON array) للصور المتعددة
- [x] إضافة حقول imageVerificationStatus و imageVerificationNote
- [x] إضافة حقول isMatched و unmatchReason للمطابقة التلقائية
- [x] إنشاء migration للحقول الجديدة

### المرحلة 3: تحديث API ✅
- [x] تحديث input schema في createDaily procedure
- [x] إضافة منطق منع التكرار (getDailyRevenueByDate)
- [x] إضافة حساب الرصيد التلقائي (= الشبكة)
- [x] إضافة المطابقة التلقائية (employee revenues = cash + network)
- [x] إضافة طلب سبب عند عدم التطابق
- [x] إضافة دالة getDailyRevenueByDate في db.ts

### المرحلة 4: تحديث Frontend ✅
- [x] إزالة حقل الرصيد اليدوي من النموذج
- [x] إزالة مفتاح Toggle للمطابقة
- [x] إضافة عرض المطابقة التلقائية مع مؤشر أخضر/أحمر
- [x] إضافة حقل سبب عدم التطابق (يظهر فقط عند عدم التطابق)
- [x] تحديث عرض الصور المتعددة في السجل الشهري
- [x] إضافة Dialog لعرض سبب عدم التطابق

### المرحلة 5: الاختبارات ✅
- [x] إنشاء اختبارات شاملة للإيرادات (20 اختبار)
- [x] اختبار منع التكرار
- [x] اختبار حساب الرصيد التلقائي
- [x] اختبار المطابقة التلقائية
- [x] اختبار طلب سبب عند عدم التطابق
- [x] اختبار الصور المتعددة
- [x] اختبار الحالات الحدية
- [x] إجمالي 144 اختبار ناجح (124 + 20)

### المرحلة 6: إصلاح الأخطاء ✅
- [x] إصلاح أخطاء TypeScript
- [x] التحقق من التجميع الناجح
- [x] التحقق من تمرير جميع الاختبارات

### المرحلة 7: التوثيق والنشر (قيد الانتظار)
- [ ] توثيق التغييرات في README
- [ ] حفظ checkpoint
- [x] اختبار النظام بالكامل
- [ ] التحقق من التوافق مع الأنظمة الأخرى


## تحسينات الصلاحيات والتنقل (طلب جديد)
- [x] التحقق من تسجيل دخول GeneralSupervisor (username: GeneralSupervisor, password: Supervisor123)
- [x] إضافة صفحة طلبات الموظفين للمشرفين (موجودة في manage-requests)
- [x] جعل صفحة البونص متاحة للجميع (admin, manager, employee, supervisor, viewer)
- [x] تحديث التنقل حسب الدور
- [x] إضافة supervisor إلى صفحة إدارة الطلبات
- [x] اختبار الصلاحيات (144 اختبار ناجح)


## إضافة طلب المنتجات للمشرفين (طلب جديد)
- [x] البحث عن صفحة طلب المنتجات الموجودة (/purchases)
- [x] تحديث الصلاحيات لإضافة المشرفين (supervisor)
- [x] التأكد من أن كل مشرف يرى فرعه فقط (تصفية حسب branchId)
- [x] اختبار النظام (144 اختبار ناجح)


## إصلاح صفحة الإيرادات (طلب جديد)
- [x] تغيير الإجمالي ليكون = النقدي + الشبكة (تم تغيير النص)
- [x] الموازنة تتسجل تلقائياً = الشبكة (موجود بالفعل)
- [x] منطق المطابقة صحيح (كاش + شبكة = إجمالي الموظفين)


## صلاحيات المشرفين (طلب جديد)
- [x] المشرف العام: مشاهدة جميع الصفحات (branchId = null)
- [x] مشرفي الفروع: الإيرادات لفرعهم فقط
- [x] مشرفي الفروع: المصاريف لفرعهم فقط
- [x] مشرفي الفروع: الطلبات لفرعهم فقط
- [x] مشرفي الفروع: المنتجات/المشتريات لفرعهم فقط
- [x] إنشاء حسابات مشرفي فرع لبن وطويق

**الحسابات المنشأة:**
- GeneralSupervisor / Supervisor123 (المشرف العام - كل الفروع)
- LabanSupervisor / Laban123 (مشرف فرع لبن)
- TuwaiqSupervisor / Tuwaiq123 (مشرف فرع طويق)


## ربط حسابات المشرفين الموجودة (طلب جديد)
- [x] البحث عن حسابات المشرفين الموجودة في قاعدة البيانات
- [x] ربط الحسابات الموجودة بالفروع الصحيحة (لبن وطويق)
- [x] حذف الحسابات الجديدة التي أنشأتها (LabanSupervisor, TuwaiqSupervisor)

**الحسابات الموجودة:**
- Laban (عبدالحي) → branchId: 1 (الرئيسي/لبن)
- Twiq (محمد) → branchId: 30001 (طويق - الرياض)


## فحص نظام الإشعارات والتذكيرات (طلب جديد)
- [ ] فحص نظام التذكيرات (Triggers) للإيرادات غير المسجلة
- [ ] التحقق من إعدادات الإيميلات والمستلمين
- [ ] فحص سجل الإشعارات المرسلة
- [x] إصلاح أي مشاكل في نظام التذكيرات
- [ ] إرسال رسائل ترحيبية احترافية لكل مستخدم حسب دوره وفرعه


## فحص نظام الإشعارات والتذكيرات (طلب جديد)
- [x] فحص نظام التذكيرات (Triggers) للإيرادات غير المسجلة
- [x] التحقق من إعدادات الإيميلات والمستلمين (4 مستلمين نشطين)
- [x] إنشاء نظام تذكير للإيرادات غير المسجلة (reminderService.ts)
- [x] إرسال رسائل ترحيبية احترافية لكل مستخدم (4 رسائل)
- [x] إرسال تذكيرات للفروع التي لم تسجل إيراد (فرع طويق - 3 تذكيرات)

**الرسائل المرسلة:**
- 4 رسائل ترحيبية (الأدمن، المشرف العام، مشرف طويق، مشرف لبن)
- 3 تذكيرات إيراد غير مسجل (فرع طويق - 2025-12-21)


## جدولة التذكيرات والتقارير الأسبوعية (طلب جديد)
- [x] إضافة جدولة التذكيرات اليومية (scripts/scheduledTasks.mjs daily-reminder)
- [x] إنشاء تقرير أسبوعي للمشرفين (ملخص إيرادات ومصاريف الأسبوع)
- [x] إرسال التقرير الأسبوعي لكل مشرف حسب فرعه (4 تقارير مرسلة)
- [x] اختبار النظام (144 اختبار ناجح)

**أوامر التشغيل:**
```bash
# تذكير يومي الساعة 10 صباحاً
node scripts/scheduledTasks.mjs daily-reminder

# تقرير أسبوعي كل يوم أحد
node scripts/scheduledTasks.mjs weekly-report
```

**Cron Jobs المقترحة:**
```
0 10 * * * node /path/to/scripts/scheduledTasks.mjs daily-reminder
0 8 * * 0 node /path/to/scripts/scheduledTasks.mjs weekly-report
```


## إعداد Cron Jobs على السيرفر (طلب جديد)
- [x] إنشاء سكريبت تشغيل مع متغيرات البيئة (run-scheduled-task.sh)
- [x] إنشاء نظام جدولة داخلي (taskScheduler.ts)
- [x] تشغيل تلقائي في بيئة الإنتاج
- [x] APIs للتحكم في الجدولة (system.startScheduler, system.stopScheduler, etc.)
- [x] اختبار النظام (144 اختبار ناجح)

**المواعيد المجدولة:**
- التذكير اليومي: 10 صباحاً (توقيت السعودية)
- التقرير الأسبوعي: الأحد 8 صباحاً (توقيت السعودية)

**APIs الجدولة:**
- `system.getSchedulerStatus` - الحصول على حالة الجدولة
- `system.startScheduler` - تشغيل نظام الجدولة
- `system.stopScheduler` - إيقاف نظام الجدولة
- `system.runDailyReminder` - تشغيل التذكير يدوياً
- `system.runWeeklyReport` - تشغيل التقرير يدوياً


## إصلاح مشاكل الإيرادات والصلاحيات (طلب جديد)
- [x] إصلاح منطق المطابقة - متطابقة تلقائياً عندما لا يوجد موظفين
- [x] إزالة النص التوضيحي "(نقدي + شبكة)" - الآن يعرض "الإجمالي" فقط
- [x] إزالة صفحة إدارة الطلبات من القائمة الجانبية لمشرفي الفروع (لبن وطويق)
- [x] اختبار النظام (144 اختبار ناجح)


## حذف الإيرادات/المصاريف وإصلاح البونص (طلب جديد)
- [x] إضافة إمكانية حذف الإيرادات للأدمن
- [x] إضافة إمكانية حذف المصاريف للأدمن
- [x] إصلاح صلاحيات صفحة البونص (غير مصرح لك بهذا الإجراء)
- [x] إصلاح المزامنة بين الإيرادات والبونص بشكل عميق


## تحسينات صلاحيات البونص وحذف الإيرادات (23 ديسمبر 2025)
- [x] تحديث صلاحيات البونص من managerProcedure إلى protectedProcedure
- [x] صفحة البونص متاحة لجميع المستخدمين (admin, manager, employee, supervisor, viewer)
- [x] سجل البونص متاح للجميع
- [x] طلب صرف البونص متاح للجميع
- [x] تزامن البونص متاح للجميع
- [x] إضافة زر حذف الإيرادات في السجل الشهري (للمسؤول فقط)
- [x] حوار تأكيد الحذف مع تحذير
- [x] تزامن البونص مع الأسبوع الحالي
- [x] إنشاء سكريبت تزامن البونص يدوياً (scripts/sync-bonus.mjs)
- [x] 144 اختبار ناجح
- [x] 0 أخطاء TypeScript


## تقرير PDF للبونص وإشعارات البريد (طلب جديد - 23 ديسمبر 2025)
- [x] إضافة تقرير PDF للبونص الأسبوعي
- [x] زر تصدير PDF في صفحة البونص
- [x] قالب PDF احترافي باللغة العربية
- [x] إشعار بريد إلكتروني تلقائي عند اكتمال حساب البونص
- [x] إرسال تقرير البونص للمشرفين عبر البريد


## إصلاح خطأ حساب الإجمالي في سجل الإيرادات (23 ديسمبر 2025)
- [x] إصلاح حساب الإجمالي ليكون الكاش + الشبكة (875 ر.س بدلاً من 25 ر.س)


## إصلاح عرض الإيراد الأسبوعي للموظفين في البونص (23 ديسمبر 2025)
- [x] إصلاح عرض الإيراد الأسبوعي لكل موظف (الآن يعرض الأسبوع الذي يحتوي على إيرادات)
- [x] تحديث البونص تلقائياً عند إدخال الإيرادات للأسبوع الصحيح


## نظام إشعارات البريد الإلكتروني المتقدم (24 ديسمبر 2025)
- [ ] مراجعة نظام الإشعارات الحالي
- [ ] إنشاء قوالب بريد إلكتروني رسمية ومتقدمة
- [ ] إشعارات طلبات الموظفين (إجازات، سلف، استقالات)
- [ ] إشعارات للأدمن عند وجود طلبات جديدة
- [ ] إشعارات للمشرف العام عند وجود طلبات
- [ ] إشعارات لمشرف الفرع عند وجود طلبات من موظفيه
- [ ] إشعارات البونص الأسبوعي
- [ ] إشعارات المصاريف المرتفعة
- [ ] إشعارات المشتريات الجديدة


## نظام إشعارات البريد الإلكتروني المتقدم (24 ديسمبر 2025)
- [x] إنشاء قوالب بريد إلكتروني رسمية ومتقدمة (8 قوالب)
- [x] تفعيل إشعارات طلبات الموظفين (إنشاء + تحديث حالة)
- [x] تفعيل إشعارات البونص (طلب صرف + تقرير أسبوعي)
- [x] تفعيل إشعارات المصاريف المرتفعة (>500 ر.س)
- [x] تفعيل إشعارات أوامر الشراء
- [x] تفعيل إشعارات عدم تطابق الإيرادات
- [x] إرسال الإشعارات للأدمن والمشرف العام ومشرف الفرع


## إضافة حذف أوامر الشراء للأدمن (24 ديسمبر 2025)
- [x] إضافة دالة حذف أوامر الشراء في الخادم (adminProcedure) - موجودة مسبقاً
- [x] إضافة زر الحذف في واجهة المستخدم للأدمن فقط


## سجل العمليات المحذوفة وتذكير المصاريف (24 ديسمبر 2025)
- [x] إضافة جدول سجل العمليات المحذوفة في قاعدة البيانات
- [x] تسجيل عمليات الحذف مع تفاصيل العنصر المحذوف
- [x] إرسال تذكير بمصاريف شهر 12 لمشرفي الفروع (طويق + لبن)

## لوحة التحكم التنفيذية (24 ديسمبر 2025)
- [x] لوحة تحكم تنفيذية شاملة مع تحليلات متقدمة (موجودة مسبقاً)
- [x] منح صلاحية المشاهدة للمشرف العام (admin + manager)
- [x] إرسال بريد رسمي للمشرف العام (Salemalwadai1997@gmail.com)


## جدولة التذكيرات والتقارير الشهرية التلقائية (24 ديسمبر 2025)
- [ ] إنشاء نظام التقارير الشهرية التلقائية مع دقة البيانات
- [ ] إنشاء قالب تقرير PDF شهري احترافي
- [ ] حساب مؤشرات الأداء المالي بدقة (إيرادات، مصاريف، أرباح)
- [ ] إنشاء نظام التذكيرات الشهرية التلقائية
- [x] إضافة API لتشغيل التقارير والتذكيرات
- [ ] إرسال التقرير للمشرف العام تلقائياً


## جدولة التذكيرات والتقارير الشهرية التلقائية (24 ديسمبر 2025)
- [x] إنشاء نظام التقارير الشهرية التلقائية مع دقة البيانات
- [x] إنشاء نظام التذكيرات الشهرية التلقائية
- [x] إضافة API لتشغيل التقارير والتذكيرات
- [x] التأكد من دقة حسابات الإيرادات والمصاريف والأرباح
- [x] قالب HTML احترافي للتقرير الشهري
- [x] مقارنة مع الشهر السابق
- [x] مؤشرات الأداء الرئيسية (KPIs)


## إصلاح لوحة التحكم التنفيذية ولوحة المبيعات (24 ديسمبر 2025)
- [x] إصلاح لوحة التحكم التنفيذية لعرض البيانات الفعلية
- [x] إضافة اختيار الفرع لرؤية أداء كل فرع على حدة
- [x] إضافة أداء الموظفين وإيراداتهم أولاً بأول
- [x] إصلاح لوحة المبيعات لعرض البيانات الفعلية
- [ ] ربط الإيرادات الفعلية من جدول dailyRevenues
- [ ] حساب الأرباح الصحيحة (الإيرادات - المصاريف)


## إصلاح لوحة التحكم التنفيذية ولوحة المبيعات - مكتمل (24 ديسمبر 2025)
- [x] إصلاح لوحة التحكم التنفيذية لعرض البيانات الفعلية من dailyRevenues
- [x] إضافة اختيار الفرع لرؤية أداء كل فرع على حدة
- [x] إضافة أداء الموظفين وإيراداتهم مع الترتيب والمتوسط اليومي
- [x] إصلاح لوحة المبيعات لعرض البيانات الفعلية
- [x] ربط الإيرادات الفعلية من جدول dailyRevenues
- [x] حساب الأرباح الصحيحة (الإيرادات - المصاريف)
- [x] إضافة مقارنة مع الفترة السابقة
- [x] إضافة رسم بياني للإيرادات اليومية
- [x] إضافة تفاصيل طرق الدفع (نقدي، شبكة، رصيد)


## إصلاح لوحات التحكم (طلب جديد - 24 ديسمبر 2025)
- [x] توحيد طريقة حساب الإيرادات في جميع اللوحات (استخدام حقل total بدلاً من كاش + شبكة + رصيد)
- [x] إصلاح لوحة التحكم الرئيسية لعرض البيانات الفعلية
- [x] إصلاح لوحة التحكم التنفيذية
- [x] إصلاح لوحة المبيعات
- [x] إصلاح الرسم البياني للإيرادات اليومية (getDailyRevenuesForChart)
- [x] إصلاح عرض آخر الفواتير في لوحة التحكم
- [x] جميع الاختبارات ناجحة (144 اختبار)


## إرسال بريد إلكتروني للموظفين (طلب جديد - 24 ديسمبر 2025)
- [x] جلب قائمة الموظفين وبياناتهم
- [x] كتابة رسالة بريد احترافية تتضمن:
  - شرح لوحة المبيعات ولوحة التحكم التنفيذية
  - تفعيل مراقب النظام Symbol AI
  - طلب الإبلاغ عن البيانات غير الدقيقة
  - إعلان عن قرب إطلاق صفحة الفواتير
- [x] إرسال البريد لجميع الموظفين (5 مستخدمين - نجح 100%)


## مراجعة حساب الإيرادات وصلاحيات المشرف (طلب جديد - 24 ديسمبر 2025)
- [x] التأكد من أن الإيرادات = كاش + شبكة في:
  - [x] لوحة التحكم التنفيذية (تستخدم حقل total)
  - [x] لوحة المبيعات (تستخدم حقل total)
  - [x] صفحة التقارير (تستخدم حقل total)
- [x] مراجعة صفحة البونص:
  - [x] التأكد من دقة حساب عمل كل موظف (متطابق 100%)
  - [x] التأكد من دقة حساب الأيام (متطابق 100%)
- [x] إعطاء صلاحيات للمشرف العام (supervisorViewProcedure):
  - [x] الوصول للوحة التحكم التنفيذية (kpis, dailyChart, compare, employeesPerformance)
  - [x] الوصول للوحة المبيعات (topProducts, topCustomers, dailySales, salesByCategory)
  - [x] الوصول لمؤشرات الأداء KPIs (calculate, history, trends, abcReport)
- [x] جميع الاختبارات ناجحة (144 اختبار)


## تعديل صفحة الفواتير (طلب جديد - 25 ديسمبر 2025)
- [ ] مراجعة صفحة الفواتير الحالية وقاعدة البيانات
- [x] إضافة نوع فاتورة سالب على الموظف:
  - [ ] حقل الموظف
  - [ ] حقل المبلغ
  - [ ] حقل رقم جوال العميل
- [x] إضافة نوع فاتورة مبيعات (تحسب كإيراد)
- [ ] تقييد الحذف للأدمن فقط
- [ ] اختبار الفواتير الجديدة


## صلاحيات المشرف العام لإدارة الطلبات (طلب جديد - 25 ديسمبر 2025)
- [x] مراجعة صلاحيات إدارة الطلبات الحالية
- [x] إعطاء صلاحية الرفض والقبول للمشرف العام (viewer)
- [x] إرسال إشعار للمشرف العام بالصلاحيات الجديدة (Salemalwadai1997@gmail.com)


## تحسين المخزون المتقدم وتذكيرات الجرد (طلب جديد - 25 ديسمبر 2025)
- [ ] مراجعة وفهم صفحة المخزون المتقدم الحالية
- [x] تحسين وتطوير الصفحة (واجهة المستخدم والوظائف)
- [x] إضافة تذكيرات الجرد الشهرية (يوم 12 و 27)
- [ ] اختبار التحسينات


## تحسين المخزون المتقدم وتذكيرات الجرد (طلب جديد - 25 ديسمبر 2025)
- [x] فهم عميق لصفحة المخزون المتقدم
- [x] تحسين وتطوير الصفحة:
  - [x] إضافة نظرة عامة شاملة
  - [x] تحسين واجهة المستخدم
  - [x] إضافة إحصائيات الجرد
  - [x] إضافة جدول الجرد الدوري
- [x] إضافة تذكيرات الجرد:
  - [x] يوم 12 من كل شهر (جرد منتصف الشهر)
  - [x] يوم 27 من كل شهر (جرد نهاية الشهر)
  - [x] تذكير قبل 3 أيام ويوم واحد ويوم الجرد
  - [x] إرسال بريد إلكتروني للأدمن والمشرف العام
  - [x] جدولة cron job للتذكيرات التلقائية
- [x] جميع الاختبارات ناجحة (144 اختبار)


## نظام الجرد الكامل (طلب جديد - 25 ديسمبر 2025)

### 1. نموذج تسجيل الجرد الفعلي
- [x] إضافة جدول تفاصيل الجرد (inventoryCountDetails)
- [ ] إنشاء نموذج إدخال الجرد الفعلي
- [ ] إمكانية إدخال الكمية الفعلية لكل منتج
- [ ] حفظ تاريخ ووقت الجرد
- [ ] تسجيل اسم الموظف الذي قام بالجرد

### 2. تقرير فروقات الجرد
- [ ] حساب الفرق بين الكمية النظرية والفعلية
- [ ] عرض المنتجات ذات الفروقات
- [x] إضافة حقل سبب الفرق
- [ ] تصنيف الفروقات (زيادة/نقص)
- [ ] تصدير التقرير PDF

### 3. ربط الجرد بالمنتجات
- [x] تحديث كميات المخزون بعد اعتماد الجرد
- [ ] سجل تدقيق لتغييرات المخزون
- [ ] إشعار عند وجود فروقات كبيرة


## نظام الجرد الكامل (طلب جديد - 25 ديسمبر 2025)
- [x] نموذج تسجيل الجرد الفعلي:
  - [x] بدء جرد جديد مع تحميل المنتجات
  - [x] تسجيل الكميات الفعلية لكل منتج
  - [x] حساب الفروقات تلقائياً
  - [x] إضافة أسباب الفروقات
  - [x] شريط تقدم الجرد
- [x] تقرير فروقات الجرد:
  - [x] ملخص الفروقات (نقص/زيادة/متطابق)
  - [x] قيمة الفروقات بالريال
  - [x] تصدير التقرير CSV
  - [x] تصفية حسب النوع
- [x] ربط الجرد بالمنتجات لتحديث الكميات:
  - [x] تحديث كميات المنتجات عند اعتماد الجرد
  - [x] تسجيل التغييرات في سجل التدقيق
- [x] جميع الاختبارات ناجحة (144 اختبار)


## تصدير تقرير الجرد PDF (طلب جديد - 25 ديسمبر 2025)
- [x] مراجعة صفحة تقرير فروقات الجرد الحالية
- [x] إضافة تصدير PDF باستخدام jsPDF + jspdf-autotable
- [x] تحديث الواجهة لإضافة زر "تصدير PDF" بجانب "تصدير CSV"
- [x] جميع الاختبارات ناجحة (144 اختبار)


## إنشاء مستخدم السيد محمد ومراجعة المخزون (طلب جديد - 25 ديسمبر 2025)
- [x] مراجعة عميقة للمخزون الذكي والجرد
- [x] إنشاء مستخدم جديد:
  - [x] الاسم: السيد محمد
  - [x] اسم المستخدم: moh123
  - [x] كلمة المرور: admin1234
  - [x] البريد: elsayed.gouda.mohamed@gmail.com
  - [x] الفرع: لبن (ID: 1)
- [x] تعيين الصلاحيات:
  - [x] مشرف المخزون والجرد (inventory, inventoryCounts, batches)
  - [x] طلبات المنتجات (products, productRequests, reorderSuggestions)
  - [x] فواتير المبيعات (employeeInvoices)
- [x] تفعيل استلام الإشعارات وتذكيرات الجرد (أضيف لقائمة المستلمين)
- [x] إرسال رسالة ترحيب احترافية (معرف الرسالة: 93de5af9-615a-44e7-8d54-88dc4958b064)


## إصلاح صفحة المشتريات (طلب جديد - 25 ديسمبر 2025)
- [x] مراجعة صفحة المشتريات الحالية
- [x] إصلاح التنسيق واللاي اوت (الحجم كبير جداً)
- [x] إصلاح مشكلة عدم إمكانية إضافة منتج
- [x] اختبار الإصلاحات


## إصلاح صفحة المشتريات - حقل السعر (25 ديسمبر 2025)
- [x] جعل السعر يُجلب تلقائياً من سعر التكلفة في المنتج
- [x] إصلاح مشكلة اختفاء حقل السعر عند اختيار منتج باسم طويل
- [x] اختبار الإصلاحات


## إصلاح التصميم المتجاوب للمشتريات - الجوال (25 ديسمبر 2025)
- [x] إصلاح عرض حقول الكمية والسعر على شاشات الجوال
- [x] جعل الحقول تظهر في صفوف منفصلة على الشاشات الصغيرة
- [x] اختبار الإصلاحات


## تحسين قوالب PDF (25 ديسمبر 2025)
- [x] فحص الصفحات التي تدعم تصدير PDF
- [x] إضافة شعار البرنامج لجميع قوالب PDF
- [x] تحسين تنسيق الجداول والعناوين
- [x] توحيد التصميم عبر جميع القوالب
- [x] اختبار التصدير


## تحسين قوالب PDF (25 ديسمبر 2025)
- [x] فحص الصفحات التي تدعم تصدير PDF
- [x] إضافة شعار البرنامج لجميع قوالب PDF
- [x] تحسين تنسيق الجداول والعناوين
- [x] توحيد التصميم عبر جميع القوالب
- [x] اختبار التصدير


## تحسين قوالب PDF (25 ديسمبر 2025)
- [x] فحص الصفحات التي تدعم تصدير PDF
- [x] إضافة شعار البرنامج لجميع قوالب PDF
- [x] تحسين تنسيق الجداول والعناوين
- [x] توحيد التصميم عبر جميع القوالب
- [x] اختبار التصدير

## إعادة تصميم نظام مسيرات الرواتب (طلب جديد)
- [x] تحليل النظام الحالي وفهم الهيكل
- [x] تحديث schema لإضافة الحقول الجديدة (الراتب الأساسي، الساعات الإضافية، أيام العمل، الخصومات، الحوافز، السلف)
- [ ] تطوير نموذج إنشاء المسيرة مع قائمة الموظفين التابعين للفرع
- [x] إضافة منطق الحسابات التلقائية
- [x] تطوير نظام الموافقات (تحت الإجراء → موافقة)
- [ ] تصدير PDF احترافي بعد الموافقة
- [x] اختبار النظام بالكامل

## إشعارات تلقائية للجرد ومسيرات الرواتب (طلب المستخدم)
- [x] إشعار الجرد يوم 12 و 29 من كل شهر (السيد، مشرف طويق، الأدمن)
- [x] إشعار مسيرات الرواتب يوم 29 من كل شهر (جميع المستخدمين)
- [x] اختبار الإشعارات

## إعادة تصميم القائمة الجانبية (طلب المستخدم)
- [x] تحليل القائمة الحالية
- [x] إنشاء هيكل التصنيفات الرئيسية والفرعية
- [x] المعاملات المالية: الإيرادات، المصاريف، البونص، مسيرات الرواتب
- [x] المخزون: المنتجات، المشتريات، الجرد الفعلي، جرد الفروقات، الفئات
- [x] الطلبات: تقديم طلب، إدارة الطلبات، طلبات البونص
- [x] المبيعات: فواتير الموظفين، الفواتير، العملاء
- [x] المتابعة: لوحة التحكم التنفيذية، الأرباح والخسائر، لوحة المبيعات، التقارير
- [x] حذف صفحة إرسال إشعار
- [x] اختبار القائمة الجديدة

## إصلاح مسيرات الرواتب (طلب المستخدم)
- [x] فحص مشكلة عدم حفظ المسيرة عند الإرسال للمراجعة
- [x] إضافة عرض حالة الطلب (تحت الإجراء، معتمد، مرفوض)
- [x] إضافة زر الحذف للأدمن
- [x] اختبار الإصلاحات

## إصلاح طباعة مسيرات الرواتب (طلب المستخدم)
- [x] فحص مشكلة الطباعة وتحديد السبب
- [x] إصلاح المشكلة
- [x] اختبار الطباعة

## نظام المهام المتقدم (طلب جديد)
- [ ] تصميم جدول المهام في قاعدة البيانات
- [ ] إنشاء الـ API والدوال الخلفية
- [ ] إنشاء صفحة البحث عن المهام بالرقم المرجعي
- [ ] إنشاء لوحة إدارة المهام للمشرفين
- [ ] ربط نظام الإشعارات بالبريد الإلكتروني
- [x] اختبار النظام

## تحسينات نظام المهام (طلب المستخدم)
- [x] إشعار المشرف عند استجابة الموظف للمهمة
- [x] تقرير المهام المتأخرة (التي تجاوزت تاريخ الاستحقاق)
- [x] إرفاق ملفات عند إنشاء المهمة
- [x] اختبار التحسينات

## نظام معالجة الأخطاء المتقدم (طلب المستخدم)
- [x] NotificationException - استثناء فشل الإشعارات
- [x] TemplateException - استثناء أخطاء القوالب
- [x] SMTPException - استثناء أخطاء البريد الإلكتروني SMTP
- [x] StorageException - استثناء أخطاء التخزين S3
- [x] RateLimitException - استثناء تجاوز حد الطلبات
- [x] TimeoutException - استثناء انتهاء المهلة
- [x] تحسين GlobalExceptionHandler لدعم جميع الاستثناءات
- [x] تطبيق الاستثناءات في الكود الموجود
- [x] كتابة اختبارات للاستثناءات الجديدة

## إصلاح مشكلة الإشعارات المتكررة (طلب عاجل)
- [x] فحص نظام الإشعارات المجدولة (الجرد ومسيرات الرواتب)
- [x] تحديد سبب إرسال الإشعارات أكثر من 7 مرات (عدة مصادر ترسل نفس الإشعار)
- [x] إضافة آلية منع التكرار (notificationTracker.ts)
- [x] تحديث taskScheduler.ts لاستخدام نظام التتبع
- [x] تحديث advancedNotificationService.ts لاستخدام نظام التتبع
- [x] اختبار الإصلاح (197 اختبار ناجح)


## إصلاح جذري لمشكلة الإشعارات المتكررة (طلب عاجل - المرحلة 2)

### المرحلة 1: تحليل عميق لمصادر الإشعارات
- [x] فحص جميع الملفات التي ترسل إشعارات الجرد
- [x] فحص جميع الملفات التي ترسل إشعارات الرواتب
- [x] تحديد نقاط الاستدعاء المتكررة
- [x] رسم خريطة تدفق الإشعارات

### المرحلة 2: إنشاء نظام مركزي موحد
- [x] إنشاء ملف واحد للتحكم في جميع الإشعارات المجدولة (scheduledNotificationService.ts)
- [x] استخدام قاعدة البيانات بدلاً من الملفات للتتبع (sentNotifications table)
- [x] إضافة قفل (Lock) لمنع التنفيذ المتزامن (sendingLocks Map)
- [x] إضافة تسجيل مفصل لكل عملية إرسال (console.log مع timestamps)

### المرحلة 3: تعطيل المصادر المتكررة
- [x] تعطيل/حذف الإرسال من taskScheduler.ts (يستخدم النظام الموحد الآن)
- [x] تعطيل/حذف الإرسال من inventoryReminder.ts (لا يُستدعى مباشرة)
- [x] تعطيل/حذف الإرسال من advancedNotificationService.ts (يستخدم النظام الموحد)
- [x] تعطيل/حذف الإرسال من systemMonitor.ts (يستخدم النظام الموحد)
- [x] توحيد جميع الإرسال في مكان واحد (scheduledNotificationService.ts)

### المرحلة 4: سجل تدقيق في قاعدة البيانات
- [x] استخدام جدول sentNotifications الموجود
- [x] تسجيل كل إشعار مرسل مع التفاصيل (logNotificationSent)
- [x] إضافة فحص قبل الإرسال من قاعدة البيانات (wasNotificationSentTodayDB)
- [x] إضافة API لعرض سجل الإشعارات (getScheduledStatus, getTodaySentNotifications)

### المرحلة 5: الاختبار والتحقق
- [x] اختبار أن الإشعار يُرسل مرة واحدة فقط (209 اختبار ناجح)
- [x] اختبار عدم التكرار عند إعادة تشغيل السيرفر (التتبع في قاعدة البيانات)
- [x] اختبار عدم التكرار عند استدعاء API متعدد (Lock mechanism)


## تحسين تنسيق صفحة إدارة المهام للموبايل (طلب المستخدم)
- [x] تحسين تنسيق بطاقات الإحصائيات (2 بطاقات للموبايل، 3 للتابلت، 5 للديسكتوب)
- [x] تحسين تنسيق زر "مهمة جديدة" والعنوان (عرض عمودي للموبايل)
- [x] تحسين تنسيق التبويبات (عرض كامل للموبايل)
- [x] تحسين تنسيق الفلاتر وحقل البحث (عرض عمودي للموبايل)
- [x] تحسين تنسيق الجدول (بطاقات للموبايل، جدول للديسكتوب)
- [x] تحسين تنسيق قسم المهام المتأخرة للموبايل
- [x] اختبار التنسيق على أحجام شاشات مختلفة


## إصلاح نهائي لمشكلة تكرار الإشعارات (طلب عاجل - المرة الثالثة)
- [x] تحليل سبب إرسال إشعار الرواتب في 5:14 AM و 7:12 AM و 7:20 AM
- [x] فحص جميع نقاط استدعاء sendPayrollReminder
- [x] فحص نظام التتبع في قاعدة البيانات (sentNotifications)
- [x] التحقق من أن scheduledNotificationService يعمل بشكل صحيح
- [x] تعطيل جميع المصادر المتكررة نهائياً
- [x] اختبار الإصلاح (217 اختبار ناجح)

### الإصلاحات الجذرية المنفذة:
1. تتبع مزدوج: في الذاكرة + قاعدة البيانات
2. تسجيل فوري في الذاكرة قبل الإرسال
3. إزالة الفحص الفوري عند بدء السيرفر
4. قفل صارم مع انتهاء صلاحية (5 دقائق)
5. استخدام [SCHEDULED:type] في subject للبحث الدقيق


## فحص عميق لنظام الإشع## فحص عميق لنظام الإشعارات (طلب المستخدم)
- [x] فحص جميع ملفات الإشعارات ونقاط الإرسال (8 ملفات، 27 نقطة إرسال)
- [x] فحص نظام التتبع في الذاكرة وقاعدة البيانات
- [x] فحص نظام Rate Limit والقفل (6 محددات مختلفة)
- [x] فحص قاعدة البيانات للإشعارات المرسلة (7 إشعارات اليوم)
- [x] إصلاح ثغرة البحث عن الإشعارات القديمة
- [x] تقديم تقرير شامل (217 اختبار ناجح)

### الثغرة المكتشفة والإصلاح:
- النظام كان يبحث عن [SCHEDULED:type] فقط
- الإشعارات القديمة لا تحتوي على هذا التنسيق
- الإصلاح: إضافة بحث عن "تذكير الرواتب" و "تذكير الجرد" في subject


## إصلاح خطأ تسجيل الدخول للموظف (طلب عاجل)
- [x] تحليل خطأ NotFoundError: removeChild
- [x] فحص كود تسجيل الدخول وصفحة الموظف
- [x] إصلاح الخطأ (مكون Sonner كان يستورد useTheme من next-themes بدلاً من ThemeContext)
- [x] اختبار الإصلاح (تسجيل الدخول يعمل بنجاح)


## إعطاء صلاحيات المخزون للسيد محمد (طلب المستخدم)
- [x] فحص صلاحيات المستخدم الحالية (لديه صلاحيات المخزون بالفعل)
- [x] تحديد صلاحيات المخزون والصفحات الفرعية
- [x] إضافة supervisor لصفحات: تقرير فروقات الجرد، الفئات
- [x] اختبار الصلاحيات (تم التحقق - جميع صفحات المخزون تظهر للسيد محمد)


## إصلاح صفحة الجرد الفعلي للموظف السيد (طلب عاجل)
- [ ] فحص صفحة الجرد الفعلي وتحديد المشكلة
- [x] إصلاح المشكلة في الكود
- [ ] اختبار الإصلاح


## إصلاح مشاكل الواجهة والترجمة التلقائية (طلب عاجل)

### مشكلة الترجمة التلقائية للمتصفح
- [x] إضافة lang="ar" و dir="rtl" في HTML
- [x] إضافة translate="no" للعناصر المهمة
- [x] إضافة meta tag لمنع الترجمة التلقائية

### خطأ NotFoundError في صفحة المشتريات
- [x] تحليل سبب الخطأ في نموذج إنشاء أمر الشراء (مرتبط بالترجمة التلقائية)
- [x] إصلاح مشكلة removeChild في React DOM (تم حلها بمنع الترجمة)
- [x] اختبار إنشاء أمر شراء جديد (تم بنجاح)


## إضافة تقارير PDF للمشتريات والجرد

### تقرير المشتريات PDF
- [ ] إنشاء API لتوليد تقرير المشتريات
- [ ] تصميم قالب PDF للمشتريات (شعار، معلومات الشركة، تفاصيل الطلب)
- [x] إضافة زر طباعة/تحميل PDF في صفحة المشتريات

### تقرير الجرد PDF
- [ ] إنشاء API لتوليد تقرير الجرد
- [ ] تصميم قالب PDF للجرد (ملخص، فروقات، تفاصيل المنتجات)
- [x] إضافة زر طباعة/تحميل PDF في صفحة الجرد


## إصلاح مشكلة اعتماد وتحديث الجرد (طلب عاجل)

- [x] تحليل API الجرد (update, approve, complete)
- [ ] فحص صلاحيات المشرف للموافقة على الجرد
- [ ] فحص واجهة المستخدم لأزرار الاعتماد
- [x] إصلاح المشاكل المكتشفة
- [ ] اختبار شامل للجرد



## إصلاح صلاحيات المستخدم السيد محمد (طلب عاجل)
- [x] تحليل صلاحيات المستخدم الحالية
- [x] إصلاح صلاحيات جرد المنتجات (updateItem)
- [x] إصلاح صلاحيات المشتريات
- [ ] اختبار الصلاحيات


## إصلاح واجهة الجرد للموبايل (طلب عاجل)
- [x] إعادة تصميم الواجهة لتكون متجاوبة
- [x] إضافة زر جرد واضح لكل منتج
- [x] إضافة أزرار الاعتماد والإلغاء والطباعة
- [x] استخدام بطاقات بدلاً من الجدول
- [x] تحسين عرض الإحصائيات على الشاشات الصغيرة


## إضافة صلاحيات مسيرات الرواتب للمشرفين (طلب جديد)
- [x] تحديث صلاحيات مشرف لبن (Laban) لإنشاء مسيرات الرواتب
- [x] تحديث صلاحيات مشرف طويق (Twiq) لإنشاء مسيرات الرواتب
- [x] تحديث API مسيرات الرواتب للسماح للمشرفين
- [x] اختبار الصلاحيات الجديدة


## تحسينات مسيرات الرواتب (طلب جديد)
- [x] إشعار بريدي للأدمن عند إنشاء مسيرة رواتب جديدة من المشرف
- [x] تقييد اعتماد المسيرات للأدمن فقط (المشرف يمكنه الإنشاء فقط)
- [x] اختبار الميزات الجديدة


## إضافة رابط مسيرات الرواتب للقائمة الجانبية للمشرفين (طلب عاجل)
- [x] إضافة رابط مسيرات الرواتب في القائمة الجانبية للمشرفين
- [ ] التأكد من ظهور الرابط للأدوار المناسبة (admin, manager, supervisor)


## إضافة رابط مسيرات الرواتب للقائمة الجانبية للمشرفين
- [x] إضافة رابط مسيرات الرواتب في قسم المعاملات المالية للمشرفين


## إضافة طباعة قسيمة الراتب الفردية (طلب جديد)
- [x] إنشاء مكون قسيمة الراتب القابلة للطباعة
- [x] إضافة زر طباعة لكل موظف في تفاصيل المسيرة
- [x] تصميم قسيمة احترافية بشعار الشركة


## إشعار الموظفين بالراتب عبر البريد الإلكتروني (طلب جديد)
- [x] إنشاء قالب بريد إلكتروني احترافي لقسيمة الراتب
- [x] إضافة دالة إرسال إشعار الراتب للموظفين
- [x] دمج الإشعار التلقائي عند اعتماد مسيرة الرواتب
- [x] اختبار الإشعارات


## إضافة تقرير المصاريف الشهري مع فلتر الفرع (طلب جديد)
- [x] إضافة فلتر اختيار الفرع في صفحة المصاريف
- [x] إضافة زر طباعة تقرير المصاريف الشهري
- [x] إنشاء تقرير PDF احترافي للمصاريف (من 1 إلى آخر الشهر)
- [x] منع تداخل المصاريف بين الفروع


## تقارير PDF احترافية للإيرادات ولوحة التحكم التنفيذية (طلب جديد)

### تقرير الإيرادات PDF
- [x] تحليل صفحة الإيرادات والبيانات المتاحة
- [ ] تصميم تقرير شامل يتضمن: إجمالي الإيرادات، تفصيل حسب الفرع، تفصيل حسب النوع
- [x] إضافة رسوم بيانية للإيرادات (حسب الفرع، حسب اليوم)
- [x] إضافة فلتر الفترة الزمنية والفرع
- [ ] زر طباعة التقرير

### تقرير لوحة التحكم التنفيذية PDF
- [x] تحليل لوحة التحكم التنفيذية والبيانات المتاحة
- [ ] تصميم تقرير تنفيذي شامل يتضمن: ملخص الأداء، المبيعات، المصاريف، الأرباح
- [x] إضافة مؤشرات الأداء الرئيسية (KPIs)
- [x] إضافة مقارنة مع الفترة السابقة
- [ ] زر طباعة التقرير التنفيذي


## تقارير PDF المتقدمة للوحات التحكم (طلب جديد)
- [x] تقرير PDF للوحة التحكم التنفيذية (Executive Dashboard)
  - [x] ملخص مؤشرات الأداء (KPIs)
  - [x] صافي الربح وهامش الربح
  - [x] تفاصيل الإيرادات (نقدي/شبكة/رصيد)
  - [x] أداء الموظفين
  - [x] مقارنة مع الفترة السابقة
- [x] تقرير PDF للوحة الإيرادات (Revenue Dashboard)
  - [x] ملخص الإيرادات الشهرية
  - [x] توزيع الإيرادات حسب الفرع
  - [x] أداء الموظفين حسب الإيرادات
  - [x] مقارنة مع الفترات السابقة


## تحديث صفحة الجرد الفعلي (طلب جديد)
- [x] تغيير "النظرية" إلى "المطلوب شهرياً"
- [x] جعل القيمة الافتراضية للمطلوب شهرياً = 10
- [x] إضافة إمكانية تعديل "المطلوب شهرياً"
- [x] إضافة صلاحية تعديل اسم المنتج للموظف السيد والأدمن


## تحسين قوالب PDF الرسمية (طلب جديد)
- [x] توحيد الألوان بنمط رسمي (أزرق داكن موحد)
- [x] إضافة الشعار (Logo) في الهيدر
- [x] إضافة ختم الإدارة للمستندات المعتمدة
- [x] إضافة توقيع المشرف العام: سالم الوادعي
- [x] إضافة توقيع المدير: عمر المطيري
- [x] إضافة حالة "معتمد" للطلبات المعتمدة
- [x] تحسين الخط ليكون واضح ورسمي
- [x] تطبيق التصميم على جميع القوالب


## فحص شامل للنظام واقتراحات متقدمة (طلب جديد)
- [x] تحليل البنية الحالية للنظام (Architecture Review)
- [ ] فحص الأمان (Security Audit)
- [ ] فحص الأداء (Performance Analysis)
- [x] تحليل تجربة المستخدم (UX Analysis)
- [ ] فحص قاعدة البيانات (Database Review)
- [ ] فحص الـ API والـ tRPC procedures
- [x] تحليل جودة الكود (Code Quality)
- [ ] اقتراحات متقدمة للتحسين


## فحص شامل للنظام واقتراحات متقدمة (طلب جديد - مكتمل)
- [x] تحليل البنية الحالية للنظام (50 جدول، tRPC + React + TypeScript)
- [x] فحص الأمان والأداء (PBKDF2، Rate Limiting، 5 مستويات صلاحيات)
- [x] تحليل تجربة المستخدم والواجهة (RTL، تصميم متجاوب)
- [x] فحص قاعدة البيانات والـ API (Drizzle ORM، MySQL/TiDB)
- [x] إعداد تقرير شامل بالاقتراحات (ERP_ANALYSIS_REPORT.md)


## تحسين وتوحيد قوالب PDF (طلب جديد)
- [x] توحيد الألوان والخطوط في جميع القوالب
- [x] تحسين تصميم الهيدر مع الشعار
- [x] تحسين عرض التوقيعات (المشرف العام + المدير)
- [x] تحسين عرض الختم
- [x] توحيد التذييل مع معلومات الشركة
- [x] تطبيق التصميم على جميع القوالب


## إصلاح لوحات التحكم والتقارير (طلب جديد)
- [ ] مراجعة وإصلاح الأرقام في لوحة التحكم التنفيذية
- [ ] مراجعة وإصلاح الأرقام في لوحة المبيعات
- [ ] مراجعة وإصلاح الأرقام في التقارير
- [x] إضافة تصدير PDF احترافي للوحة التحكم التنفيذية
- [x] إضافة تصدير PDF احترافي للوحة المبيعات
- [x] إضافة الختم وتوقيع سالم وعمر في التقارير


## إصلاح لوحات التحكم والتقارير (طلب جديد)
- [x] إصلاح الأرقام والإحصائيات في لوحة التحكم التنفيذية
- [x] إصلاح الأرقام والإحصائيات في لوحة المبيعات
- [x] إضافة تصدير PDF احترافي مع الختم والتوقيعات
- [x] استبعاد "النظام" من قائمة أداء الموظفين


## التحقق من صحة الإحصائيات (طلب جديد)
- [x] فحص الإيرادات في قاعدة البيانات
- [x] مقارنة حقل total مع cash + network
- [x] إصلاح حساب الإيرادات ليستخدم cash + network
- [x] إصلاح getDashboardStats
- [x] إصلاح getActualRevenues
- [x] إصلاح getDailyRevenuesByDateRange


## صلاحيات الموظف السيد وتكبير التوقيعات (طلب جديد)
- [x] إضافة صلاحية إنشاء المنتجات للموظف السيد (supervisor)
- [x] تكبير التوقيعات في قوالب PDF


## تحسين تصميم قوالب PDF (طلب جديد)
- [x] توحيد الألوان باللون الأسود للمحتوى والأرقام
- [x] تكبير التوقيعات (سالم وعمر) أكثر من الحجم الحالي
- [x] تحسين وضوح الخط وتناسق الحجم
- [x] إزالة الألوان المختلفة واستخدام تصميم موحد


## إصلاح مسيرة الرواتب وقسيمة الراتب (طلب جديد)
- [x] إصلاح عرض أسماء الموظفين في مسيرة الرواتب
- [x] تحسين تصميم قسيمة الراتب
- [ ] تكبير التوقيعات في قسيمة الراتب
- [ ] توحيد الألوان والتصميم

## إصلاح قوالب PDF - طلب المستخدم (31 ديسمبر 2025)
- [x] تحديث pdfTemplates.ts - الأنماط الأساسية الموحدة
- [ ] تكبير الأرقام وجعلها بلون أسود واضح
- [ ] توحيد ألوان الجداول (أسود/رمادي)
- [x] إصلاح مسيرة الرواتب الكاملة - أسماء الموظفين
- [x] إصلاح قسيمة الراتب الفردية - التوقيعات
- [x] إصلاح تقرير لوحة التحكم التنفيذية
- [x] إصلاح تقرير لوحة المبيعات
- [x] إصلاح تقارير المخزون والجرد
- [ ] اختبار جميع القوالب

## إصلاح قوالب PDF - طلب المستخدم (31 ديسمبر 2024)
- [x] تحديث ملف pdfTemplates.ts الرئيسي بالأنماط الموحدة
- [x] تحديث قالب مسيرة الرواتب الكاملة - ألوان وأرقام أكبر
- [x] تحديث قسيمة الراتب الفردية - أرقام أكبر بلون أسود
- [x] تحديث لوحة التحكم التنفيذية - توحيد ألوان البطاقات والجداول
- [x] تحديث لوحة المبيعات - تحديث أنماط الجداول والأرقام
- [x] تحديث تقرير فروقات الجرد - ألوان الفروقات
- [x] تحديث تقرير البونص - الألوان والأنماط
- [x] تحديث تقرير الإيرادات - ألوان الحالات
- [x] تحديث تقرير المصاريف - تحديث شامل للتصميم

## إصلاح مشكلة عدم تطبيق تحديثات PDF (31 ديسمبر 2024)
- [ ] التحقق من ملف pdfTemplates.ts
- [ ] إعادة تطبيق التحديثات على جميع القوالب
- [ ] اختبار التقارير في المتصفح

## تحديثات قوالب PDF - الجولة الثانية (31 ديسمبر 2024)
- [x] تحديث لوحة التحكم التنفيذية - أرقام 32px بلون أسود
- [x] تحديث مسيرة الرواتب - أرقام 22px في المعلومات، 16px في الجدول
- [x] تحديث قسيمة الراتب - أرقام 20px، صافي الراتب 38px
- [x] تحديث لوحة المبيعات - أرقام 32px، جدول 16px

## إضافة الرواتب إلى لوحة التحكم التنفيذية (31 ديسمبر 2024)
- [x] تحديث الباكند لجلب بيانات آخر مسيرة رواتب
- [x] تحديث لوحة التحكم التنفيذية لعرض الرواتب والربح الحقيقي
- [x] تحديث قالب PDF للوحة التنفيذية

## إصلاح خطأ إضافة المنتج وصلاحيات المشرف
- [x] إصلاح خطأ sellingPrice فارغ عند إضافة منتج
- [x] إعطاء صلاحية للمشرف العام لإضافة المنتجات

## إصلاح تسجيل دخول السيد محمد
- [x] التحقق من وجود حساب السيد محمد في قاعدة البيانات
- [x] إصلاح أو إنشاء الحساب

## فحص شامل لنظام ERP
- [x] تحليل البنية التقنية (قاعدة البيانات، API، الواجهات)
- [x] فحص الوظائف الأساسية (المبيعات، المخزون، الموظفين، المالية)
- [x] اختبار الأمان والصلاحيات
- [x] تحليل تجربة المستخدم
- [ ] إعداد تقرير النواقص والاقتراحات

## نظام ولاء العملاء - طلب جديد
- [ ] إنشاء جدول العملاء (loyaltyCustomers)
- [ ] إنشاء جدول الزيارات (loyaltyVisits)
- [ ] إنشاء API للتسجيل الجديد
- [ ] إنشاء API لتسجيل الزيارة
- [ ] صفحة الولاء مع باركود QR
- [ ] صفحة تسجيل العميل الجديد
- [ ] صفحة تسجيل الزيارة
- [ ] نظام الخصم (50% للزيارة الرابعة)
- [ ] إشعارات البريد الإلكتروني للمشرفين

## منع تكرار الزيارات اليومية
- [x] منع تسجيل زيارتين لنفس الشخص/رقم الجوال في نفس اليوم

## إضافة خدمة جديدة
- [x] إضافة خيار "حلاقة رأس + شعر" إلى قائمة الخدمات

## إعدادات نظام الولاء (طلب جديد)
- [x] إنشاء جدول إعدادات الولاء في قاعدة البيانات
- [x] إنشاء APIs لإدارة إعدادات الولاء
- [x] إنشاء صفحة إعدادات نظام الولاء في إعدادات النظام
- [x] ربط صفحات التسجيل والزيارة بالإعدادات من قاعدة البيانات


## تحسينات نظام الولاء (طلب جديد)
- [x] إضافة حقل صورة الفاتورة في جدول الزيارات
- [x] إجبارية رفع صورة الفاتورة عند تسجيل الزيارة
- [x] تقييد المشرفين لرؤية عملاء ولاء فرعهم فقط
- [x] إضافة خاصية قبول/رفض الزيارات من المشرفين

## تصدير فاتورة المشتريات (طلب جديد)
- [x] دراسة هيكل صفحة المشتريات وبيانات أوامر الشراء
- [x] تصميم قالب فاتورة مشتريات احترافي
- [x] إنشاء مكون تصدير الفاتورة (PDF/طباعة)
- [x] ربط زر التصدير بصفحة المشتريات

## تحديث للنشر
- [x] جاهز للنشر

## تحسين تصميم فاتورة المشتريات (طلب جديد)
- [x] تحسين التنسيق والحجم والألوان
- [x] جعل التصميم أكثر احترافية

## إضافة الشعار والختم والتوقيعات للفاتورة (طلب جديد)
- [x] إضافة شعار الشركة
- [x] إضافة الختم
- [x] إضافة توقيع سالم (المدير العام)
- [x] إضافة توقيع عمر (مسؤول المشتريات)

## تعديل التوقيعات في الفاتورة (طلب جديد)
- [x] تعديل سالم الوادعي: المشرف العام
- [x] تعديل عمر المطيري: المدير
- [x] تكبير حجم التوقيعات (120px)

## إصلاح مشكلة رفع صورة الفاتورة (طلب جديد)
- [x] فحص كود رفع الصورة في صفحة الولاء
- [x] إصلاح مشكلة فشل رفع الصورة (استخدام tRPC بدلاً من fetch مباشر)

## تعديل التقاط صورة الفاتورة (طلب جديد)
- [x] إزالة خيار رفع الصورة من الاستديو
- [x] جعل التقاط الصورة من الكاميرا مباشرة فقط (capture="environment")

## تحسين نافذة إنشاء أمر الشراء (طلب جديد)
- [x] جعل النافذة قابلة للتمرير عند إضافة منتجات كثيرة (max-h-[90vh] + overflow-y-auto)
- [x] تثبيت أزرار الإنشاء والإلغاء في الأسفل (shrink-0 + border-t)

## إعطاء صلاحيات للموظف السيد (طلب جديد)
- [x] البحث عن الموظف السيد في قاعدة البيانات (فرع لبن)
- [x] إعطاء صلاحيات تعديل المنتجات (view, create, edit)

## تعديل صلاحيات تعديل المنتجات (طلب جديد)
- [x] تعديل products.update ليتحقق من صلاحيات المستخدم المخصصة
- [x] السماح للمشرفين بتعديل المنتجات إذا كان لديهم صلاحية products.edit في permissions

## إصلاح مشكلة رفع الصورة في نظام الولاء - إصلاح عميق (طلب جديد)
- [x] فحص كود رفع الصورة في LoyaltyVisit.tsx
- [x] فحص API uploadInvoiceImage في routers.ts
- [x] إضافة ضغط الصورة قبل الرفع
- [x] تحسين معالجة الأخطاء في السيرفر
- [x] إضافة سجلات لتتبع المشاكل

## إصلاح جذري لمشكلة رفع صورة الفاتورة (طلب جديد - مستمر)
- [x] تحليل عميق للمشكلة وفحص السجلات
- [ ] فحص storage.ts والتأكد من صحة الاتصال
- [x] إصلاح جذري للمشكلة


## إصلاح نهائي لمشكلة رفع صورة الفاتورة في الولاء (طلب جديد)
- [x] تحليل عميق للمشكلة
- [x] اختبار رفع الصور من السيرفر (يعمل)
- [x] اختبار من المتصفح (يعمل)
- [x] تحسين ضغط الصورة (800px, 60% quality)
- [x] إضافة شريط تقدم أثناء الرفع
- [x] إضافة رسائل خطأ واضحة
- [x] إضافة خيار اختيار صورة من المعرض كبديل


## إصلاح جذري لمشكلة رفع صورة الفاتورة في نظام الولاء (مكتمل)

### تحليل المشكلة
- [x] فحص سجلات السيرفر والمتصفح
- [x] اختبار API رفع الصور مباشرة
- [x] التحقق من وجود جداول قاعدة البيانات

### إصلاحات قاعدة البيانات
- [x] إنشاء جداول الولاء (loyaltyCustomers, loyaltyVisits, loyaltySettings, loyaltyServiceTypes)
- [x] إضافة عميل اختباري للتحقق

### اختبار شامل
- [x] اختبار رفع صورة صغيرة (نجح)
- [x] اختبار رفع صورة كبيرة 500KB (نجح - 1.5 ثانية)
- [x] اختبار تسجيل زيارة كاملة مع صورة (نجح)
- [x] التحقق من ظهور شاشة النجاح

### النتيجة
- [x] **رفع الصور يعمل بنجاح** ✅
- [x] **تسجيل الزيارات يعمل بنجاح** ✅


## إصلاح مشكلة رفع الصورة في صفحة التسجيل/الانضمام لبرنامج الولاء (جديد)
- [ ] فحص صفحة التسجيل وتحديد سبب فشل رفع الصورة
- [x] إصلاح كود رفع الصورة في صفحة التسجيل
- [ ] اختبار الحل والتحقق من عمله


## إصلاح مشكلة رفع الصورة في صفحة التسجيل لبرنامج الولاء (مكتمل)
- [x] تحديث صفحة LoyaltyRegister باستخدام نفس طريقة رفع الصورة الناجحة في LoyaltyVisit
- [x] إضافة ضغط الصورة قبل الرفع
- [x] إضافة شريط تقدم أثناء الرفع
- [x] إضافة رسائل خطأ واضحة
- [x] اختبار التسجيل الكامل مع رفع الصورة


## تعديل نظام الولاء (طلب جديد)

### تغيير نظام الخصم
- [x] تغيير من كل 4 زيارات إلى كل 3 زيارات
- [x] الزيارة الثالثة بخصم 60% (بدلاً من 50% في الرابعة)
- [x] تحديث الرسائل والنصوص في الواجهة

### تحديث الخدمات
- [x] حلاقة رأس ودقن
- [x] حلاقة + خدمة
- [x] عرض الفرع

### جعل الفرع إجباري
- [x] تعديل صفحة التسجيل لجعل الفرع إجباري
- [x] تعديل صفحة تسجيل الزيارة لجعل الفرع إجباري
- [x] إضافة رسالة تحقق للفرع


## تقرير إحصائي لبرنامج الولاء

### API التقارير
- [x] إنشاء API لإحصائيات العملاء المسجلين
- [x] إنشاء API لإحصائيات الزيارات الشهرية
- [x] إنشاء API لإحصائيات الخصومات المستخدمة
- [x] إنشاء API لإحصائيات كل فرع

### صفحة التقرير
- [x] إنشاء صفحة تقرير الولاء
- [x] عرض إجمالي العملاء المسجلين
- [x] عرض الزيارات الشهرية مع رسم بياني
- [x] عرض الخصومات المستخدمة
- [x] عرض إحصائيات كل فرع
- [x] إضافة فلترة حسب الفرع


## تحسين تقرير برنامج الولاء

### فلترة الفترات الزمنية
- [x] إضافة فلتر أسبوع
- [x] إضافة فلتر شهر
- [x] إضافة فلتر ربع سنة
- [x] إضافة فلتر سنة

### إحصائيات محسنة
- [x] عرض نسبة التغيير عن الفترة السابقة
- [x] عرض عدد أيام التسجيل
- [x] إحصائيات دقيقة للعملاء والزيارات والخصومات

### واجهة المستخدم
- [x] إضافة زر طباعة التقرير
- [x] تحسين تصميم البطاقات الإحصائية
- [x] إضافة ألوان للتغييرات (أخضر للزيادة، أحمر للنقصان)


## صلاحيات المشرفين في برنامج الولاء

### تعديل API
- [ ] فلترة العملاء حسب فرع المشرف
- [ ] فلترة الزيارات حسب فرع المشرف
- [ ] فلترة التقارير حسب فرع المشرف
- [ ] السماح للأدمن برؤية جميع الفروع

### تعديل الواجهة
- [ ] إخفاء فلتر الفروع للمشرفين (يرون فرعهم فقط)
- [ ] عرض اسم الفرع في العنوان للمشرفين
- [ ] تعديل صفحة التسجيل لاستخدام فرع المشرف تلقائياً
- [ ] تعديل صفحة تسجيل الزيارة لاستخدام فرع المشرف تلقائياً


## صلاحيات المشرفين في برنامج الولاء

### تعديل API
- [ ] فلترة العملاء حسب فرع المشرف
- [ ] فلترة الزيارات حسب فرع المشرف
- [ ] فلترة التقارير حسب فرع المشرف
- [x] إضافة API قبول الزيارة
- [x] إضافة API رفض الزيارة
- [ ] السماح للأدمن برؤية جميع الفروع

### تعديل الواجهة
- [ ] إخفاء فلتر الفروع للمشرفين (يرون فرعهم فقط)
- [ ] عرض اسم الفرع في العنوان للمشرفين
- [x] إضافة أزرار قبول/رفض للزيارات المعلقة
- [ ] تعديل صفحة التسجيل لاستخدام فرع المشرف تلقائياً
- [ ] تعديل صفحة تسجيل الزيارة لاستخدام فرع المشرف تلقائياً


## صلاحيات المشرفين في برنامج الولاء (مكتمل)

### رؤية بيانات الفرع فقط
- [x] تعديل API لفلترة العملاء حسب فرع المشرف
- [x] تعديل API لفلترة الزيارات حسب فرع المشرف
- [x] تعديل API لفلترة التقارير حسب فرع المشرف

### صلاحية القبول والرفض
- [x] أزرار الموافقة والرفض للمشرفين
- [x] تعديل API الموافقة للتحقق من صلاحية الفرع
- [x] تعديل API الرفض للتحقق من صلاحية الفرع

### واجهة المستخدم
- [x] إخفاء فلتر الفروع للمشرفين في التقارير
- [x] عرض اسم الفرع كشارة للمشرفين
- [x] تحديث النصوص التوضيحية للمشرفين


## فحص وإصلاح نظام البونص الأسبوعي

### المشاكل المكتشفة:
- [ ] نظام الأسابيع غير صحيح: الأسابيع ليست 7 أيام بالضبط (الأسبوع 2: 8 أيام، الأسبوع 3: 7-8 أيام متغيرة)
- [ ] تطابق الإيرادات: معظم البيانات متطابقة بين الفرع والموظفين ✅ (لكن بعض الفروقات الصغيرة)
- [ ] موظفين بدون أسماء في بعض السجلات (NULL)
- [ ] إيرادات غير منطقية: بعض الموظفين لديهم إيرادات عالية جداً (23,330 ر.س أسبوعياً)

### الإصلاحات المطلوبة:
- [ ] تصحيح حساب الأسابيع ليكون كل 7 أيام بالضبط (1-7، 8-14، 15-21، 22-28، 29-آخر الشهر)
- [ ] التحقق من بيانات الموظفين والإيرادات غير المنطقية
- [x] إصلاح سجلات الموظفين بدون أسماء
- [ ] التحقق من تطابق الإيرادات بشكل كامل


## الدوال الذكية المتقدمة (طلب جديد)

### المرحلة 1: الأساسيات
- [x] إنشاء ملف intelligent_functions.ts
- [x] تنفيذ detectRevenueAnomalies()
- [x] تنفيذ generateProactiveAlerts()
- [x] إضافة endpoints في routers.ts للدوال الذكية
- [x] إضافة قسم "التنبيهات الذكية" في لوحة التحكم
- [ ] ربط التنبيهات بجرس الإشعارات

### المرحلة 2: التحليلات
- [ ] تنفيذ detectFraudPatterns()
- [ ] تنفيذ detectPerformancePatterns()
- [ ] تنفيذ analyzeAndPredict()
- [x] إضافة صفحة "تقرير الامتثال"
- [x] إضافة عمود "نمط الأداء" في صفحة الموظفين
- [x] إضافة قسم "التوقعات" في لوحة التحكم

### المرحلة 3: التوصيات
- [ ] تنفيذ generateSmartRecommendations()
- [ ] تنفيذ analyzeWorkflowBottlenecks()
- [ ] تنفيذ optimizeStaffDistribution()
- [x] إضافة قسم "التوصيات الذكية" في لوحة التحكم
- [x] إضافة صفحة "تحليل الأداء"

### المرحلة 4: الأتمتة
- [ ] تنفيذ executeSmartRules()
- [ ] تنفيذ executeAutoCorrection()
- [ ] تنفيذ executeFullWorkflow()
- [x] إضافة صفحة "إعدادات القواعد الذكية"
- [ ] ربط القواعد بطلبات البونص
- [x] إضافة سجل تنفيذ القواعد


## الدوال الذكية المتقدمة (طلب جديد)

### المرحلة الأولى: الأساسيات
- [x] إنشاء ملف intelligent_functions.ts
- [x] تنفيذ detectRevenueAnomalies() - كشف الشذوذ بـ Z-Score
- [x] تنفيذ generateProactiveAlerts() - التنبيهات الاستباقية
- [x] تنفيذ checkDataIntegrity() - فحص سلامة البيانات
- [x] إضافة endpoints في routers.ts للدوال الذكية
- [x] إضافة واجهة التنبيهات الذكية في لوحة التحكم
- [x] إضافة رابط في القائمة الجانبية

### المرحلة الثانية: التحليلات (قادم)
- [ ] تنفيذ detectFraudPatterns() - كشف التلاعب
- [ ] تنفيذ detectPerformancePatterns() - أنماط الأداء
- [ ] تنفيذ analyzeAndPredict() - التنبؤ بالإيرادات

### المرحلة الثالثة: التوصيات (قادم)
- [x] تنفيذ generateSmartRecommendations() - التوصيات الذكية
- [ ] تنفيذ analyzeWorkflowBottlenecks() - تحليل الاختناقات
- [ ] تنفيذ optimizeStaffDistribution() - توزيع الموظفين

### المرحلة الرابعة: الأتمتة (قادم)
- [ ] تنفيذ executeSmartRules() - القواعد الذكية
- [ ] تنفيذ executeAutoCorrection() - التصحيح التلقائي
- [ ] تنفيذ executeFullWorkflow() - سير العمل الكامل


## إصلاح مشكلة تزامن البونص (طلب جديد)
- [x] فحص دالة حساب الإيرادات الأسبوعية
- [x] التحقق من أن البيانات تُجلب للأسبوع الحالي فقط
- [x] إصلاح المشكلة وضمان التزامن الصحيح


## إصلاح مشكلة تزامن البونص (طلب جديد)
- [x] فحص دالة حساب الإيرادات الأسبوعية
- [x] التحقق من أن البيانات تُجلب للأسبوع الحالي فقط
- [x] إصلاح المشكلة وضمان التزامن الصحيح
- [x] إعادة تزامن البونص للأسبوع الحالي بالإيرادات الصحيحة
- [x] إنشاء سكريبت resync-bonus.mjs لإعادة التزامن اليدوي

## تحسينات نظام البونص (طلب جديد)

### تنبيه تلقائي عند وجود فرق في البونص
- [x] إنشاء دالة للكشف عن الفروقات بين الإيرادات والبونص
- [x] إرسال إشعار بريد إلكتروني للمشرفين عند وجود فرق
- [x] عرض تنبيه في صفحة البونص عند وجود فرق

### سجل تدقيق البونص
- [x] تفعيل جدول bonusAuditLog الموجود
- [x] تسجيل كل تغيير في البونص (الإنشاء، التحديث، التزامن)
- [x] عرض سجل التدقيق في صفحة البونص
- [x] إضافة فلترة حسب التاريخ والموظف

## إشعارات داخلية للفروقات (طلب جديد)

### عرض تنبيهات الفروقات في لوحة التحكم
- [x] إنشاء endpoint للحصول على الفروقات غير المعالجة
- [x] إضافة بطاقة تنبيه في لوحة التحكم الرئيسية
- [x] عرض عدد الفروقات وتفاصيلها
- [x] رابط مباشر لصفحة البونص للمعالجة

## تحسينات إضافية للفروقات (طلب جديد)

### 1. إشعار منبثق عند تسجيل الدخول
- [x] إضافة toast notification عند تسجيل الدخول إذا وجدت فروقات
- [x] عرض عدد الفروقات ورابط للمعالجة

### 2. تقرير أسبوعي تلقائي بالبريد
- [x] إنشاء دالة لإرسال تقرير أسبوعي بحالة البونص
- [x] تضمين ملخص الفروقات في التقرير
- [x] جدولة الإرسال أسبوعياً (زر يدوي متاح)

### 3. لوحة إحصائيات الفروقات
- [x] إضافة رسم بياني لتاريخ الفروقات
- [x] عرض تطور الفروقات عبر الأسابيع
- [x] مقارنة بين الفروع


## إصلاح مشكلة الفروقات (بلاغ مستخدم)
- [x] إصلاح ظهور فروقات عندما يكون الفرق = 0 (الإيرادات متطابقة)


## تحسين الواجهات والتنسيق (طلب جديد)

### تحسين الاستجابة للموبايل
- [x] إضافة hook useIsMobile للكشف عن الموبايل
- [x] تحسين لوحة التحكم للموبايل (بطاقات متجاوبة)
- [x] تحسين الجداول للموبايل (تمرير أفقي أو بطاقات)
- [x] تحسين النماذج للموبايل (حقول كاملة العرض)
- [x] تحسين القائمة الجانبية للموبايل

### تحسين التنسيق العام
- [x] تحسين المسافات والهوامش
- [x] تحسين أحجام الخطوط
- [x] تحسين الأزرار والأيقونات
- [x] تحسين البطاقات والحاويات


## تحسينات إضافية للموبايل (طلب جديد)
- [x] إنشاء مكون زر العودة للأعلى (ScrollToTop)
- [x] إنشاء مكون الجدول/البطاقات المتجاوب (ResponsiveTable)
- [x] تطبيق المكونات على الصفحات الرئيسية


## إصلاح صفحة البونص الأسبوعي (بلاغ مستخدم)
- [x] إصلاح الأزرار المقطوعة (تصدير، تزامن) على الموبايل
- [x] تحسين تنسيق الصفحة للموبايل


## إصلاح استجابة الصفحات للموبايل (بلاغ مستخدم)
- [x] إصلاح صفحة فواتير الموظفين للموبايل
- [x] فحص وإصلاح جميع الصفحات الأخرى


## فلتر الفترة الزمنية في مسيرات الرواتب (طلب جديد)
- [x] إضافة فلتر التاريخ من-إلى في صفحة مسيرات الرواتب

- [x] تحديث البطاقات الإحصائية لتعكس الفترة المفلترة


## فلتر الفترات في لوحة التحكم التنفيذية (طلب جديد)
- [x] إضافة فلتر الفترات الزمنية (من - إلى) في لوحة التحكم التنفيذية
- [x] تحديث الإحصائيات لتعكس الفترة المفلترة


## إصلاح إعدادات الولاء (بلاغ مستخدم)
- [x] إصلاح مشكلة عدم إمكانية تعديل وحفظ إعدادات الولاء
- [x] إضافة سجل تغييرات إعدادات الولاء لتتبع من قام بالتعديل ومتى

## المرحلة الأولى - تحسينات نظام الإشعارات
- [x] إنشاء نظام Queue للإشعارات (NotificationQueue)
- [x] إضافة Retry Logic مع تأخير تصاعدي
- [x] توحيد دوال الإرسال في دالة مركزية
- [x] إضافة تتبع حالة الإشعارات في Queue

## المرحلة الثانية - تحسينات نظام الجدولة
- [x] استبدال setInterval بـ node-cron
- [x] إنشاء Dashboard للمهام المجدولة في واجهة المستخدم
- [x] إضافة Dead Letter Queue للمهام الفاشلة
- [x] إضافة سجل تنفيذ المهام (في الذاكرة)

## تحسينات الصفحات الرئيسية (طلب جديد)
- [x] التحقق من التاريخ المكرر في الإيرادات قبل الحفظ (موجود مسبقاً)
- [x] إضافة نظام إرفاق المستندات للمصاريف
- [ ] السماح للأدمن بتعديل حدود ومبالغ مستويات البونص
- [ ] تتبع صرف البونص (تاريخ الصرف الفعلي وطريقة الدفع)
- [x] خصم السلف تلقائياً في مسيرات الرواتب

## عرض السلف في صفحة المصاريف (طلب جديد)
- [x] عرض السلف المأخوذة في صفحة المصاريف
- [x] تصدير السلف إلى Excel/PDF
- [x] فلترة السلف حسب الفترة الزمنية
- [x] إصلاح مشكلة عدم التمرير في نموذج إضافة المصروف على الموبايل

## تحسين التمبلتس والقوالب
- [x] تحسين قالب تقرير السلف (تصميم احترافي، شعار، ألوان)
- [x] تحسين قالب تقرير المصاريف (رسوم بيانية، تخطيط محسّن)
- [x] تحسين قالب تقرير الرواتب (جداول منظمة، إحصائيات)
- [x] إضافة رسوم بيانية للتقارير (مخططات بيانية)
- [ ] توحيد الهوية البصرية في جميع التقارير

## إصلاح وتحسين نظام المراقبة والتدقيق (مرحلة جديدة)
- [x] إصلاح معالجة الاستثناءات الشاملة في systemMonitor.ts
- [x] إصلاح أخطاء Division by Zero في analysisEngine.ts
- [x] إضافة Retry Logic للإشعارات
- [x] إضافة آلية لمنع التنبيهات المكررة
- [x] تحسين نظام كشف الشذوذ بمعايرة أفضل
- [x] تحسين نظام المطابقة الآلية
- [x] إضافة Dashboard للمراقبة
- [x] إضافة تقرير المطابقة اليومي
- [x] إضافة آلية للتصعيد التلقائي
- [ ] اختبار شامل للنظام

## إضافة صفحة الولاء للمشرفين (مرحلة جديدة)
- [x] إضافة صفحة الولاء للمشرفين في القائمة الجانبية
- [x] تحديث صلاحيات برنامج الولاء ليشمل المشاهدين (viewer)
- [x] اختبار الصلاحيات والتأكد من ظهور الصفحة

## إضافة صلاحيات القبول والرفض للمشرفين في الولاء (مرحلة جديدة)
- [x] تحديث APIs لصلاحيات القبول والرفض (supervisor, viewer)
- [x] تحديث واجهة المستخدم لعرض أزرار القبول والرفض
- [x] اختبار الصلاحيات والتأكد من عمل الأزرار

## إصلاح منطق برنامج الولاء (3 زيارات بخصم 60%)
- [x] تحديث منطق حساب الخصم: من 4 زيارات إلى 3 زيارات
- [x] تحديث نسبة الخصم: من 50% إلى 60%
- [x] تحديث الواجهة الأمامية لعرض الرسالة الصحيحة
- [x] اختبار برنامج الولاء (التسجيل والزيارات)

## صفحة سند القبض (مرحلة جديدة)
- [x] إنشاء جدول receiptVouchers في قاعدة البيانات
- [x] إنشاء جدول receiptVoucherItems للبنود
- [x] بناء واجهة سند القبض مع الحسابات التلقائية
- [x] إضافة ختم البرنامج (Symbol AI)
- [x] إضافة توقيعات (سالم الوادعي، عمر المطيري)
- [x] إضافة وظائف الطباعة والحفظ
- [x] اختبار شامل للصفحة

## إضافة تقارير وإرسال البريد لسندات القبض
- [x] إنشاء صفحة تقارير سندات القبض مع التصفية المتقدمة
- [x] إضافة وظيفة إرسال السند عبر البريد (مشرف الفرع + المشرف العام + الأدمن + المدفوع له)
- [x] إضافة زر "إرسال عبر البريد" في صفحة معاينة السند
- [x] إضافة زر "عرض التقرير" في القائمة الجانبية
- [x] اختبار الإرسال والتقارير

## تعديل صفحة سند القبض (المواصفات الجديدة)
- [x] تحديث نموذج قاعدة البيانات: البند ثابت، إضافة حقول المبلغ والمصروف
- [x] تاريخ السند: تلقائي (تاريخ الإنشاء)
- [x] تاريخ الاستحقاق: نطاق (من - إلى)
- [x] البند: ثابت "تسليم مبالغ كاش"
- [x] المبلغ المصروف: إدخال يدوي
- [x] الكاش المسلم: تلقائي (المبلغ - المصروف)
- [x] المستقبل: قائمة منسدلة (عمر المطيري، سالم الوادعي، اغراض محل)
- [x] مشرف الفرع: تلقائي من بيانات المستخدم
- [x] إعادة تصميم الواجهة الأمامية
- [x] تحديث المعاينة والطباعة

## تحسين قالب سند القبض (مطابقة الصورة)
- [x] تحسين رأس السند مع اسم البرنامج والرقم
- [x] تحسين جدول البيانات مع الوصف والمبلغ
- [x] تحسين قسم التوقيعات مع الختم
- [x] إضافة معلومات الإنشاء في الأسفل

## تعديل فترة الاستحقاق (من - إلى)
- [x] تعديل نموذج الإنشاء لإضافة حقلي "من" و"إلى"
- [x] تحديث معاينة السند لعرض فترة الاستحقاق بشكل صحيح
- [x] اختبار وحفظ checkpoint

## تحسينات صفحة سند القبض (مرحلة جديدة)
- [x] إنشاء ختم "الدرة" كصورة SVG
- [x] إنشاء توقيع عمر المطيري كصورة SVG
- [x] إنشاء توقيع سالم الوادعي كصورة SVG
- [x] تحسين تصميم الصفحة للموبايل (responsive design)
- [x] دمج السند في قائمة المعاملات المالية الموجودة
- [x] إزالة قائمة المعاملات المالية المكررة

## تقارير سندات القبض والتحسينات (مرحلة جديدة)
- [x] إنشاء صفحة تقارير سندات القبض الشاملة
- [x] إضافة فلاتر الفترات الزمنية (يومي، أسبوعي، شهري)
- [x] إضافة إحصائيات: عدد السندات، إجمالي المبالغ
- [x] إضافة زر تصدير Excel و PDF
- [x] إضافة جدول تفصيلي مع البحث والفرز
- [x] تحديث لوحة التحكم التنفيذية بإحصائيات السندات
- [x] عرض عدد السندات المستلمة في الفترة
- [x] عرض إجمالي المبالغ المستلمة (الكاش)
- [x] حساب الكاش المتبقي = إجمالي الكاش - إجمالي السندات
- [x] تصفية البيانات حسب الفترة الزمنية
- [x] تحسين قوالب PDF بإضافة التوقيعات والختم
- [x] التحقق من دقة جميع الحسابات


## تحسينات سندات القبض (مرحلة جديدة)
- [x] إضافة خيار حذف السند للأدمن فقط
- [x] إضافة فلتر الفرع في صفحة تقارير السندات
- [ ] اختبار وحفظ checkpoint

## إصلاح مشاكل سندات القبض
- [x] إصلاح عدم ظهور السندات في التقارير (فلتر التاريخ)
- [x] إضافة الفرع التلقائي عند اختيار المشرف
- [ ] اختبار وحفظ checkpoint
- [x] إصلاح خطأ Invalid time value في صفحة تقارير السندات
- [x] إصلاح زر تصدير PDF في صفحة تقارير السندات
- [x] إنشاء تقرير PDF احترافي حقيقي لتقارير السندات (ليس صفحة ويب)

## نظام التحليلات والتقارير المتقدمة (خطة جديدة)

### لوحة تحكم BI المتقدمة
- [ ] إنشاء هيكل ملفات لوحة BI
- [ ] تطوير API endpoints للتحليلات
- [ ] إنشاء مكونات UI الأساسية (KPICard, ChartContainer)
- [ ] لوحة الملخص التنفيذي (Executive Overview)
- [ ] لوحة المبيعات التفاعلية
- [ ] لوحة المخزون مع تحليل ABC
- [ ] لوحة المالية مع قائمة الدخل
- [ ] نظام الفلاتر (DateRangePicker, BranchSelector)
- [ ] تخصيص لوحة التحكم (Drag & Drop)

### منشئ التقارير المخصصة
- [ ] إنشاء جداول قاعدة البيانات (saved_reports, report_schedules)
- [ ] تطوير Query Builder
- [ ] واجهة سحب وإفلات لبناء التقارير
- [ ] لوحة الفلاتر والتجميع
- [ ] معاينة النتائج
- [ ] حفظ واسترجاع التقارير
- [ ] تصدير PDF/Excel
- [ ] جدولة التقارير وإرسالها بالبريد

### تحليلات الذكاء الاصطناعي
- [ ] خدمة التنبؤ بالمبيعات (Sales Forecasting)
- [ ] تحليل سلوك العملاء (RFM Analysis)
- [ ] الكشف عن الشذوذ (Anomaly Detection)
- [ ] توصيات المخزون الذكية
- [ ] توصيات التسويق
- [ ] توصيات التسعير
- [ ] واجهة الرؤى الذكية (AI Insights Dashboard)
- [ ] نظام الإشعارات الذكية

## تحليلات BI والذكاء الاصطناعي (قيد التنفيذ)
- [x] إنشاء خدمة تحليلات BI (analyticsService.ts)
- [x] إنشاء خدمة تحليلات AI (aiAnalyticsService.ts)
- [x] إضافة API endpoints للتحليلات
- [x] إنشاء صفحة لوحة BI المتقدمة
- [x] إنشاء منشئ التقارير المخصصة
- [ ] إضافة التنبؤ بالمبيعات
- [ ] إضافة تحليل شرائح العملاء (RFM)

- [x] إصلاح أخطاء استعلامات SQL في لوحة BI المتقدمة - تعديل لاستخدام dailyRevenues بدلاً من invoices
- [x] إصلاح طباعة السندات لتكون PDF احترافية بدلاً من لقطة شاشة
- [x] تعديل صفحة الولاء لتكون متاحة للمشرفين حسب فرعهم مع خاصية القبول/الرفض
- [x] تحسين قسم التوقيعات والختم في سند القبض PDF بحجم أكبر وأوضح
- [x] إضافة صفحة الولاء للمشرفين في القائمة الجانبية


## إصلاح خطأ AI Analytics
- [x] إصلاح خطأ Invalid time value في صفحة /ai-analytics


## مراجعة نظام تطابق الإيرادات والبونص
- [x] فحص بنية جداول الإيرادات والبونص
- [x] تحليل كود حساب الفروقات
- [x] فحص البيانات الفعلية والتحقق من الدقة
- [x] إعداد تقرير بالنتائج


## تحسينات نظام البونص
- [x] إصلاح حساب الأسبوع 5 (يوم أو يومين حسب الشهر)
- [x] إضافة تزامن تلقائي عند إضافة إيرادات جديدة
- [x] إضافة تنبيهات استباقية عند اكتشاف فروقات

## إصلاح عدد أيام العمل
- [ ] إصلاح تناقض عدد أيام العمل بين لوحة التحكم (5 أيام) وصفحة البونص (4 أيام) للفترة 1-1-2026 إلى 6-1-2026

## تحديث تحليلات AI (طلب جديد)
- [ ] تحديث صفحة تحليلات AI لتكون مبنية على الإيرادات الفعلية
- [ ] إضافة تحليل المصاريف
- [ ] إضافة تحليل أداء الموظفين
- [ ] استخدام خوارزميات رياضية وإحصائية دقيقة
- [ ] التحليل بناءً على البيانات التاريخية

## تحديث تحليلات AI (طلب جديد)
- [x] تحديث تحليلات AI لتكون مبنية على الإيرادات والمصاريف وأداء الموظفين بخوارزميات رياضية دقيقة
- [x] إضافة خدمة revenueAnalyticsService.ts للتحليلات المتقدمة
- [x] تبويب نظرة عامة مع ملخص التحليل الذكي
- [x] تبويب الإيرادات مع رسوم بيانية وتحليلات
- [x] تبويب المصاريف مع توزيع حسب الفئة
- [x] تبويب أداء الموظفين مع ترتيب ودرجات الأداء
- [x] تبويب التنبؤات مع خوارزمية الانحدار الخطي


## إصلاح مشاكل التحليلات والمصاريف (طلب جديد)
- [ ] إصلاح احتساب المصاريف في لوحة التحكم لتشمل جميع الحالات (وليس فقط مدفوع/معتمد)
- [ ] تصحيح حساب المتوسط في تحليلات AI ليكون بناءً على الشهر الماضي كاملاً ÷ عدد أيام الشهر
- [ ] إصلاح لوحة BI التي تظهر توقف تام خاطئ رغم وجود بيانات


- [x] إصلاح احتساب المصاريف لتشمل جميع الحالات (وليس فقط approved)
- [x] تصحيح حساب المتوسط في تحليلات AI ليكون بناءً على أيام الفترة الفعلية
- [x] إصلاح لوحة BI لتستخدم dailyRevenues بدلاً من invoices


## إعادة بناء نظام التنبؤ المالي (طلب جديد)
- [ ] إضافة حقل تكلفة البضاعة % في الإعدادات
- [ ] إضافة حقل التكاليف الثابتة الشهرية في الإعدادات
- [ ] تبسيط دالة التنبؤ لتظهر: الإيرادات | التكاليف | صافي الربح
- [ ] إضافة حساب نقطة التعادل
- [ ] عرض صافي الربح/الخسارة (بالأحمر إذا خسارة)
- [ ] عرض نقطة التعادل اليومية



## تحديث نظام التنبؤ المالي بالبيانات الحقيقية (طلب جديد)
- [x] إضافة التكاليف الثابتة الحقيقية (32,200 ر.س للفرعين، 16,100 لكل فرع)
- [ ] تفصيل التكاليف: رواتب 21,000 + إيجارات محلات 6,600 + سكن 3,200 + كهرباء 800 + إنترنت 600
- [ ] إضافة حقل تكلفة البضاعة % (افتراضي 30%، الحد 1-80%)
- [x] تعديل معادلة التنبؤ لتشمل التكاليف الثابتة والمتغيرة
- [ ] حساب نقطة التعادل (شهرية ويومية)
- [x] عرض تفاصيل كاملة: الإيرادات، التكاليف الثابتة، تكلفة البضاعة، صافي الربح
- [ ] جلب المصاريف الأخرى من النظام تلقائياً
- [ ] تلوين الخسارة بالأحمر والربح بالأخضر
- [ ] حساب لكل فرع على حدة


## إصلاح التناقض في تحليلات AI (طلب جديد)
- [ ] تحليل مصدر التناقض بين التنبؤات والتحليل الذكي
- [ ] توحيد مصدر البيانات للتحليل
- [ ] إصلاح ملخص التحليل الذكي ليتوافق مع الأرقام الفعلية
- [ ] التحقق من صحة الحسابات في جميع الأقسام


## تصحيح نظام التحليل المالي (6 يناير 2026 - تحديث 2)
- [x] تحديث التكاليف الثابتة: 17,700 ر.س لكل فرع (إيجار محل 3300 + إيجار سكن 1700 + رواتب 12000 + كهرباء 400 + إنترنت 300)
- [x] تعديل حساب الربحية = التكاليف الثابتة + المصاريف المسجلة
- [x] فصل الحسابات لكل فرع على حدة
- [x] اختبار والتحقق من صحة الحسابات


## مراجعة المصاريف وتحليل الفروع (6 يناير 2026)
- [ ] فحص المصاريف المسجلة وتحديد المكرر مع التكاليف الثابتة
- [ ] إضافة تحليل كل فرع على حدة في صفحة التحليلات
- [ ] اختبار والتحقق من النتائج


## مراجعة المصاريف وتحليل الفروع (6 يناير 2026)
- [x] فحص المصاريف المسجلة وتحديد المكرر مع التكاليف الثابتة
- [x] استبعاد الفئات المكررة (إيجار سكن، إيجار محل، كهرباء، إنترنت)
- [x] إضافة تحليل كل فرع على حدة في صفحة التحليلات
- [x] اختبار والتحقق من النتائج


## تحسينات نظام التحليلات (7 يناير 2026)
- [x] إضافة تقرير مقارنة شهري لأداء الفروع
- [x] تحسين برومبت تحليلات AI
- [x] مراجعة وتحسين صفحة BI المتقدمة


## تحسينات صفحة المصاريف (7 يناير 2026)
- [x] جعل صورة الفاتورة المرفقة قابلة للعرض عند النقر عليها


## تعديل مستويات البونص (7 يناير 2026)
- [x] تعديل مستويات البونص: 1450=35, 1750=55, 1950=65, 2200=90, 2500=120, 2800=155, 3200=190

- [x] إصلاح حساب البونص ليستخدم المستويات الجديدة وإعادة تزامن البيانات


## إشعارات لوحة المراقبة (7 يناير 2026)
- [x] إضافة إشعار فوري بالبريد عند اكتشاف شذوذ (انحراف إيرادات، قيم شاذة، أنماط غير عادية)


## تحسينات لوحة المراقبة والمصاريف (7 يناير 2026)
- [x] ربط لوحة المراقبة ببيانات الشذوذ الحقيقية من API بدلاً من البيانات التجريبية
- [x] إصلاح حساب المصاريف ليحسب فقط المصاريف المعتمدة والمدفوعة


## إصلاح وتحسين صفحة تحليلات AI (7 يناير 2026)

### إصلاح احتساب الأشهر
- [ ] استبعاد الأشهر التي لا تحتوي على إيرادات من الحسابات
- [ ] عدم احتساب المصاريف الثابتة للأشهر بدون نشاط فعلي

### تحديد الفترة الزمنية
- [ ] إضافة فلتر لتحديد الفترة الزمنية للتحليل (من - إلى)
- [ ] تحديث جميع الحسابات بناءً على الفترة المحددة

### تحسين نظام التنبؤات
- [ ] إصلاح التنبؤات لتعتمد على البيانات الحقيقية وليس التكرار
- [ ] تحسين خوارزمية التنبؤ اليومي
- [ ] تحسين التنبؤ حسب الفترة

### خانة محادثة AI متقدمة
- [ ] إنشاء واجهة محادثة AI احترافية
- [ ] إعداد برومبت وبيرسونا علمية متقدمة
- [ ] ربط AI بالوصول للبيانات الحقيقية (إيرادات، مصاريف، موظفين، إلخ)
- [ ] تمكين المناقشة والتحليل العميق للمشروع


## إصلاح وتحسين صفحة تحليلات AI (7 يناير 2026)
- [x] إصلاح احتساب الأشهر - استبعاد الأشهر بدون إيرادات من الحسابات
- [x] إضافة تحديد فترة زمنية مخصصة للتحليل
- [x] تحسين نظام التنبؤات ليعتمد على أنماط الأيام الحقيقية
- [x] إنشاء خانة محادثة AI متقدمة مع وصول للبيانات


## إصلاح واجهة مستشار AI (7 يناير 2026)
- [x] تغيير اسم المستشار من "مستشار ERP الذكي" إلى "Symbol AI"
- [x] تحديث البيرسونا ليعرّف نفسه كـ Symbol AI
- [x] إصلاح تداخل العناصر في واجهة المحادثة
- [x] تحسين التنسيق والتصميم البصري


## تحسين تبويبات تحليلات AI وأدوات البيانات (7 يناير 2026)
- [x] إصلاح تنسيق التبويبات (متداخلة وغير واضحة)
- [x] إضافة أدوات للـ AI للوصول للبيانات التفصيلية
- [x] تحسين عرض البيانات في سياق المحادثة


## تحسين تفاعلية Symbol AI (7 يناير 2026)
- [x] تحديث البيرسونا ليبادر بطرح الأسئلة لفهم الاحتياجات
- [x] إضافة رسالة ترحيب تسأل عن الاسم (عمر أو سالم)
- [x] حفظ اسم المستخدم طوال المحادثة


## إصلاح Symbol AI - Temperature والبيانات (7 يناير 2026)
- [x] ضبط temperature على 0.2 للتحليل الدقيق
- [x] فحص وإصلاح جلب البيانات الحقيقية من قاعدة البيانات
- [x] إصلاح Symbol AI ليصل لبيانات المصاريف الحقيقية من قاعدة البيانات

## تحسين واجهة Symbol AI Chat (7 يناير 2026)
- [x] إضافة شعار Symbol AI في واجهة الشات
- [x] تعديل رسالة الترحيب للسؤال عن الاسم بدلاً من الاختيار
- [x] فحص عميق للبحث عن مجالات التحسين
- [x] تحسين تنسيق واجهة الشات

## إصلاح صفحة طلبات البونص (8 يناير 2026)
- [x] عرض طلبات البونص السابقة في صفحة طلبات البونص
- [x] إمكانية العودة للأسابيع السابقة للبونص

## إحصائيات البونص (8 يناير 2026)
- [x] إضافة بطاقة ملخص إحصائيات البونص
- [x] عرض إجمالي البونصات المصروفة شهرياً
- [x] عرض إجمالي البونصات المصروفة سنوياً
- [x] عرض عدد الموظفين المستفيدين

## زر صرف البونص مع إشعارات متقدمة (8 يناير 2026)
- [x] إضافة زر طلب صرف للبونصات في حالة مسودة
- [x] إنشاء قالب بريد إلكتروني متقدم لطلب الصرف
- [x] إرسال إشعار لمشرف الفرع عند طلب الصرف
- [x] إرسال إشعار للمشرف العام عند طلب الصرف
- [x] إرسال إشعار للأدمن عند طلب الصرف

## تقرير PDF للبونص الأسبوعي (8 يناير 2026)
- [x] إنشاء قالب PDF احترافي للبونص الأسبوعي
- [x] إضافة زر تصدير PDF في صفحة طلبات البونص
- [x] تضمين تفاصيل الموظفين والمبالغ والإحصائيات

## إصلاح خطأ تصدير PDF (8 يناير 2026)
- [x] إصلاح خطأ Puppeteer على الخادم المنشور (libglib-2.0.so.0 missing)
- [x] استخدام طريقة بديلة لتوليد PDF (jsPDF من جهة العميل)

## طلب حذف الزيارات في برنامج الولاء (8 يناير 2026)
- [x] إضافة جدول طلبات حذف الزيارات في قاعدة البيانات
- [x] إضافة حقل حالة الحذف في جدول الزيارات
- [x] إنشاء إجراء طلب حذف زيارة مع كتابة السبب
- [x] إنشاء إجراء موافقة/رفض طلب الحذف للأدمن
- [x] إضافة زر طلب الحذف في واجهة برنامج الولاء
- [x] إضافة صفحة إدارة طلبات الحذف للأدمن

## فحص صلاحيات صفحة البونص (8 يناير 2026)
- [x] التحقق من وصول مشرف الفرع لصفحة طلبات البونص
- [x] إضافة صلاحية supervisor لصفحة طلبات البونص في القائمة
- [x] تحديث إجراءات API للبونص لتكون متاحة للمشرف

## حذف زيارات الولاء المباشر للأدمن (8 يناير 2026)
- [x] إضافة إجراء API لحذف الزيارة مباشرة للأدمن
- [x] إضافة زر حذف في جدول الزيارات للأدمن فقط
- [x] إضافة نافذة تأكيد الحذف مع كتابة السبب

## إصلاح صلاحيات صفحة البونص لمشرف طويق (8 يناير 2026)
- [ ] التحقق من صلاحيات صفحة البونص في القائمة الجانبية
- [ ] إضافة صلاحية supervisor لصفحة البونص
- [ ] اختبار ظهور الصفحة لمشرف طويق

## تعديل صلاحيات طلبات البونص (8 يناير 2026)
- [x] التأكد من ظهور صفحة البونص للمشرفين في القائمة الجانبية
- [x] منع وصول المشرفين لصفحة طلبات البونص (أدمن فقط)

## إصلاح تصدير PDF في طلبات البونص (8 يناير 2026)
- [ ] فحص كود تصدير PDF لطلبات البونص
- [ ] تحديد سبب الخطأ
- [ ] إصلاح المشكلة
- [ ] اختبار التصدير


## تحسين قالب PDF لطلبات البونص (8 يناير 2026)
- [x] إضافة شعار الشركة إلى PDF
- [x] إضافة الختم الرسمي
- [x] إضافة توقيع سالم الوادي
- [x] إضافة توقيع عمر المطيري
- [x] تحسين الخطوط والتصميم

- [x] إصلاح صلاحيات صفحة البونص لتظهر لمشرفي الفروع (محمد إسماعيل - فرع طويق)
- [x] إصلاح عدم ظهور بيانات البونص لمشرف فرع طويق (محمد إسماعيل) على النسخة المنشورة


## إصلاح برنامج الولاء - احتساب الزيارات المرفوضة (طلب جديد)
- [x] إصلاح دالة recordVisit - عدم احتساب الزيارات قبل الموافقة
- [x] تحديث دالة approveVisit - احتساب الزيارات عند الموافقة فقط
- [x] تحديث دالة rejectVisit - عدم تحديث الزيارات عند الرفض
- [x] إصلاح دالة getCustomerVisitsThisMonth - احتساب الموافق عليها فقط
- [x] إصلاح دالة getLoyaltyStats - احتساب الموافق عليها فقط
- [x] إصلاح دالة getLoyaltyDetailedStats - احتساب الموافق عليها فقط
- [x] إصلاح دالة getBranchLoyaltyStats - احتساب الموافق عليها فقط
- [x] كتابة اختبارات vitest للتحقق من الإصلاح
- [x] اختبار يدوي على الواجهة - تم التحقق من عدم احتساب الزيارات المعلقة
- [x] التحقق من حساب الخصم الصحيح - الإحصائيات تعرض الزيارات الموافق عليها فقط


## حاسبة الخصم في برنامج الولاء (طلب جديد)
- [x] إضافة خانة لإدخال مبلغ الفاتورة
- [x] عرض المبلغ المطلوب بعد الخصم 60% (يدفع العميل 40%)
- [x] اختبار الحاسبة على الواجهة - تم بنجاح


## طباعة إيصال الخصم (طلب جديد)
- [x] إضافة زر طباعة الإيصال في حاسبة الخصم
- [x] تصميم إيصال يتضمن: اسم الشركة، المبلغ الأصلي، نسبة الخصم، قيمة الخصم، المبلغ النهائي
- [x] اختبار الطباعة - تم بنجاح


## تحسين إيصال الخصم (طلب جديد)
- [ ] إضافة اسم العميل للإيصال - ربط الحاسبة بالعميل المحدد
- [ ] إنشاء جدول سجل الخصومات في قاعدة البيانات
- [ ] حفظ كل عملية خصم في قاعدة البيانات
- [ ] إضافة شعار الشركة للإيصال المطبوع
- [ ] اختبار شامل للميزات الجديدة


## تحسين إيصال الخصم في برنامج الولاء (طلب جديد)
- [x] إضافة حقل اسم العميل في حاسبة الخصم
- [x] إنشاء جدول سجل الخصومات في قاعدة البيانات (discountRecords)
- [x] حفظ سجل الخصم عند الطباعة
- [x] إضافة شعار الشركة للإيصال (/logo.png)
- [x] عرض اسم العميل في الإيصال المطبوع
- [x] اختبار شامل للميزة - تم بنجاح


## تحسين عميق لإيصال الخصم (طلب جديد)
- [ ] إضافة شعار البرنامج بشكل صحيح ومتناسق
- [ ] تحسين تصميم الإيصال ليكون أكثر احترافية
- [ ] استخدام ألوان موحدة (أسود للمحتوى والأرقام)
- [ ] تحسين الخط والتنسيق
- [ ] إضافة ختم "معتمد" للإيصال
- [ ] تحسين تجربة الطباعة على الجوال والويب
- [ ] اختبار شامل للإيصال المحسّن


## تحسين عميق لإيصال الخصم (طلب جديد)
- [x] إضافة شعار البرنامج بشكل صحيح (symbol-ai-logo.png)
- [x] تحسين التصميم ليكون احترافي (تدرجات لونية، أقسام منظمة)
- [x] إضافة ختم "معتمد" بتصميم دائري أخضر
- [x] توحيد الألوان (برتقالي/أخضر/أحمر متناسق)
- [x] إضافة رقم إيصال فريد لكل عملية
- [x] اختبار الإيصال المحسّن - تم بنجاح

## نظام حاسبة الخصم الذكي المحكم (طلب جديد)

### تحديث قاعدة البيانات
- [ ] إضافة حقل customerId في جدول سجلات الخصم
- [ ] إضافة حقل customerPhone في جدول سجلات الخصم
- [ ] إضافة حقل isVerified للتحقق من صحة الخصم
- [ ] إضافة حقل aiRiskScore لدرجة المخاطرة من الذكاء الاصطناعي

### API العملاء المؤهلين
- [ ] إنشاء دالة getEligibleCustomersForDiscount
- [ ] التحقق من إتمام 3 زيارات موافق عليها هذا الشهر
- [ ] التحقق من عدم الحصول على خصم سابق هذا الشهر
- [ ] إرجاع قائمة العملاء مع بياناتهم (الاسم، الجوال، عدد الزيارات)

### واجهة حاسبة الخصم الذكية
- [ ] استبدال حقل الإدخال اليدوي بقائمة منسدلة
- [ ] عرض العملاء المؤهلين فقط
- [ ] عرض اسم العميل ورقم الجوال تلقائياً
- [ ] منع الطباعة إذا لم يتم اختيار عميل من القائمة
- [ ] تحديث الإيصال ليشمل رقم العميل والجوال

### نظام الذكاء الاصطناعي للكشف عن التلاعب
- [ ] تحليل أنماط استخدام الخصومات
- [ ] كشف الخصومات المتكررة بشكل غير طبيعي
- [ ] تنبيه الأدمن عند اكتشاف نشاط مشبوه
- [ ] حساب درجة المخاطرة لكل عملية خصم

### الاختبارات
- [ ] اختبار vitest لدالة العملاء المؤهلين
- [ ] اختبار التحقق من الأهلية
- [ ] اختبار منع التلاعب


## نظام حاسبة الخصم الذكي (مكتمل)

### تحديث قاعدة البيانات
- [x] إضافة حقول التحقق (isVerified, eligibilityVerified, verificationMethod)
- [x] إضافة حقول الذكاء الاصطناعي (aiRiskScore, aiRiskLevel, aiAnalysisNotes)
- [x] إضافة حقل عدد الزيارات الموافق عليها (approvedVisitsCount)

### API العملاء المؤهلين للخصم
- [x] دالة getEligibleCustomersForDiscount - جلب العملاء المؤهلين
- [x] دالة verifyCustomerDiscountEligibility - التحقق من أهلية العميل
- [x] دالة createVerifiedDiscountRecord - إنشاء سجل خصم متحقق منه
- [x] إجراء tRPC getEligibleCustomers
- [x] إجراء tRPC createVerifiedDiscount

### واجهة حاسبة الخصم الذكية
- [x] قائمة منسدلة للعملاء المؤهلين فقط
- [x] عرض تلقائي لبيانات العميل (الاسم، الجوال، الزيارات)
- [x] شارة التحقق من الأهلية
- [x] منع إدخال عميل وهمي
- [x] تعطيل حقل المبلغ حتى اختيار عميل مؤهل
- [x] تنبيه عند عدم اختيار عميل

### نظام الذكاء الاصطناعي للكشف عن التلاعب
- [x] تحليل تاريخ الخصومات للعميل (آخر 6 أشهر)
- [x] تحليل مبلغ الخصم مقارنة بالمتوسط
- [x] تحليل توقيت الخصم (أوقات غير اعتيادية)
- [x] تحليل نمط الموظف (عدد الخصومات اليومية)
- [x] تحديد مستوى المخاطرة (low, medium, high, critical)
- [x] تنبيه الأدمن عند المخاطرة العالية

### إيصال الخصم المحسن
- [x] شارة "تم التحقق من الأهلية بواسطة النظام الذكي"
- [x] عرض بيانات العميل الكاملة (الاسم، الرقم، الجوال، الزيارات)
- [x] رقم إيصال فريد (DR-YYYY-XXXX)
- [x] شارة الذكاء الاصطناعي في الختم

### الاختبارات
- [x] اختبارات vitest لنظام حاسبة الخصم الذكي (24 اختبار ناجح)


## لوحة تحكم AI للمخاطر (قيد التطوير)

### API بيانات المخاطر
- [ ] دالة getDiscountRiskAnalytics - إحصائيات المخاطر الشاملة
- [ ] دالة getHighRiskDiscounts - الخصومات ذات المخاطرة العالية
- [ ] إجراء tRPC للوحة المخاطر

### واجهة لوحة التحكم
- [ ] صفحة RiskDashboard للأدمن
- [ ] بطاقات الإحصائيات (إجمالي، متوسط، توزيع)
- [ ] جدول الخصومات ذات المخاطرة العالية
- [ ] تفاصيل عوامل الخطر لكل خصم
- [ ] فلاتر (الفترة، المستوى، الفرع)

### الرسوم البيانية
- [ ] رسم بياني لتوزيع مستويات المخاطرة
- [ ] رسم بياني للاتجاه الشهري
- [ ] رسم بياني للخصومات حسب الفرع

### الاختبارات
- [ ] اختبارات vitest للوحة المخاطر


## مراجعة بونص فرع طويق - الأسبوع الثالث (قيد التنفيذ)
- [ ] فحص بيانات الإيرادات لفرع طويق للأسبوع الثالث
- [ ] مقارنة الإيرادات مع حسابات البونص
- [ ] تحديد الخطأ وإصلاحه
- [ ] التحقق من صحة الحسابات


## تحسين برنامج الولاء - عرض الزيارات والخصم (مكتمل)
- [x] عرض زيارات العميل في الشهر الحالي عند تسجيل زيارة جديدة
- [x] عرض تواريخ الزيارات السابقة بخط صغير
- [x] إظهار رسالة الخصم 60% عند الزيارة الثالثة في نفس الشهر
- [x] التأكد من أن الزيارات الثلاث في نفس الشهر


## رسالة تحفيزية للزيارة الثانية (مكتمل)
- [x] إضافة رسالة "ستحصل على خصم في زيارتك القادمة" عند الزيارة الثانية
- [x] عرض آخر يوم في الشهر الحالي
- [x] تذكير بأن الزيارة يجب أن تكون قبل نهاية الشهر


## تعديل نص برنامج الولاء (مكتمل)
- [x] تغيير "احصل على خصم 50% في الزيارة رقم 4" إلى "احصل على خصم 60% في الزيارة رقم 3"


## لوحة تحكم AI للمخاطر (قيد التنفيذ)
- [ ] مراجعة APIs الموجودة للمخاطر
- [ ] إنشاء صفحة لوحة تحكم المخاطر
- [ ] إضافة إحصائيات شاملة (إجمالي الخصومات، متوسط درجة المخاطرة)
- [ ] إضافة قائمة الخصومات عالية المخاطرة
- [ ] إضافة رسوم بيانية لتحليل الأنماط
- [ ] إضافة فلاتر متقدمة (حسب الفترة والمستوى)
- [ ] ربط الصفحة بالقائمة الجانبية


## تعديل نظام الولاء - احتساب 30 يوم لكل عميل (قيد التنفيذ)
- [ ] إضافة حقل cycleStartDate في جدول العملاء
- [ ] تعديل منطق احتساب الزيارات ليكون 30 يوم من تاريخ الزيارة الأولى
- [ ] تصفير الزيارات تلقائياً عند انتهاء الدورة
- [ ] تحديث الواجهة لعرض "باقي X أيام" بدلاً من "قبل نهاية الشهر"
- [ ] تحديث رسالة الزيارة الثانية لعرض تاريخ انتهاء الدورة


## تعديل نظام الولاء - احتساب 30 يوم لكل عميل (مكتمل)
- [x] إضافة حقل cycleStartDate لجدول العملاء
- [x] تعديل منطق احتساب الزيارات ليكون بناء على الدورة
- [x] تصفير الزيارات تلقائياً عند انتهاء 30 يوم
- [x] تحديث الواجهة لعرض "باقي X يوم" بدلاً من "قبل نهاية الشهر"
- [x] اختبارات vitest (17 اختبار ناجح)


## ربط مسير الرواتب بطلبات الإجازات (مكتمل)
- [x] تحليل بنية مسير الرواتب وطلبات الإجازات الحالية
- [x] إضافة حقول الإجازة في جدول مسير الرواتب (leaveDays, leaveDeduction)
- [x] إنشاء دالة لجلب إجازات الموظف المعتمدة في الشهر
- [x] تعديل منطق حساب الرواتب لخصم أيام الإجازة تلقائياً
- [x] تحديث واجهة مسير الرواتب لعرض تفاصيل الإجازات


## منع اختيار العروض في الزيارة الثالثة (مكتمل)
- [ ] منع اختيار أي خدمة تحتوي على كلمة "عرض" عند الزيارة الثالثة
- [ ] عرض رسالة تنبيه توضح أن الخصم لا يشمل العروض
- [ ] إخفاء أو تعطيل خيارات العروض من القائمة عند الزيارة الثالثة

## تحقق Backend لمنع العروض في الزيارة الثالثة (مكتمل)
- [x] إضافة تحقق في API recordVisit لمنع تسجيل الزيارة الثالثة بعرض
- [x] إرجاع رسالة خطأ واضحة عند محاولة التجاوز
- [x] اختبار vitest للتحقق من المنطق (14 اختبار ناجح)

## مساعد AI للموظفين (قيد التنفيذ)
- [ ] تصميم بنية المساعد والأدوات
- [ ] إنشاء API للمساعد مع LLM
- [ ] أداة التعرف على الموظف والفرع
- [ ] أداة رفع طلبات الموظفين (إجازة، سلفة، استئذان)
- [ ] أداة التقارير السريعة (إيرادات، بونص)
- [ ] أداة حساب الأسعار والخصومات
- [ ] واجهة المحادثة الذكية
- [ ] ربط المساعد بقاعدة البيانات

## نظام بوابة الموظفين مع Symbol AI (طلب جديد)
- [ ] إنشاء حسابات للموظفين (اسم مستخدم وكلمة مرور)
- [ ] إنشاء صفحة تسجيل دخول الموظفين
- [ ] إنشاء بوابة الموظفين مع المساعد الذكي Symbol AI
- [ ] تعديل منطق التوجيه بعد تسجيل الدخول (موظف -> بوابة الموظفين، مشرف -> لوحة التحكم)
- [ ] إضافة رابط المساعد الذكي في القائمة الجانبية للمشرفين


## نظام بوابة الموظفين مع Symbol AI (طلب جديد)

### نظام حسابات الموظفين
- [x] إضافة حقول تسجيل الدخول لجدول الموظفين (username, password, hasPortalAccess, lastLogin)
- [x] إنشاء حسابات للموظفين (اسم مستخدم وكلمة مرور)
- [x] دالة إنشاء اسم مستخدم تلقائي من اسم الموظف
- [x] دالة إنشاء كلمة مرور عشوائية
- [x] تسجيل دخول الموظفين
- [x] تغيير كلمة المرور
- [x] إعادة تعيين كلمة المرور (للأدمن)

### صفحات الواجهة
- [x] صفحة تسجيل دخول الموظفين (/employee-login)
- [x] بوابة الموظفين مع المساعد الذكي Symbol AI (/employee-portal)
- [x] صفحة إدارة حسابات الموظفين للأدمن (/employee-accounts)

### التوجيه والتكامل
- [x] توجيه الموظفين لبوابتهم بعد تسجيل الدخول
- [x] رابط Symbol AI في القائمة الجانبية للمشرفين
- [x] رابط بوابة الموظفين في صفحة تسجيل الدخول الرئيسية
- [x] رابط حسابات الموظفين في القائمة الجانبية (للأدمن فقط)

### الاختبارات
- [x] اختبارات generateUsername
- [x] اختبارات generatePassword


## إشعارات الموظفين وسجل الطلبات (طلب جديد)

### إشعارات البريد الإلكتروني للموظفين
- [ ] إضافة حقل البريد الإلكتروني لجدول الموظفين
- [ ] إنشاء خدمة إشعارات الموظفين
- [ ] إرسال إشعار عند تغيير حالة الطلب (موافقة/رفض)
- [ ] قوالب بريد إلكتروني رسمية بالعربية

### سجل الطلبات في بوابة الموظفين
- [ ] إضافة قسم سجل الطلبات في بوابة الموظفين
- [ ] عرض جميع طلبات الموظف السابقة
- [ ] عرض حالة كل طلب (قيد المراجعة، موافق، مرفوض)
- [ ] تصميم متجاوب للجوال


## إشعارات الموظفين وسجل الطلبات (طلب جديد)

### خدمة إشعارات الموظفين
- [x] إنشاء خدمة إشعارات بريد إلكتروني للموظفين
- [x] إشعار عند تغيير حالة الطلب (موافقة/رفض)
- [x] قوالب بريد إلكتروني احترافية بالعربية

### سجل الطلبات في بوابة الموظفين
- [x] إضافة تبويب "طلباتي" في بوابة الموظفين
- [x] عرض إحصائيات الطلبات (إجمالي، معلقة، موافق عليها، مرفوضة)
- [x] عرض قائمة الطلبات مع الحالة والتفاصيل
- [x] عرض ملاحظات المراجع للطلبات المعالجة
- [x] تصميم متجاوب للموبايل والويب

### API جديد
- [x] إضافة getMyRequests في employeeAuth router


## إصلاح مشاكل المساعد الذكي (طلب جديد)

### مشكلة التاريخ الحالي
- [x] المساعد يخلط بين الأشهر (يقول مارس بدلاً من يناير)
- [x] إضافة التاريخ الحالي بشكل صريح في system prompt
- [x] تحديث المساعد للتعرف على الشهر الحالي بشكل صحيح

### مشكلة فترات التقارير
- [x] إضافة دعم "الأسبوع الماضي" (last_week)
- [x] إضافة دعم "الشهر الماضي" (last_month)
- [x] تحديث أداة get_report لدعم الفترات الجديدة


## دعم الإدخال الصوتي للمساعد الذكي

- [x] إنشاء مكون تسجيل صوتي (VoiceRecorder)
- [x] دمج زر الميكروفون في واجهة المساعد
- [x] إضافة API لتحويل الصوت إلى نص (Whisper)
- [x] رفع الملف الصوتي إلى S3
- [x] معالجة النص المحول وإرساله للمساعد
- [x] إضافة مؤشر تسجيل مرئي
- [x] دعم الموبايل والويب


## إصلاح المساعد الذكي - إجابات حقيقية ودقيقة

### المشكلة الأساسية
- [ ] المساعد يعطي إجابات وهمية غير مبنية على بيانات حقيقية
- [ ] التقارير لا تعكس البيانات الفعلية من قاعدة البيانات
- [ ] الأرقام والإحصائيات مختلقة

### الحل المطلوب
- [ ] إعادة بناء أدوات المساعد لجلب بيانات حقيقية من DB
- [ ] التحقق من وجود البيانات قبل الرد
- [ ] إذا لا توجد بيانات، يجب الإفصاح بوضوح
- [ ] ربط الموظف ببياناته الفعلية (البونص، الإيرادات، الطلبات)
- [ ] اختبار الإجابات مقابل البيانات الحقيقية


## إصلاح المساعد الذكي - إجابات حقيقية (طلب جديد)

### تحليل المشكلة
- [x] تحليل المشكلة الحقيقية (LLM يختلق بيانات)
- [x] إضافة قواعد المصداقية الصارمة في system prompt
- [x] تحسين أداة get_report لتوضيح عدم وجود البيانات
- [x] إضافة حقل hasData لجميع الأدوات
- [x] تحسين رسائل الخطأ والتوضيح
- [x] اختبار مع سيناريوهات مختلفة


## تحسينات المساعد الذكي Symbol AI - المرحلة الثانية

### 🎯 الهدف
تحسين المساعد الذكي ليكون أكثر ذكاءً ودقة مع ذاكرة للمحادثات وتأكيد قبل الطلبات

### 📊 المعالم الرئيسية

#### Milestone 1: ذاكرة المحادثات
- [x] إنشاء جدول conversation_history في قاعدة البيانات
- [x] إنشاء جدول conversation_sessions لتتبع الجلسات
- [x] تنفيذ دوال حفظ واسترجاع المحادثات
- [x] دمج الذاكرة مع router المساعد
- [x] تحميل آخر 10 رسائل كسياق للمحادثة الجديدة
- [x] إضافة زر "محادثة جديدة" في الواجهة (API جاهز)

#### Milestone 2: تحسين التعرف على الفترات الزمنية
- [x] إنشاء وحدة dateParser لتحليل التواريخ النسبية
- [x] دعم "أمس"، "البارحة"، "قبل يومين"
- [x] دعم "الأسبوع الماضي"، "الأسبوع اللي فات"
- [x] دعم "الشهر الماضي"، "الشهر اللي فات"
- [ ] دعم "من تاريخ X إلى تاريخ Y"
- [x] دعم أسماء الأشهر بالعربية والإنجليزية
- [ ] اختبارات شاملة للـ dateParser

#### Milestone 3: نظام التأكيد قبل الطلبات
- [ ] إضافة حالة "pending_confirmation" للطلبات
- [ ] تعديل أداة submit_request لتطلب التأكيد أولاً
- [ ] إضافة أداة confirm_request للتأكيد
- [ ] إضافة أداة cancel_request للإلغاء
- [ ] عرض ملخص الطلب قبل التأكيد
- [ ] حفظ الطلبات المعلقة في الذاكرة المؤقتة

### ❗ المتطلبات
- الحفاظ على الأداء (لا تأخير ملحوظ)
- التوافق مع النظام الحالي
- اختبارات vitest لكل ميزة جديدة



## إصلاح مشاكل المساعد الذكي - الجولة الثانية
- [ ] المساعد يسأل عن تحديد الفترة بدلاً من فهم "هذا الأسبوع" مباشرة
- [ ] تحسين system prompt ليفهم الفترات الزمنية بشكل أفضل
- [ ] التحقق من الطلبات الوهمية (50 طلب) وتنظيفها
- [ ] إضافة validation لمنع إنشاء طلبات مكررة


## إصلاح مشاكل المساعد الذكي (طلب جديد)
- [x] تحسين فهم الفترات الزمنية في system prompt
- [x] إضافة قواعد واضحة للفترات (week, last_week, month, last_month, today)
- [x] توجيه المساعد لتنفيذ التقارير مباشرة بدون أسئلة إضافية
- [x] الأداة تحسب التواريخ تلقائياً بناءً على التاريخ الحالي



## تقرير الإيرادات للموظف في المساعد الذكي
- [x] إضافة أداة get_employee_revenue في assistantTools
- [x] دعم الفترات: اليوم، الأسبوع، الشهر
- [x] عرض إجمالي الإيرادات والمعاملات
- [x] عرض مقارنة مع الفترة السابقة (المتوسط اليومي)
- [x] اختبار الميزة


## تحسين تجربة التأكيد في المساعد الذكي Symbol AI (طلب جديد)

- [ ] إضافة أزرار "نعم/لا" تفاعلية عند طلب التأكيد
- [ ] تصميم أزرار متوافقة مع الثيم الحالي
- [ ] ربط الأزرار بمنطق التأكيد والإلغاء
- [ ] اختبار الأزرار التفاعلية


## أزرار التأكيد/الإلغاء التفاعلية في المساعد الذكي (طلب جديد)
- [x] تعديل استجابة chat لتضمين hasPendingRequest و pendingRequestType
- [x] إضافة أزرار "نعم، أكد الطلب" و "لا، ألغي" في واجهة المحادثة
- [x] ربط الأزرار بإرسال "نعم" أو "لا" تلقائياً
- [x] اختبار الأزرار والتأكد من عملها


## تحسين معالجة الأخطاء والتسجيل (Error Handling & Logging)
- [ ] تحليل الوضع الحالي لمعالجة الأخطاء في المشروع
- [ ] إنشاء نظام موحد للأخطاء (AppError classes)
- [ ] إنشاء نظام تسجيل منظم (Structured Logging)
- [ ] تطبيق معالجة الأخطاء على إجراءات tRPC
- [ ] إضافة سجل تدقيق للأخطاء في قاعدة البيانات
- [ ] اختبار النظام والتحقق من عمله


## تحسين معالجة الأخطاء والتسجيل (Error Handling & Logging) - 25 يناير 2026
- [x] إنشاء نظام تسجيل منظم (Structured Logger) في `server/utils/logger.ts`
- [x] إنشاء دوال معالجة الأخطاء في `server/middleware/errorMiddleware.ts`
- [x] تحديث 35 موقع console.error/warn/log إلى logger في routers.ts
- [x] إنشاء loggers متخصصة لكل وحدة (Auth, Database, SymbolAI, Requests, etc.)
- [x] كتابة 20 اختبار لنظام التسجيل (logger.test.ts)
- [x] كتابة 27 اختبار لمعالجة الأخطاء (errorMiddleware.test.ts)
- [x] دعم مستويات التسجيل (debug, info, warn, error, fatal)
- [x] دعم قياس وقت العمليات (withTiming, startOperation)
- [x] دعم السياق (context) في الرسائل
- [x] دعم child loggers للسياق المتداخل


## إصلاح مشكلة تعليق تقرير البونص - 25 يناير 2026
- [ ] تحليل سبب تعليق "جاري جلب البيانات..." عند طلب تقرير البونص
- [ ] فحص أداة get_bonus_report في المساعد الذكي
- [ ] إصلاح المشكلة واختبارها


## تحسين أداء المساعد الذكي Symbol AI - 25 يناير 2026
- [ ] إضافة timeout مناسب لطلبات LLM
- [ ] إضافة معالجة أخطاء timeout مع رسالة واضحة للمستخدم
- [ ] إضافة إمكانية إعادة المحاولة عند فشل الطلب
- [ ] تحسين عرض حالة التحميل في الواجهة
- [ ] إضافة caching للاستعلامات المتكررة


## تحسينات أداء المساعد الذكي Symbol AI - 25 يناير 2026
- [x] إضافة رسائل تحميل متدرجة (جاري معالجة طلبك، جاري تحليل البيانات، جاري جلب المعلومات، يرجى الانتظار قليلاً)
- [x] إضافة زر إعادة المحاولة عند فشل الطلب
- [x] تحسين معالجة أخطاء timeout و network مع رسائل واضحة للمستخدم
- [x] حفظ الرسالة الفاشلة لإمكانية إعادة المحاولة بسهولة


## إصلاح مشكلة خلط أنواع الطلبات - 25 يناير 2026
- [ ] تحليل سبب خلط أنواع الطلبات (طلب إجازة يُرفع كسلفة)
- [ ] إصلاح منطق اكتشاف نوع الطلب في routers.ts
- [ ] اختبار جميع أنواع الطلبات (إجازة، سلفة، استئذان، استقالة، اعتراض، صرف متأخرات)


## إصلاح خلط أنواع الطلبات في المساعد الذكي - 25 يناير 2026 (مكتمل)
- [x] تحليل سبب خلط أنواع الطلبات (إجازة تُرفع كسلفة)
- [x] تحسين prompt المساعد الذكي لتوضيح أنواع الطلبات بشكل صريح
- [x] إضافة قسم واضح لأنواع الطلبات مع الكلمات المفتاحية لكل نوع
- [x] إضافة تحذير صريح بعدم الخلط بين أنواع الطلبات
- [x] اختبار رفع طلب إجازة والتأكد من النوع الصحيح (vacation)


## إضافة خانة فواتير المدفوع في تسجيل الإيراد - 25 يناير 2026
- [ ] تحليل نموذج تسجيل الإيراد الحالي
- [ ] إضافة حقل فواتير المدفوع (اختياري)
- [ ] إضافة خانة ملاحظة تظهر عند إدخال مبلغ
- [ ] جمع مبلغ فواتير المدفوع مع الإجمالي
- [ ] تحديث قاعدة البيانات لحفظ البيانات الجديدة
- [ ] اختبار الميزة

## عرض فواتير المدفوع في السجل الشهري (طلب جديد)
- [x] إضافة عمود فواتير المدفوع في ملخص الشهر
- [x] إضافة عمود فواتير المدفوع في جدول الإيرادات
- [x] عرض المبلغ والسبب عند النقر على القيمة
- [x] تحديث تصدير PDF ليشمل فواتير المدفوع


## تقرير فواتير المدفوع (طلب جديد)
- [x] إنشاء API لجلب بيانات فواتير المدفوع
- [x] إنشاء صفحة التقرير مع فلاتر التاريخ والفرع
- [x] تصنيف الفواتير حسب الأسباب
- [x] عرض إحصائيات وإجماليات
- [ ] تصدير التقرير إلى PDF


## خصم فواتير الموظفين السالبة من مسير الرواتب (طلب جديد)
- [x] تحليل بنية فواتير الموظفين ومسير الرواتب
- [x] إضافة دالة لجلب الفواتير السالبة للموظف في الشهر
- [x] تعديل منطق إنشاء مسير الرواتب لخصم الفواتير السالبة تلقائياً
- [x] تحديث واجهة مسير الرواتب لعرض خصومات الفواتير
- [x] اختبار الخصم التلقائي


## إصلاح مشكلة عدم ظهور الفواتير السالبة في مسير الرواتب
- [x] تحليل سبب عدم ظهور الفواتير السالبة لمحمد اسماعيل (المسير كان لشهر ديسمبر والفاتورة في يناير)
- [x] إصلاح منطق جلب الفواتير السالبة في createPayrollWithDetails (الميزة تعمل بشكل صحيح)
- [x] اختبار الإصلاح والتحقق (تم التحقق بإنشاء مسير يناير 2026)

## إصلاح PDF لكشف الراتب في بوابة الموظفين (25 يناير 2026)
- [x] تشخيص مشكلة عدم عمل زر تحميل PDF
- [x] إصلاح استيراد jspdf-autotable بشكل صحيح
- [x] تغيير doc.autoTable إلى autoTable(doc, ...)
- [x] إصلاح doc.lastAutoTable إلى (doc as any).lastAutoTable
- [x] تحويل النصوص العربية إلى إنجليزية في PDF (jsPDF لا يدعم العربية)
- [x] إصلاح تنسيق الأرقام (en-US بدلاً من ar-SA)
- [x] إصلاح تاريخ الطباعة في الفوتر
- [x] اختبار توليد PDF والتحقق من النتيجة

## تحسين PDF كشف الراتب - دعم العربية والشعار (25 يناير 2026)
- [ ] البحث عن حل لدعم الخطوط العربية في jsPDF
- [ ] إضافة خط عربي مخصص (Amiri أو Cairo)
- [ ] إضافة شعار Symbol AI في رأس كشف الراتب
- [ ] تحويل النصوص إلى العربية في PDF
- [ ] اختبار PDF العربي والشعار


## إصلاح PDF لكشف الراتب في## بوابة الموظفين (طلب جديد)

### إصلاح لوحة تحكم الأدمن (مكتمل)
- [x] تحديث AdminEmployeePortal.tsx لاستخدام portalAdmin APIs
- [x] استخدام المصادقة المحلية بدلاً من Manus OAuth
- [x] عرض جميع الموظفين (8 موظفين)
- [x] عرض جميع الطلبات (60 طلب)
- [x] عرض الوثائق المنتهية والقريبة الانتهاء
- [x] عرض تفاصيل الموظف عند النقر [x] إصلاح استيراد jspdf-autotable
- [x] تحويل النصوص إلى الإنجليزية لدعم jsPDF
- [x] إصلاح تنسيق الأرقام والتواريخ
- [x] إضافة شعار Symbol AI في رأس PDF
- [x] تصميم احترافي مع ألوان موحدة


## تحسين واجهة بوابة الموظفين للموبايل (طلب جديد)

### تحليل المشاكل الحالية
- [x] تحليل الهيدر والتنسيق العام
- [x] تحليل منطقة الشات والرسائل
- [x] تحليل الإجراءات السريعة وحقل الإدخال
- [x] تحليل التباعد والمسافات

### التحسينات المطلوبة
- [x] تحسين الهيدر (الحجم، التباعد، الشعار)
- [x] تحسين منطقة الشات (فقاعات الرسائل، التنسيق)
- [x] تحسين الإجراءات السريعة (الأيقونات، الألوان)
- [x] تحسين حقل الإدخال (الحجم، التموضع)
- [x] تحسين التجاوب مع الموبايل


## إدخال البريد الإلكتروني الإجباري عند أول تسجيل دخول (طلب جديد)

### المتطلبات
- [ ] إضافة حقل email في جدول employees إذا لم يكن موجوداً
- [ ] إنشاء مكون EmailSetupModal لإدخال البريد الإلكتروني
- [ ] التحقق من وجود البريد عند تحميل بوابة الموظفين
- [ ] منع الوصول للبوابة حتى يتم إدخال البريد
- [ ] إضافة API endpoint لحفظ البريد الإلكتروني
- [ ] التحقق من صحة البريد الإلكتروني (validation)


## إدخال البريد الإلكتروني الإجباري عند أول تسجيل دخول (طلب جديد)
- [x] إضافة حقل emailVerified لجدول employees
- [x] إنشاء مكون EmailSetupModal
- [x] دمج النموذج في بوابة الموظفين
- [x] إضافة endpoint لحفظ البريد الإلكتروني
- [x] اختبار الميزة بالكامل


## إضافة حقول الإقامة والشهادة الصحية وعقد العمل (طلب جديد)

### تحديث قاعدة البيانات
- [ ] إضافة حقل رقم الإقامة (iqamaNumber)
- [ ] إضافة حقل تاريخ انتهاء الإقامة (iqamaExpiryDate)
- [ ] إضافة حقل تاريخ انتهاء الشهادة الصحية (healthCertExpiryDate)
- [ ] إضافة حقل تاريخ انتهاء عقد العمل (contractExpiryDate)

### تحديث واجهة إدارة الموظفين
- [ ] إضافة حقول الإقامة في نموذج إضافة/تعديل الموظف
- [ ] إضافة حقل الشهادة الصحية في النموذج
- [ ] إضافة حقل عقد العمل في النموذج
- [ ] عرض تواريخ الانتهاء في قائمة الموظفين

### نظام الإشعارات التذكيرية
- [ ] إشعار قبل انتهاء الإقامة بشهر
- [ ] إشعار قبل انتهاء الشهادة الصحية بأسبوع
- [ ] إشعار قبل انتهاء عقد العمل بشهرين
- [ ] إشعار قبل انتهاء عقد العمل بشهر
- [ ] إرسال الإشعارات للمشرفين والأدمن عبر البريد


## حقول الإقامة والشهادة الصحية وعقد العمل (مكتمل)

### تحديث قاعدة البيانات
- [x] إضافة حقل رقم الإقامة (iqamaNumber)
- [x] إضافة حقل تاريخ انتهاء الإقامة (iqamaExpiryDate)
- [x] إضافة حقل تاريخ انتهاء الشهادة الصحية (healthCertExpiryDate)
- [x] إضافة حقل تاريخ انتهاء عقد العمل (contractExpiryDate)

### تحديث واجهة إدارة الموظفين
- [x] إضافة حقول الإدخال في نموذج الموظف
- [x] تحديث endpoints لحفظ البيانات

### نظام الإشعارات التذكيرية
- [x] إشعار انتهاء الإقامة قبل شهر
- [x] إشعار انتهاء الشهادة الصحية قبل أسبوع
- [x] إشعار انتهاء عقد العمل قبل شهرين
- [x] إشعار انتهاء عقد العمل قبل شهر
- [x] جدولة فحص الوثائق يومياً الساعة 8:00 صباحاً
- [x] إرسال الإشعارات للمشرفين والأدمن عبر البريد الإلكتروني



## لوحة تحكم الوثائق المنتهية ورفع الصور وتقرير PDF (جديد)

### لوحة تحكم الوثائق المنتهية
- [ ] إنشاء صفحة DocumentsDashboard
- [ ] عرض الموظفين الذين تنتهي إقامتهم خلال شهر
- [ ] عرض الموظفين الذين تنتهي شهادتهم الصحية خلال أسبوع
- [ ] عرض الموظفين الذين ينتهي عقدهم خلال شهرين
- [ ] إضافة فلاتر وبحث
- [ ] إضافة رابط في القائمة الجانبية

### رفع صور الوثائق
- [ ] إضافة حقول صور الوثائق في قاعدة البيانات
- [ ] إضافة واجهة رفع الصور في نموذج الموظف
- [ ] حفظ الصور في S3
- [ ] عرض الصور في لوحة الوثائق

### تقرير PDF للوثائق
- [ ] إنشاء قالب PDF احترافي للوثائق
- [ ] تضمين الشعار والختم والتوقيعات
- [ ] عرض حالة جميع الوثائق لكل موظف
- [ ] إضافة زر تصدير PDF



## لوحة تحكم الوثائق ورفع الصور وتقرير PDF (مكتمل)

### لوحة تحكم الوثائق المنتهية
- [x] إنشاء صفحة لوحة تحكم الوثائق
- [x] إضافة endpoints للوثائق المنتهية
- [x] إضافة رابط في القائمة الجانبية
- [x] بطاقات ملخص (منتهية، قريبة الانتهاء، إقامات، عقود)
- [x] تبويبات (منتهية / قريبة الانتهاء)
- [x] تبويبات فرعية (الإقامة / الشهادة الصحية / عقد العمل)
- [x] حقل بحث بالاسم أو الكود أو الفرع

### رفع صور الوثائق
- [x] إضافة حقول صور الوثائق في قاعدة البيانات (iqamaImage, healthCertImage, contractImage)
- [x] إضافة حقول رفع الصور في نموذج الموظف
- [x] حفظ الصور في S3

### تقرير PDF للوثائق
- [x] إنشاء تقرير PDF احترافي مع الشعار والختم والتوقيعات
- [x] عرض الوثائق المنتهية والقريبة الانتهاء
- [x] تضمين معلومات الموظف والفرع ونوع الوثيقة وتاريخ الانتهاء


## إشعار بريدي فوري للمشرفين عند اقتراب انتهاء الوثائق (طلب جديد)
- [x] تحليل نظام الإشعارات الحالي
- [x] تحديث دالة فحص الوثائق لإرسال إشعارات للمشرفين
- [x] إرسال إشعار لمشرف الفرع عند اقتراب انتهاء وثيقة موظف في فرعه
- [x] إرسال إشعار للأدمن والمشرف العام لجميع الوثائق
- [x] اختبار الإشعارات


## إصلاح نظام إنشاء مسير الرواتب (طلب جديد)
- [ ] تحليل كود إنشاء مسير الرواتب الحالي
- [ ] إضافة سحب فواتير السالب من فواتير الموظفين واحتسابها كخصومات
- [ ] إضافة سحب أيام الإجازات بدون راتب وخصمها من الراتب
- [ ] اختبار الإصلاحات

## إصلاح خصومات مسير الرواتب (طلب جديد)
- [x] إضافة endpoint لجلب الفواتير السالبة والإجازات بدون راتب (getDeductionsPreview)
- [x] تحديث صفحة الرواتب لاستدعاء الـ endpoint عند اختيار الفرع والشهر
- [x] عرض الفواتير السالبة والإجازات بدون راتب في جدول إنشاء المسير
- [x] إضافة أعمدة "فواتير سالبة" و"إجازة بدون راتب" في الجدول
- [x] تحديث حساب الخصومات ليشمل الفواتير السالبة والإجازات بدون راتب
- [x] إرسال الخصومات الجديدة للـ backend عند إنشاء المسير

## نظام معلومات الموظفين في بوابة الموظفين (طلب جديد)
- [x] إضافة حقول معلومات الموظف في قاعدة البيانات (رقم الإقامة، تاريخ انتهاء الإقامة، تاريخ انتهاء الشهادة الصحية، تاريخ انتهاء عقد العمل)
- [x] إنشاء صفحة تسجيل معلومات الموظف في بوابة الموظفين
- [x] منع الموظف من تعديل المعلومات بعد التسجيل الأول
- [x] السماح للأدمن فقط بتعديل معلومات الموظفين
- [x] إضافة اختبارات vitest للنظام الجديد

## رفع صور الوثائق للموظفين (طلب جديد)
- [x] إضافة حقول روابط صور الوثائق في قاعدة البيانات
- [x] إنشاء API لرفع الصور إلى S3
- [x] تحديث مكون EmployeeInfoForm لدعم رفع الصور
- [x] عرض الصور المرفوعة في الملف الشخصي
- [x] إضافة اختبارات للنظام الجديد

## تحسينات نظام الوثائق (طلب جديد)
- [ ] ضغط تلقائي للصور قبل الرفع لتقليل حجم الملفات
- [ ] تقرير الموظفين بدون وثائق للأدمن
- [ ] إشعارات تذكيرية للموظفين لرفع وثائقهم


## تحسينات نظام الوثائق (طلب جديد)
- [x] ضغط تلقائي للصور قبل الرفع لتقليل حجم الملفات
- [x] تقرير الموظفين بدون وثائق للأدمن
- [x] إشعارات تذكيرية للموظفين لرفع وثائقهم
- [x] إرسال تذكيرات جماعية للأدمن والمشرف العام
- [x] إرسال تذكير لموظف محدد

## تنبيهات انتهاء صلاحية الوثائق وإشعارات الطلبات (طلب جديد)
- [ ] تنبيهات للأدمن عند اقتراب انتهاء صلاحية وثائق الموظفين (الإقامة، الشهادة الصحية، عقد العمل)
- [ ] إشعارات بريد إلكتروني للموظفين عند تقديم طلب جديد
- [ ] إشعارات بريد إلكتروني للموظفين عند الموافقة على طلبهم
- [ ] إشعارات بريد إلكتروني للموظفين عند رفض طلبهم
- [ ] قوالب بريد احترافية بالعربية والإنجليزية


## تنبيهات انتهاء صلاحية الوثائق وإشعارات الطلبات (طلب جديد)
- [x] تنبيهات انتهاء صلاحية الوثائق للأدمن (الإقامة، الشهادة الصحية، عقد العمل)
- [x] إشعارات بريد للموظفين عند تقديم طلب
- [x] إشعارات بريد للموظفين عند الموافقة أو الرفض
- [x] محتوى احترافي لرسائل البريد
- [x] إضافة اختبارات vitest

## تكامل Twilio لرسائل WhatsApp/SMS (طلب جديد)
- [ ] إعداد Twilio secrets (Account SID, Auth Token, Messaging Service SID)
- [ ] إنشاء خدمة twilioService للرسائل
- [ ] دمج Twilio في نظام الإشعارات الحالي
- [ ] إضافة إشعارات WhatsApp للموظفين عند تقديم/موافقة/رفض الطلبات
- [ ] إضافة اختبارات للنظام الجديد


## تكامل Twilio لرسائل WhatsApp/SMS (طلب جديد)
- [x] إعداد Twilio secrets
- [x] إنشاء خدمة إرسال الرسائل SMS/WhatsApp
- [x] دمج Twilio في إشعارات الطلبات
- [x] إضافة إشعار SMS عند تقديم الطلب
- [x] إضافة إشعار SMS عند الموافقة أو الرفض
- [x] إضافة APIs لإرسال SMS/WhatsApp مخصصة
- [x] إضافة تذكير الوثائق عبر SMS
- [x] إضافة اختبارات vitest (12 اختبار ناجح)

## إصلاح مشكلة التمرير في المحادثة (طلب جديد)
- [x] تحليل مشكلة عدم التمرير في المحادثة
- [x] إصلاح CSS للسماح بالتمرير
- [x] اختبار الإصلاح على الموبايل

## مؤشر جارٍ الكتابة في المحادثة (طلب جديد)
- [x] إضافة مؤشر "جارٍ الكتابة..." عند معالجة الرد
- [x] تحريك المؤشر بشكل جذاب (نقاط متحركة)


## اختبار المشرف وإشعارات تراجع الأداء (طلب جديد)
- [x] اختبار عملي لتسجيل الدخول كمشرف لبن أو طويق
- [x] اختبار المساعد الذكي للمشرف
- [x] إنشاء نظام إشعارات تراجع أداء الموظفين
- [x] إرسال إشعار للمشرف عند تراجع أداء موظف
- [x] دمج أداة تنبيهات الأداء مع المساعد الذكي


## جدولة إرسال تنبيهات تراجع الأداء يومياً (طلب جديد)
- [x] مراجعة نظام الإشعارات الحالي (performanceAlerts.ts)
- [x] إنشاء cron job يومي لإرسال التنبيهات (7:30 صباحاً)
- [x] منع التكرار باستخدام جدول sentNotifications
- [x] إرسال بريد إلكتروني للمشرفين بأسلوب رسمي
- [x] دمج الـ cron job مع السيرفر (cronScheduler.ts)
- [x] إضافة endpoint للتشغيل اليدوي (scheduledReports.sendPerformanceAlerts)
- [x] اختبار النظام


## إضافة صور الموظفين (طلب جديد)
- [x] رفع صورة عبدالحي جلال إلى S3
- [x] تحديث قاعدة البيانات بـ URL الصورة
- [x] تحديث واجهة EmployeeProfile لعرض الصورة
- [x] التحقق من عرض الصورة في الواجهة
- [x] رفع صورة محمود عماره (EMP-012) إلى S3
- [x] رفع صورة علاء ناصر (EMP-002) إلى S3
- [x] رفع صورة السيد محمد (EMP-007) إلى S3


## تنفيذ التقارير المحاسبية الشهرية (طلب جديد)
- [x] تقرير الإيرادات الشهري الشامل (PDF)
- [x] تقرير المصاريف الشهري التفصيلي (PDF)
- [x] تقرير البونص الأسبوعي والشهري (PDF)
- [x] إضافة صفحة التقارير الشهرية في لوحة التحكم (/monthly-reports)
- [x] إضافة endpoints لتوليد التقارير (scheduledReports)
- [x] اختبار التقارير


## تقارير P&L ومسير الرواتب (طلب جديد)
- [x] تقرير الربح والخسارة (P&L) الشهري
- [x] تقرير مسير الرواتب الشهري
- [x] إضافة endpoints في routers.ts
- [x] تحديث واجهة MonthlyReports.tsx
- [x] اختبارات vitest (23 اختبار ناجح)


## تقارير P&L ومسير الرواتب (طلب جديد)
- [x] تقرير الربح والخسارة (P&L)
- [x] تقرير مسير الرواتب
- [x] اختبارات vitest للتقارير

## إصلاح تسجيل دخول المشرفين (طلب جديد)
- [x] إصلاح كلمة مرور Admin (Omar101010#)
- [x] التحقق من تسجيل دخول laban
- [x] التحقق من صلاحيات Admin للفرعين


## تحسين لوحة الوثائق ودقة البيانات (طلب جديد)
- [ ] فحص لوحة الوثائق الحالية
- [ ] تحسين دقة البيانات والحسابات
- [ ] تحسين واجهة المستخدم والتصميم
- [ ] توحيد الألوان والخطوط
- [ ] تحسين عرض الأرقام والإحصائيات


## تحسين لوحة الوثائق ودقة البيانات (طلب جديد)
- [x] تحسين التصميم العام والبطاقات
- [x] إضافة إحصائيات متقدمة (نسبة الامتثال، الموظفون المتأثرون)
- [x] تحسين حساب الأيام المتبقية
- [x] تحسين ترتيب الموظفين حسب الأولوية
- [x] تحسين تقرير PDF الاحترافي
- [x] إضافة الشعار والتوقيعات والختم


## إصلاح دخول المشرفين لبوابة الموظفين + التحسينات (طلب جديد)
- [x] السماح للأدمن والمشرفين بالدخول لبوابة الموظفين
- [x] إضافة إشعارات بريدية تلقائية عند اقتراب انتهاء الوثائق
- [x] إضافة فلتر الفرع في لوحة الوثائق
- [x] إضافة تقويم مرئي لتواريخ انتهاء الوثائق


## داشبورد الأدمن في بوابة الموظفين (طلب جديد)
- [ ] تحليل بوابة الموظفين الحالية وتحديد المتطلبات
- [ ] تصميم داشبورد شامل للأدمن (إحصائيات، طلبات، ملفات)
- [ ] صفحة عرض جميع الموظفين مع الفلترة والبحث
- [ ] صفحة إدارة طلبات الموظفين (سلف، إجازات، استئذان، إلخ)
- [ ] صفحة عرض ملفات الموظفين (الوثائق، العقود، الشهادات)
- [ ] إضافة نظام تنبيهات ذكي للأدمن
- [ ] إضافة تقارير وإحصائيات تلقائية
- [ ] اختبارات vitest للداشبورد الجديد


## داشبورد الأدمن في بوابة الموظفين (مكتمل)
- [x] لوحة إحصائيات شاملة (الموظفين، الطلبات، الوثائق)
- [x] عرض قائمة الموظفين مع البحث وفلتر الفرع
- [x] عرض ملف الموظف الكامل (التواصل، العمل، الوثائق، البنك)
- [x] إدارة الطلبات (موافقة/رفض)
- [x] تنبيهات الوثائق المنتهية
- [x] توجيه الأدمن/المشرفين تلقائياً للداشبورد
- [x] تحديث دوال getAllEmployees و getEmployeesByBranch لتضمين branchName


## نظام التدقيق والامتثال (Audit & Compliance)
- [x] تصميم جداول قاعدة البيانات (audit_events, compliance_rules, compliance_violations)
- [x] بناء خدمة تسجيل التدقيق التلقائي (auditService.ts)
- [x] بناء نظام كشف الشذوذ (Anomaly Detection)
- [x] بناء نظام قواعد الامتثال وتصنيف المخاطر
- [x] واجهة عرض سجلات التدقيق (AuditCompliance.tsx)
- [x] تقارير الامتثال مع نسبة الامتثال
- [x] اختبارات vitest (17 اختبار)

## لوحة التحكم التنفيذية (Executive Dashboard)
- [x] APIs لجلب KPIs الشاملة (executiveDashboardService.ts)
- [x] مقارنة أداء الفروع (getBranchComparison)
- [x] حفظ KPI snapshots للمقارنة التاريخية
- [x] حساب الربح الحقيقي (شامل آخر مسير رواتب)
- [x] التنبيهات الذكية (executiveAlerts)
- [x] تحليل الأداء (runPerformanceAnalysis)
- [x] اختبارات vitest (17 اختبار)

## نظام الذكاء الاصطناعي للقرارات (AI Decision Engine)
- [x] محرك التحليل التنبؤي (aiDecisionEngine.ts)
- [x] نظام التوصيات الذكية باستخدام LLM
- [x] تنبيهات المخاطر المالية (riskAlerts)
- [x] توقعات الإيرادات والمصاريف (aiPredictions)
- [x] واجهة عرض التوصيات (AIDecisionCenter.tsx)
- [x] اختبارات vitest (13 اختبار)



## ربط نظام التدقيق التلقائي + التقارير الأسبوعية
- [x] إنشاء middleware للتدقيق التلقائي في tRPC (auditMiddleware.ts)
- [x] ربط التدقيق بجميع عمليات CRUD (الموظفين، المعاملات، الطلبات، المخزون)
- [x] إنشاء خدمة التقارير الأسبوعية التلقائية (weekly-reports.service.ts)
- [x] إنشاء قالب البريد الإلكتروني للتقرير الأسبوعي
- [x] إضافة جدول scheduledReports لتتبع التقارير المرسلة
- [x] إضافة واجهة إعدادات الجدولة للمدير (ReportScheduleSettings.tsx)
- [x] اختبارات vitest (726 اختبار ناجح)

## إصلاح خطأ تسجيل الدخول (طلب جديد)
- [x] إصلاح خطأ تحديث lastSignedIn عند تسجيل الدخول (إضافة try-catch لعدم إيقاف الدخول)
- [x] التحقق من نوع البيانات في قاعدة البيانات (timestamp)
- [x] اختبار تسجيل الدخول بعد الإصلاح (ناجح)

## إصلاح احتساب الإجازات بدون راتب في مسير الرواتب (طلب جديد)
- [x] تحليل كود مسير الرواتب الحالي (المشكلة: نوع الإجازة مخزن بالإنجليزية 'unpaid' والكود يبحث عن 'بدون راتب')
- [x] ربط طلبات الإجازة بدون راتب الموافق عليها بمسير الرواتب (تحديث calculateLeaveDeduction لدعم اللغتين)
- [x] حساب عدد أيام الإجازة بدون راتب لكل موظف (تحديث getApprovedLeavesForEmployee للتعامل مع عدم وجود vacationEndDate)
- [x] خصم قيمة أيام الإجازة من الراتب (يعمل مع annual/sick/emergency/unpaid)
- [x] اختبار الحل والتحقق من صحة الحسابات (17 اختبار ناجح)

## إصلاح بيانات التقارير الغير دقيقة (طلب جديد)
- [ ] تحليل كود التقارير وفهم مصدر البيانات
- [ ] إصلاح استعلام المبيعات (تظهر 0 رغم وجود بيانات)
- [ ] إصلاح استعلام الإيرادات في قائمة الدخل
- [ ] إصلاح استعلام المشتريات
- [ ] التحقق من فلتر التاريخ في التقارير
- [ ] اختبار التقارير والتحقق من البيانات


## إصلاح بيانات التقارير الغير دقيقة (طلب جديد)
- [x] تحليل كود التقارير الحالي (getSalesReport, getPurchasesReport)
- [x] تحديد مصدر بيانات المبيعات الصحيح (dailyRevenues بدلاً من invoices) - 54 سجل بإجمالي 50,410 ر.س.
- [x] تحديث استعلامات المشتريات لتشمل approved و received (3 أوامر بإجمالي 2,706 ر.س.)
- [x] اختبار التقارير والتحقق من دقة البيانات (10 اختبارات ناجحة)


## إصلاح عدم ظهور الإجازة بدون راتب في مسير الرواتب (طلب جديد)
- [ ] تحليل بيانات الإجازة والموظف في قاعدة البيانات
- [ ] التحقق من ربط الموظف بالطلب
- [ ] إصلاح دالة getApprovedLeavesForEmployee
- [ ] اختبار ظهور الإجازة في المسير


## إصلاح عدم ظهور الإجازة بدون راتب في مسير الرواتب (طلب جديد)
- [x] تحليل بيانات طلب الإجازة لعلاء ناصر (employeeId: 30002, vacationType: unpaid, vacationDays: 1)
- [x] التحقق من استعلام جلب الإجازات (API يعمل بشكل صحيح ويرجع totalDeduction: 0)
- [x] ربط الإجازات بمسير الرواتب (إصلاح حساب الخصم في الواجهة بناءً على نوع الإجازة)
- [x] اختبار الحل (علاء ناصر: خصم 66.67 ر.س. ليوم واحد بدون راتب)


## تصحيح منطق خصم الإجازة بدون راتب (طلب جديد)
- [x] فهم المتطلبات: مع ساعات إضافية = 100 ر.س/يوم، بدون = 66.67 ر.س/يوم
- [x] تحليل الكود الحالي في Payrolls.tsx (المشكلة: dailySalary لا يأخذ الساعات الإضافية بعين الاعتبار)
- [x] تعديل منطق الخصم ليعتمد على حالة الساعات الإضافية (إضافة leavesData وتحديث calculateSalary)
- [x] اختبار الحل: بدون ساعات إضافية = -66.67 ر.س، مع ساعات إضافية = -100 ر.س ✅


## إصلاح لوحة تحكم الأدمن في بوابة الموظفين (طلب جديد)
- [ ] تحليل مشكلة المصادقة - زر الخروج يوجه لـ Manus بدلاً من تسجيل الدخول المحلي
- [ ] تحليل مشكلة التحميل اللانهائي وعدم عرض البيانات
- [ ] إصلاح زر الخروج ليعود لصفحة تسجيل الدخول المحلي
- [ ] تحسين واجهة لوحة تحكم الأدمن لتكون مفيدة
- [ ] اختبار الحل


## تقرير السندات الشهري (29 يناير 2026)

### المتطلبات
- [x] تقرير PDF يجمع جميع السندات في فترة محددة
- [x] فلترة حسب الفترة (من/إلى)
- [x] فلترة حسب نوع السند (قبض/صرف)
- [x] فلترة حسب الحالة (مسودة/معتمد/ملغي)
- [x] فلترة حسب الفرع
- [x] إجماليات (عدد السندات، إجمالي المبالغ)
- [x] تصميم احترافي مع الشعار والختم والتوقيعات

### التنفيذ
- [x] إنشاء API جلب السندات حسب الفلاتر (getVouchersForReport في db.ts)
- [x] إنشاء قالب PDF للتقرير (generateVouchersReportPDF في pdfService.ts)
- [x] إنشاء صفحة واجهة المستخدم للتقرير (VouchersReport.tsx)
- [x] اختبار التقرير - يعمل بنجاح (PDF 110KB)


## إصلاح أخطاء حساب الرواتب في مسيرات الرواتب (29 يناير 2026)

### المشاكل المُبلَّغ عنها
- [ ] مشكلة السيد: فاتورة سالبة -55 + راتب 3150 = يظهر 3040 بدلاً من 3095
- [ ] مشكلة علاء: خصم يوم إجازة بدون راتب مع ساعات إضافية = يظهر 66.67 بدلاً من 100

### التحليل
- [ ] تحليل منطق حساب الفواتير السالبة (employeeInvoices)
- [ ] تحليل منطق حساب خصم الإجازة بدون راتب
- [ ] تحليل دالة calculateSalary في Payrolls.tsx

### الإصلاحات
- [ ] إصلاح حساب الفواتير السالبة (يجب أن تُطرح من الراتب وليس تُضاف)
- [ ] إصلاح حساب خصم الإجازة بدون راتب (100 ر.س مع ساعات إضافية، 66.67 بدون)

### الاختبارات
- [ ] كتابة اختبارات vitest لحساب الرواتب
- [ ] اختبار الحل في المتصفح


## إصلاح أخطاء حساب الرواتب (29 يناير 2026) ✅

### المشاكل المُبلغ عنها:
- [x] مشكلة السيد: فاتورة سالبة -55 مع راتب 3150 = يجب 3095 وليس 3040
- [x] مشكلة علاء: خصم يوم إجازة مع ساعات إضافية = يجب 100 وليس 66.67

### الإصلاحات المُطبقة:
- [x] جلب إعدادات الرواتب من قاعدة البيانات (salarySettings.list)
- [x] استخدام overtimeEnabled المحفوظة للموظف
- [x] حساب خصم الإجازة بناءً على (الراتب + الساعات الإضافية) / 30
- [x] إصلاح تكرار خصم الفواتير السالبة في createPayroll
- [x] كتابة 10 اختبارات vitest للتحقق من صحة الحسابات

### الملفات المُعدلة:
- client/src/pages/Payrolls.tsx (سطور 150-244)
- server/db.ts (دالة createPayroll)
- server/payroll-calculations.test.ts (جديد)


## نظام تتبع التدفق النقدي (29 يناير 2026) ✅

### 🎯 الهدف
تطوير نظام متكامل لتتبع التدفق النقدي مع فرز المصاريف وخصم المصاريف النقدية وسندات القبض من إيرادات الفرع

### المتطلبات الرئيسية
- [x] فرز المصاريف حسب طريقة الدفع (نقدي، بطاقة ائتمانية، تحويل بنكي)
- [x] عرض مجموع كل طريقة دفع في تقرير المصاريف
- [x] خصم المصاريف النقدية من إيرادات الفرع النقدية
- [x] عرض الإجمالي قبل وبعد الخصم
- [x] خصم سندات القبض النقدية من الكاش
- [x] تقرير نهاية الشهر للكاش المتبقي

### المرحلة 1: تحليل الكود الحالي ✅
- [x] تحليل جدول المصاريف وحقل طريقة الدفع
- [x] تحليل جدول سندات القبض
- [x] تحليل جدول الإيرادات اليومية

### المرحلة 2: تصميم نموذج البيانات ✅
- [x] تصميم هيكل بيانات التدفق النقدي
- [x] إضافة حقل paymentMethod لجدول سندات القبض

### المرحلة 3: تطوير API ✅
- [x] إنشاء دالة getExpensesByPaymentMethod
- [x] إنشاء دالة getVouchersByPaymentMethod
- [x] إنشاء دالة getMonthlyCashFlowReport
- [x] إنشاء إجراءات tRPC للتدفق النقدي

### المرحلة 4: تحديث واجهة تقرير المصاريف ✅
- [x] إنشاء صفحة CashFlowReport.tsx
- [x] عرض إجماليات كل طريقة دفع

### المرحلة 5: تحديث واجهة سندات القبض ✅
- [x] إضافة حقل طريقة الدفع لنموذج إنشاء السند

### المرحلة 6: إنشاء تقرير الكاش الشهري ✅
- [x] صفحة تقرير الكاش الشهري (CashFlowReport.tsx)
- [x] عرض الإيرادات النقدية
- [x] عرض المصاريف حسب طريقة الدفع
- [x] عرض سندات القبض حسب طريقة الدفع
- [x] عرض الكاش المتبقي
- [x] إضافة رابط في قائمة التنقل

### المرحلة 7: الاختبارات ✅
- [x] كتابة 14 اختبار vitest (server/cashFlow.test.ts)
- [x] جميع الاختبارات ناجحة

### الملفات المُنشأة/المُعدلة:
- drizzle/schema.ts (إضافة paymentMethod لسندات القبض)
- server/db.ts (دوال التدفق النقدي)
- server/routers.ts (إجراءات tRPC)
- server/receiptVoucher.ts (دعم paymentMethod)
- client/src/pages/CashFlowReport.tsx (جديد)
- client/src/pages/ReceiptVoucher.tsx (حقل طريقة الدفع)
- client/src/components/DashboardLayout.tsx (رابط التدفق النقدي)
- client/src/App.tsx (مسار /cash-flow)
- server/cashFlow.test.ts (اختبارات)


## إصلاح مشكلة عدم ظهور سندات القبض في تقرير التدفق النقدي (29 يناير 2026)

### المشكلة
- [x] سندات القبض الموجودة لا تظهر في تقرير التدفق النقدي (بسبب فلتر status)

### التحليل
- [x] فحص البيانات في قاعدة البيانات - يوجد 4 سندات بحالة draft
- [x] فحص دالة getVouchersByPaymentMethod - تفلتر فقط approved/paid

### الإصلاح ✅
- [x] تعديل الفلتر ليشمل draft
- [x] إنشاء تقرير متقدم للسندات مع تفاصيل (المصاريف والسندات حسب طريقة الدفع)
- [x] اختبار الحل - يعمل بنجاح

### النتائج:
- إيرادات الكاش: 4,570.00 ر.س
- المصاريف النقدية: 5,915.75 ر.س (24 مصروف)
- سندات القبض النقدية: 1,404.00 ر.س (4 سندات)
- الكاش المتبقي: -2,749.75 ر.س


## إضافة قسم إشعارات انتهاء الوثائق في لوحة التحكم الرئيسية للمشرف (طلب جديد - 29 يناير 2026)

### 1. API وقاعدة البيانات
- [x] استخدام API getExpiringDocuments الموجود في portalAdmin router

### 2. مكون عرض الوثائق المنتهية
- [x] إضافة قسم "ملخص حالة وثائق الموظفين" في Dashboard
- [x] عرض الوثائق المنتهية والقريبة من الانتهاء مع عدد الأيام المتبقية
- [x] تصنيف حسب النوع (إقامات، شهادات صحية، عقود)

### 3. دمج في لوحة التحكم
- [x] إضافة القسم في AdminEmployeePortal Dashboard Tab
- [x] تصميم متجاوب للموبايل والويب (grid md:grid-cols-3)



## إصلاح مشكلة عدم ظهور صور الموظفين + إضافة صورة عبدالحي جلال (طلب جديد - 29 يناير 2026)

### 1. تحليل المشكلة
- [ ] فحص كيفية عرض صور الموظفين في الواجهة
- [ ] التحقق من وجود حقل الصورة في قاعدة البيانات
- [ ] فحص API جلب بيانات الموظفين

### 2. إضافة صورة عبدالحي جلال
- [ ] رفع الصورة إلى S3
- [ ] تحديث قاعدة البيانات بالصورة

### 3. إصلاح عرض الصور
- [ ] إصلاح عرض صور الموظفين في قائمة الموظفين
- [ ] إصلاح عرض صور الإثباتات (الهوية، الشهادة الصحية)



## إصلاح مشكلة عدم ظهور صور الموظفين وإثباتاتهم (طلب جديد - 29 يناير 2026)

### 1. تحليل المشكلة
- [x] فحص الكود وتحديد سبب عدم ظهور الصور
- [x] التأكد من وجود حقول الصور في schema (photoUrl, iqamaImageUrl, healthCertImageUrl, contractImageUrl)

### 2. رفع صورة عبدالحي جلال
- [x] رفع الصورة إلى S3
- [x] تحديث قاعدة البيانات للموظف EMP-004

### 3. إصلاح عرض الصور في الواجهة
- [x] إضافة حقول الصور إلى getEmployeesForPortalAdmin في db.ts
- [x] إصلاح عرض صورة الموظف في قائمة الموظفين
- [x] إصلاح عرض صورة الموظف في Dialog التفاصيل
- [x] إضافة عرض صور الوثائق (الإقامة، الشهادة الصحية، العقد) في Dialog



## تحسين أداء صفحة تعديل معلومات المشرف وإصلاح الصور (طلب جديد - 29 يناير 2026)

### 1. تحليل المشكلة
- [ ] فحص API getMyProfile وتحديد أسباب البطء
- [ ] فحص مشكلة عدم ظهور الصور في بوابة المشرفين (الصور موجودة في ملفات الموظفين)
- [ ] تحليل Data Flow لصفحة بياناتي

### 2. تحسين الأداء
- [ ] تحسين استعلامات قاعدة البيانات (تقليل الحقول غير الضرورية)
- [ ] إضافة caching للبيانات المتكررة
- [ ] تحسين تحميل الصور (lazy loading)

### 3. إصلاح الصور
- [ ] ربط صور المشرف من جدول employees بدلاً من جلبها منفصلة
- [ ] التأكد من إرجاع حقول الصور في API

### 4. إضافة شعار Symbol AI
- [ ] إضافة الشعار في بوابة المشرفين مثل باقي الصفحات



## تحسين أداء صفحة تعديل معلومات المشرف وإصلاح الصور (طلب جديد - 29 يناير 2026)

### 1. تحليل المشكلة
- [x] فحص APIs وتحديد أسباب البطء
- [x] التأكد من وجود حقول الصور في getEmployeesForPortalAdmin

### 2. تحسين APIs
- [x] إضافة حقل isSupervisor إلى getEmployeesForPortalAdmin
- [x] التأكد من إرجاع الصور (photoUrl, iqamaImageUrl, healthCertImageUrl, contractImageUrl)

### 3. تحسين الواجهة
- [x] إضافة شعار Symbol AI في أسفل الصفحة
- [x] إضافة Badge "مشرف" للموظفين المشرفين في قائمة الموظفين
- [x] إضافة زر العودة في Header


## تحسين شامل لنظام ERP (مكتمل - 29 يناير 2026)

### المرحلة 1: الفهم العميق - تحليل النظام الحالي
- [x] تحليل صفحة التدفق النقدي الحالية
- [x] تحليل قوالب البريد الإلكتروني
- [x] تحليل نظام الإشعارات
- [x] تحليل بوابة الموظفين

### المرحلة 2: تحسين صفحة التدفق النقدي
- [x] إضافة زر تصدير PDF احترافي
- [x] إنشاء قالب PDF مع شعار وختم وتوقيعات
- [x] إضافة API exportPdf في cashFlow router
- [x] إضافة مؤشرات الأداء المالي (KPIs)

### المرحلة 3: تحسين قوالب البريد الإلكتروني
- [x] تحسين الفوتر مع معلومات الشركة والمسؤولين
- [x] إضافة شعار Symbol AI والعنوان وأرقام التواصل
- [x] إضافة توقيعات المسؤولين (سالم الوادعي، عمر المطيري)

### المرحلة 4: أتمتة العمليات والتقارير الذكية
- [x] إنشاء خدمة smartReports.ts
- [x] تقارير أداء تلقائية (إيرادات، مصاريف، نمو)
- [x] كشف الشذوذ (انخفاض إيرادات، ارتفاع مصاريف)
- [x] تنبيهات ذكية للمهام المتأخرة

### المرحلة 5: تحسين بوابة الموظفين
- [x] إضافة شعار Symbol AI في الفوتر
- [x] تحسين الواجهة للموبايل


## إضافة السلف كمصاريف نقدية في التدفق النقدي (طلب جديد - 29 يناير 2026)

### 1. تحليل صفحة التدفق النقدي
- [ ] فهم كيفية احتساب المصاريف الحالية
- [ ] تحديد مكان إضافة السلف

### 2. تعديل الكود
- [ ] إضافة API لجلب السلف المعتمدة في الشهر المحدد
- [ ] تعديل صفحة التدفق النقدي لعرض السلف كمصاريف نقدية
- [ ] إضافة السلف في حسابات التدفق النقدي الصادر


## إضافة السلف كمصاريف نقدية في التدفق النقدي (مكتمل - 29 يناير 2026)

### 1. تعديل قاعدة البيانات
- [x] إضافة دالة getApprovedAdvancesForPeriod في db.ts
- [x] تعديل calculateBranchCashFlow لإضافة السلف
- [x] تعديل getMonthlyCashFlowReport لإضافة السلف في الإجماليات

### 2. تعديل الواجهة
- [x] إضافة بطاقة "السلف النقدية" في بطاقات الملخص
- [x] تعديل معادلة التدفق النقدي لإضافة السلف
- [x] تعديل grid لعرض 5 بطاقات

### 3. تعديل قالب PDF
- [x] إضافة totalCashAdvances إلى interface
- [x] إضافة بطاقة السلف في قالب PDF
- [x] إضافة CSS لبطاقة السلف (لون بنفسجي)


## إصلاح مشكلة طباعة PDF وتحسين قالب الوثائق (طلب جديد - 29 يناير 2026)

### 1. إصلاح طباعة PDF في التدفق النقدي
- [x] تغيير من Puppeteer إلى HTML مباشر للطباعة (cashFlowPdfService.ts)
- [x] إصلاح خطأ "Failed to launch the browser process" - يفتح HTML في نافذة جديدة
- [x] تحسين فتح النافذة للطباعة في CashFlowReport.tsx

### 2. تحسين قالب تقرير الوثائق
- [x] إصلاح النصوص العربية - إنشاء documentReportService.ts بقالب HTML بدلاً من jsPDF
- [x] تحسين التصميم والألوان - قالب احترافي بألوان Symbol AI
- [x] إضافة خط عربي واضح - خط Tajawal من Google Fonts
- [x] إضافة API exportDocumentsReport في routers.ts
- [x] تحديث DocumentsDashboard.tsx لاستخدام القالب الجديد


## إصلاح مشكلة تسجيل بيانات المشرف لنفسه (طلب جديد - 29 يناير 2026)

### المشكلة
- [ ] المشرف لا يستطيع تسجيل بياناته الشخصية

### الحل المطلوب
- [ ] تحليل صلاحيات المشرف الحالية
- [ ] السماح للمشرف بتعديل بياناته الشخصية فقط
- [ ] اختبار الإصلاح


## إصلاح تسجيل بيانات المشرفين (طلب جديد - 29 يناير 2026)

### المشكلة
- [ ] المشرفين لا يمكنهم تسجيل بياناتهم الشخصية (الإقامة، الشهادة الصحية، العقد)
- [ ] التحقق من أن المشرفين موجودين في جدول employees
- [ ] إصلاح الصلاحيات للسماح لهم بتسجيل بياناتهم


## إصلاح تسجيل بيانات المشرفين (طلب جديد - 29 يناير 2026)

- [x] تحليل مشكلة صلاحيات المشرفين لتسجيل بياناتهم
- [x] إصلاح كلمة مرور المشرف laban
- [x] تعديل API submitInfo لقبول التاريخ كـ string أو Date
- [x] اختبار تسجيل بيانات المشرف بنجاح
- [x] التحقق من حفظ البيانات في قاعدة البيانات


## إصلاح عدم ظهور خانات تعديل البيانات للمشرفين (طلب جديد - 29 يناير 2026)

- [x] تحليل سبب عدم ظهور خانات التعديل للمشرفين - المشرفين يتم توجيههم للوحة تحكم مختلفة
- [x] إضافة تبويب "ملفي" في AdminEmployeePortal.tsx
- [x] إضافة EmployeeProfile و EmployeeInfoForm للمشرفين
- [x] اختبار الإصلاح - المشرف يمكنه رؤية وتعديل بياناته الشخصية


## تحسينات معمارية لبوابة الموظفين (30 يناير 2026)

### 1. Shared Portal Core Module
- [ ] إنشاء client/src/lib/portal/constants.ts
- [ ] إنشاء client/src/lib/portal/types.ts
- [ ] إنشاء client/src/lib/portal/hooks/useEmployeeData.ts
- [ ] إنشاء client/src/lib/portal/hooks/useDocumentStatus.ts
- [ ] إنشاء client/src/lib/portal/hooks/useRequestManagement.ts
- [ ] إنشاء client/src/lib/portal/utils.ts
- [ ] إنشاء client/src/lib/portal/index.ts

### 2. Role-Aware Layout Component
- [ ] إنشاء client/src/components/portal/PortalLayout.tsx
- [ ] إنشاء client/src/components/portal/PortalHeader.tsx
- [ ] إنشاء client/src/components/portal/PortalNavigation.tsx
- [ ] إنشاء client/src/components/portal/DocumentStatusCard.tsx

### 3. Document Status Service (Backend)
- [ ] إنشاء server/services/documentStatusService.ts
- [ ] إضافة API endpoints للـ Document Status
- [ ] اختبار الخدمة



## تحسينات معمارية لبوابة الموظفين (30 يناير 2026)

### 1. Shared Portal Core Module ✅
- [x] إنشاء الثوابت المشتركة (constants.ts)
- [x] إنشاء الأنواع المشتركة (types.ts)
- [x] إنشاء الدوال المساعدة (utils.ts)
- [x] إنشاء hooks/useEmployeeData.ts
- [x] إنشاء hooks/useDocumentStatus.ts
- [x] إنشاء hooks/useRequestManagement.ts

### 2. Role-Aware Layout Component ✅
- [x] إنشاء PortalHeader.tsx
- [x] إنشاء PortalNavigation.tsx
- [x] إنشاء DocumentStatusCard.tsx

### 3. Document Status Service (Backend) ✅
- [x] إنشاء documentStatusService.ts
- [x] دوال تحليل حالة الوثائق
- [x] حساب نقاط صحة الوثائق (Health Score)
- [x] استخراج التذكيرات للوثائق المنتهية


## إصلاح خطأ تسجيل الدخول (طلب جديد - 30 يناير 2026)

- [x] تحليل مشكلة تسجيل الدخول - السبب: اختلاف عدد iterations في الـ hash (100000 بدلاً من 10000)
- [x] إعادة تعيين كلمة مرور Admin بالـ iterations الصحيحة (10000)
- [x] إعادة تعيين كلمات مرور جميع المشرفين
- [x] اختبار تسجيل الدخول - Admin و laban يعملان بنجاح


## تحسين بوابة الموظفين للمشرفين (طلب جديد - 30 يناير 2026)

- [ ] تحليل المشاكل الحالية في AdminEmployeePortal
- [ ] إصلاح عرض الموظفين للمشرف (يظهر "لا يوجد موظفين")
- [ ] إصلاح عرض الطلبات للمشرف (تحميل لا نهائي)
- [ ] تحسين تبويب ملفي للمشرف
- [ ] اختبار التحسينات


## فحص شامل لبوابة الموظفين واقتراح تحسينات متقدمة (30 يناير 2026)

- [ ] فحص شامل للبنية الحالية لبوابة الموظفين
- [ ] تحليل نقاط القوة والضعف
- [ ] إعداد تقرير شامل بالتحسينات المتقدمة
- [ ] تسليم التقرير للمستخدم


## نظام الإشعارات الداخلية لبوابة الموظفين (جرس الإشعارات) - 30 يناير 2026

### 1. Database Schema
- [x] إنشاء جدول portalNotifications
- [x] تعريف أنواع الإشعارات (11 نوع)
- [x] تعريف مستويات الأولوية (4 مستويات)

### 2. Backend APIs
- [x] إنشاء portalNotificationService.ts
- [x] إضافة APIs (getNotifications, getUnreadCount, markAsRead, markAllAsRead, deleteNotification)
- [x] إضافة دوال إنشاء الإشعارات التلقائية (notifyRequestApproved, notifyRequestRejected, notifyDocumentExpiring, etc.)
- [x] إضافة tRPC endpoints في routers.ts

### 3. Frontend Component
- [x] إنشاء NotificationBell.tsx مع عداد الإشعارات غير المقروءة
- [x] قائمة منسدلة لعرض الإشعارات
- [x] تحديث تلقائي كل 30 ثانية
- [x] أيقونات وألوان حسب نوع الإشعار

### 4. الدمج
- [x] دمج الجرس في EmployeePortal
- [x] دمج الجرس في AdminEmployeePortal
- [x] تحديث PortalHeader لدعم الإشعارات

### 5. الاختبارات
- [x] إنشاء portalNotifications.test.ts (26 اختبار)
- [x] جميع الاختبارات ناجحة (790 اختبار)


## إشعارات Push للمتصفح (Browser Push Notifications) - 30 يناير 2026

### 1. Service Worker
- [x] إنشاء sw-notifications.js للإشعارات
- [x] تسجيل Service Worker تلقائياً عند التحميل
- [x] دعم استقبال وعرض الإشعارات
- [x] معالجة النقر على الإشعارات

### 2. Frontend Hook
- [x] إنشاء usePushNotifications hook
- [x] طلب إذن المستخدم للإشعارات
- [x] حفظ حالة الإذن (default/granted/denied/unsupported)
- [x] دالة showNotification لإرسال الإشعارات

### 3. دمج مع NotificationBell
- [x] إضافة زر تفعيل الإشعارات مع Switch
- [x] عرض حالة الإشعارات في الإعدادات
- [x] إرسال Push تلقائي للإشعارات العاجلة (urgent/high)
- [x] شريط تفعيل سريع للمستخدمين الجدد
- [x] أيقونة BellRing عند تفعيل Push

### 4. الميزات
- [x] إشعارات عربية RTL
- [x] أنماط اهتزاز مختلفة حسب الأولوية
- [x] requireInteraction للإشعارات العاجلة
- [x] إرسال Push فقط عندما لا يكون المستخدم في البوابة

### 5. الاختبارات
- [x] إنشاء pushNotifications.test.ts (26 اختبار)
- [x] جميع الاختبارات ناجحة (811 اختبار إجمالي)
